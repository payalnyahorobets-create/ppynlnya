–î–∞—é —Ç–µ–±–µ –≤—Å–µ —á—Ç–æ –ø—Ä–∏—à–ª–æ –≤ –≥–æ–ª–æ–≤—É –ø–æ —Ñ–∞–π–ª—É –ê–Ω–∞–ª–∏–∑–∞. –¢–≤–æ–µ–π –∑–∞–¥–∞—á–µ–π –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ —á—Ç–æ —Ç—ã —Å–æ–∑–¥–∞–ª —Å —É—á–µ—Ç–æ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∫–æ—Ç–æ—Ä—É—é —è –¥–∞–º. –∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç - —Ä–∞–±–æ—á–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ª—É—á—à–µ —Ç–µ–∫—É—â–µ–π –≥—É–≥–ª —Ç–∞–±–ª–∏—Ü—ã —Å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞—é—â–∏–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏. —Å–∫—Ä–∏–ø—Ç—ã –º–æ–∂–µ—à—å –∫–∞–∫ —É—Ç–∏–ª–∏—Ç—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∏–ª–∏ –≤—Ä–æ–¥–µ —Ç–æ–≥–æ, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –º–æ–¥—É–ª—å–Ω—ã–º–∏. –û—Å—Ç–∞–ª—å–Ω–æ–µ –Ω–∞ —Ç–≤–æ–π –≤–∫—É—Å, –ª–∏—à—å –±—ã –±—ã–ª–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–ª–∏ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã. –ö–∞–∫–∏–µ-—Ç–æ –º–æ–∂–µ—à—å –æ–±—å–µ–¥–µ–Ω–∏—Ç—å, –µ—Å–ª–∏ —Å—á–∏—Ç–∞–µ—à—å —ç—Ç–æ –Ω—É–∂–Ω—ã–º. –ï—Å–ª–∏ —Å—á–∏—Ç–∞–µ—à—å –Ω—É–∂–Ω—ã–º —á—Ç–æ-—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å - –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π. –ú–Ω–µ –±–µ–∑ —Ä–∞–∑–Ω–∏—Ü—ã, –∫–∞–∫–∏–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ —Ç—ã –±—É–¥–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è, –≤—Å—ë –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞—Ç—å. –ï—Å–ª–∏ —É —Ç–µ–±—è –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ - –ø–æ—Å—Ç—É–ø–∞–π —Ç–∞–∫ –∫–∞–∫ –ø–æ—Å—Ç—É–ø–∏–ª –±—ã —á–µ–ª–æ–≤–µ–∫ - –∏–º–ø—Ä–æ–≤–∏–∑–∏—Ä—É–π –∏ —Å–æ–∑–¥–∞–≤–∞–π. 



–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –ê–Ω–∞–ª–∏–∑ NEW NOT FINAL
–õ–∏—Å—Ç –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞
–ê - –ê—Ä—Ç–∏–∫—É–ª
–í - –ö–æ–¥
–° - –Ü–º'—è
D - –ö–∞—Ç–µ–≥–æ—Ä—ñ—è
E - –¶—ñ–Ω–∞ –∑–∞–∫—É–ø—ñ–≤–ª—ñ
F - –¶—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É
G - –ö—ñ–ª—å–∫—ñ—Å—Ç—å
H - –®—Ç—Ä–∏—Ö–∫–æ–¥
–°—Ç–æ–ª–±–∏–∫–∏ A-H - –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–≥—Ä—É–∑–∫–∏, –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π –≤—ã–≥—Ä—É–∑–∫–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã —Ç–µ–º, —á—Ç–æ —É–±—Ä–∞–Ω—ã —Å—Ç–æ–ª–±–∏–∫–∏: ID; –£ —Ä–µ–∑–µ—Ä–≤—ñ - –¥–∞–Ω–Ω—ã–µ —Å—Ç–æ–ª–±–∏–∫–∏ —è–≤–ª—è—é—Ç—Å—è –º—É—Å–æ—Ä–Ω—ã–º–∏, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —ç—Ç–∏—Ö —Å—Ç–æ–ª–±–∏–∫–æ–≤ –±—ã–ª–æ –±—ã –æ—Ç–ª–∏—á–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã. –¢–∞–∫ –∂–µ –∏–∑ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã —É–±–∏—Ä–∞—é—Ç—Å—è –º—É—Å–æ—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ç–æ–≤–∞—Ä—ã –æ–¥–Ω–æ—Ä–∞–∑–∫–∏, –∏ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ –ø–æ–º–∏–º–æ –æ—á–∏—Å—Ç–∫–∏ –ø–æ–¥–¥–∞–µ—Ç—Å—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ –æ—Ç –ê –¥–æ –Ø –ø–æ D - –ö–∞—Ç–µ–≥–æ—Ä—ñ—è (–¥–µ—Ç–∞–ª–∏ –≤ gas —Å–∫—Ä–∏–ø—Ç–µ –æ—á–∏—Å—Ç–∫–∏)
I - ID –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó (=ARRAYFORMULA(
  IF(ROW(D:D)=1; "ID –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó";
    IF(D:D="";;
      LET(
        dirty_categories; D:D;
        cleaned_categories;
          TRIM(
            REGEXREPLACE(
              REGEXREPLACE(dirty_categories; "^[\\d\\.\\)]*\\s*"; ""); ":$"; ""));
        IFERROR(
          VLOOKUP(cleaned_categories; ID!A:B; 2; FALSE);
          "ID –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
        )
      )
    )
  )
)
)(—Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ D - –ö–∞—Ç–µ–≥–æ—Ä—ñ—è; –ª–∏—Å—Ç ID)
J - (=IFERROR(
  IF(
    COUNTIF( INDIRECT("'" & $D2 & "'!A:A"); $A2 ) > 0;
    "‚úÖ";           
    "‚ùå"               
  );
  "‚ü° –ª–∏—Å—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω"
)
)–ù–∞ –ª–∏—Å—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∫–æ—Ç–æ—Ä—ã–µ –∏–¥—É—Ç –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏–π –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö D - –ö–∞—Ç–µ–≥–æ—Ä—ñ—è), –∏–º–µ–µ—Ç –æ—Ç–º–µ—Ç–∫—É –≥–∞–ª–æ—á–∫–∞ –∏–ª–∏ –∫—Ä–µ—Å—Ç–∏–∫, –≥–¥–µ –≥–∞–ª–æ—á–∫–∞ - —Ç–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –ª–∏—Å—Ç —Å–≤–æ–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∫—Ä–µ—Å—Ç–∏–∫ - —Ç–æ–≤–∞—Ä –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –ª–∏—Å—Ç —Å–≤–æ–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
K - –ü–µ—Ä—à–∞_–ø—Ä–æ–¥–∞–∂ (=ARRAYFORMULA(
 IF( LEN(A2:A)=0 ; "" ;
     IFERROR(
       VLOOKUP(
         TO_TEXT( A2:A ) ;                                    
         { TO_TEXT( '–ü–µ—Ä—à—ñ_–ø—Ä–æ–¥–∞–∂—ñ'!$A$2:$A ) \               
           '–ü–µ—Ä—à—ñ_–ø—Ä–æ–¥–∞–∂—ñ'!$B$2:$B } ;                   
         2 ; FALSE
       ) ;
     "" )
 )
)
)(—Å–≤—è–∑–∞–Ω —Å –ª–∏—Å—Ç–æ–º –ü–µ—Ä—à—ñ_–ø—Ä–æ–¥–∞–∂—ñ, –∫—É–¥–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ –∞—Ä—Ç–∏–∫—É–ª–∞, –∏ –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é –¥–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏)
L - –î–∞—Ç–∞_–ø–æ–ª–∫–∏ (=ARRAYFORMULA(
  IF( LEN(A2:A)=0; "";
      IFERROR(
        VLOOKUP( A2:A ;
                 { ShelfDates!A:B } ;
                 2 ; FALSE ) ;
      "" ) ) )
) (—Å–≤—è–∑–∞–Ω —Å –ª–∏—Å—Ç–æ–º ShelfDates, –≥–¥–µ –≤ –ø–µ—Ä–≤–æ–º —Å—Ç–æ–ª–±–∏–∫–µ –∞—Ä—Ç–∏–∫—É–ª–∞ —Ç–æ–≤–∞—Ä–∞, –≤–æ –≤—Ç–æ—Ä–æ–º –¥–∞—Ç–∞ –∫–æ–≥–¥–∞ –æ–Ω–∏ –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–∞ –ø–æ–ª–∫–∞—Ö)
M - –í—ñ–∫, –¥–Ω—ñ–≤ (=IF(L2="";""; TODAY()-L2)) 
N - –î–Ω—ñ–≤ –¥–æ 1-—ó –ø—Ä–æ–¥–∞–∂—ñ (=IF( OR(L2="";K2="");""; K2-L2)) 
O - Aging-bucket (=IFS(M2="";""; M2<=30;"‚â§30"; M2<=90;"31-90"; M2<=180;"91-180"; TRUE;">180")) 
P - –°–¢ (—à—Ç) (=ARRAYFORMULA(
 IF(LEN(A2:A)=0; "";
   IFERROR(
     VLOOKUP(
       TO_TEXT(A2:A);
       { TO_TEXT('–ê–Ω–∞–ª—ñ–∑ ABC-XYZ'!A:A) \ '–ê–Ω–∞–ª—ñ–∑ ABC-XYZ'!AA:AA };
       2; FALSE
     );
   0 )
 )
)
)(—Å–≤—è–∑–∞–Ω —Å –ª–∏—Å—Ç–æ–º –ê–Ω–∞–ª—ñ–∑ ABC-XYZ, –±–µ—Ä–µ—Ç –æ—Ç—Ç—É–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å—Ä–µ–¥–Ω–µ-–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂ —Ç–æ–≤–∞—Ä–∞)
Q - –ó–∞–ø–∞—Å –≤ —Ç–∏–∂–Ω—è—Ö (=ARRAYFORMULA(
  IF(
    LEN(A2:A)=0; "";
    IF( (G2:G=0) + (P2:P=0); ""; G2:G / P2:P )
  )
)
)
R - Dead stock ‚ö†Ô∏è(=ARRAYFORMULA(
  IF(
    LEN(A2:A)=0; "";
    IF( (M2:M>180) * (K2:K=""); "‚ö†Ô∏è"; "" )
  )
)
)
S - –ê–∫—Ç–∏–≤–Ω—ñ_—Ç–∏–∂–Ω—ñ (=ARRAYFORMULA(
  IF(
    LEN(A2:A)=0; "";
    LET(
      endDate; IF(K2:K=""; TODAY(); K2:K);
      weeks;   ROUND((endDate - L2:L) / 7; 0);
      IF(weeks < 1; 1; weeks)
    )
  )
))
–ù–∞—á–∏–Ω–∞–µ–º –æ–ø–∏—Å—å –¥—Ä—É–≥–æ–≥–æ –ª–∏—Å—Ç–∞.
–õ–∏—Å—Ç –ê–Ω–∞–ª—ñ–∑ ABC-XYZ
–ù–∞—á–∞–ª–æ –ª–∏—Å—Ç–∞ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—É
–ê - –ê—Ä—Ç–∏–∫—É–ª
–í - –ö–æ–¥
–° - –Ü–º'—è
D - –ö–∞—Ç–µ–≥–æ—Ä—ñ—è
E - –¶—ñ–Ω–∞ –∑–∞–∫—É–ø—ñ–≤–ª—ñ
F - –¶—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É
G - –ö—ñ–ª—å–∫—ñ—Å—Ç—å
H - –®—Ç—Ä–∏—Ö–∫–æ–¥
I - ID –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó (—Ñ–æ—Ä–º—É–ª–∞ –∏–∑–≤–µ—Å—Ç–Ω–∞)
J - ABC (–≤) =IFS(AF2<=0,8;"A";AF2<=0,95;"B";TRUE;"C")
K - ABC (–º) =IFS(AI2<=0,8;"A(–º)";AI2<=0,95;"B(–º)";TRUE;"C(–º)")
L - ABC (–∫) =IFS(AL2<=0,8;"A(–∫)";AL2<=0,95;"B(–∫)";TRUE;"C(–∫)")
M - XYZ =IFS(AA2=0;"Z";AC2<=0,35;"X";AC2<=0,7;"Y";AC2>0,7;"Z")
N - ABC(–º)-XYZ =K2&M2
O - ABC(–≤)-XYZ =J2&M2
P - –û–±–æ—Ä–æ—Ç–Ω—ñ—Å—Ç—å (—à—Ç.) =IF(G2=0;0;Y2/G2)
Q - –û–±–æ—Ä–æ—Ç–Ω—ñ—Å—Ç—å –∑–∞–ø–∞—Å—É (–∫–ª–∞—Å.) =IFERROR( (E2 * Y2) / (((G2 + G2 + Y2) / 2) * E2); 0 )
R - GMROI =IFERROR( ((F2 - E2) * Y2) / (((G2 + G2 + Y2) / 2) * E2); 0 )
S - –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å =IF(F2=0;0;(F2-E2)/F2)
T - –ù–∞—Ü—ñ–Ω–∫–∞ =IF(E2=0;0;(F2-E2)/E2)
U - –ö–æ—ç—Ñ. —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏ =IFERROR(STDEV.S({FF2;FH2;FJ2;FL2;FN2;FP2;FR2;FT2;FV2;FX2}) / AVERAGE({FF2;FH2;FJ2;FL2;FN2;FP2;FR2;FT2;FV2;FX2}); 0)
V - –î–∏–Ω–∞–º—ñ–∫–∞ (12 –º—ñ—Å.) =SPARKLINE({FD2;FF2;FJ2;FL2;FN2;FP2;FR2;FT2;FV2;FX2;FZ2;GB2}; {"charttype"\"line";"linewidth"\2;"color"\"#1ec732"})
W - –í–∞—Ä—Ç—ñ—Å—Ç—å –ó–∞–ø–∞—Å—É =G2*E2
X - –í–∏—Ç–æ—Ä–≥ =SUM(EG2;EI2;EK2;EM2;EO2;EQ2;ES2;EU2;EW2;EY2;FA2;FC2;FE2;FG2;FI2;FK2;FM2;FO2;FQ2;FS2;FU2;FW2;FY2;GA2)
Y - –ö—ñ–ª—å–∫—ñ—Å—Ç—å(—à—Ç) =SUM(EF2;EH2;EJ2;EL2;EN2;EP2;ER2;ET2;EV2;EX2;EZ2;FB2;FD2;FF2;FH2;FJ2;FL2;FN2;FP2;FR2;FT2;FV2;FX2;FZ2)
Z - –ú–∞—Ä–∂–∞ =(F2-E2)*Y2
AA - –°–¢ (—à—Ç) =ROUND((EF2+EH2+EJ2+EL2+EN2+EP2+ER2+ET2+EV2+EX2+EZ2+FB2+FD2+FF2+FH2+FJ2+FL2+FN2+FP2+FR2+FT2+FV2+FX2+FZ2)/104; 2)
AB - CV (%)–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è (—à—Ç =IFERROR(STDEV.S(EF2;EH2;EJ2;EL2;EN2;EP2;ER2;ET2;EV2;EX2;EZ2;FB2;FD2;FF2;FH2;FJ2;FL2;FN2;FP2;FR2); 0)
AC - CV (%) =IFERROR(STDEV.S(EF2;EH2;EJ2;EL2;EN2;EP2;ER2;ET2;EV2;EX2;EZ2;FB2;FD2;FF2;FH2;FJ2;FL2;FN2;FP2;FR2;FT2;FV2); 0)
AD - –î–æ–ª—è –í–∏—Ç–æ—Ä–≥—É (%) =IF($DA$1=0;0;X2/$DA$1)
AE - –†–∞–Ω–≥ (–í–∏—Ç–æ—Ä–≥) =RANK.EQ(X2;X:X;0)
AF - –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ –ù–∞–∫–æ–ø. –î–æ–ª—è (%) (–≤) =SUMIF($AE:$AE;"<="&AE2;$AD:$AD)
AG - –î–æ–ª—è –ú–∞—Ä–∂—ñ (%) =IF($DA$2=0;0;Z2/$DA$2)
AH - –†–∞–Ω–≥ (–ú–∞—Ä–∂–∞) =RANK.EQ(Z2;Z:Z;0)
AI - –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ –ù–∞–∫–æ–ø. –î–æ–ª—è (%) (–º) =SUMIF($AH:$AH;"<="&AH2;$AG:$AG)
AJ - –î–æ–ª—è –ö—ñ–ª—å–∫—ñ—Å—Ç—ñ (%) =IF($CX$3=0;0;Y2/$CX$3)
AK - –†–∞–Ω–≥ (–ö—ñ–ª—å–∫—ñ—Å—Ç—å) =RANK.EQ(Y2;Y:Y;0)
AL - –†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ –ù–∞–∫–æ–ø. –î–æ–ª—è (%) (–∫) =SUMIF($AK:$AK;"<="&AK2;$AJ:$AJ)
AM - –ó–∞–ø–∞—Å —É —Ç–∏–∂–Ω—è—Ö –∑–∞ 12–º =IF(OR($G2=0; SUM(FR2;FT2;FV2;FX2;FZ2;GB2;GD2;GF2;GH2;GJ2;GL2;GN2)=0); ""; $G2 / ((SUM(FR2;FT2;FV2;FX2;FZ2;GB2;GD2;GF2;GH2;GJ2;GL2;GN2)) / 52))
AN - –ó–∞–ø–∞—Å —É —Ç–∏–∂–Ω—è—Ö –∑–∞ 24–º =IF(OR($G2=0; SUM(EF2;EH2;EJ2;EL2;EN2;EP2;ER2;ET2;EV2;EX2;EZ2;FB2;FD2;FF2;FH2;FJ2;FL2;FN2;FP2;FR2;FT2;FV2;FX2;FZ2)=0); ""; $G2 / ((SUM(EF2;EH2;EJ2;EL2;EN2;EP2;ER2;ET2;EV2;EX2;EZ2;FB2;FD2;FF2;FH2;FJ2;FL2;FN2;FP2;FR2;FT2;FV2;FX2;FZ2)) / 104))
AO - –ü–æ–∫—Ä–∏—Ç—Ç—è –∑–∞–ø–∞—Å–æ–º —É –¥–Ω—è—Ö =IF(AN2=""; ""; AN2 * 7)
AP - –†—ñ–≤–µ–Ω—å —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó =IFERROR( Y2 / (Y2 + G2); 0 )
AQ - –°–µ—Ä–µ–¥–Ω—è —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –ø–µ—Ä–µ–±—É–≤–∞–Ω–Ω—è =IFERROR( TODAY() - VLOOKUP($A2; ShelfDates!$A:$B; 2; FALSE); "" )
AR - –ß–∞—Å—Ç–∫–∞ —É –≤–∏—Ä—É—á—Ü—ñ =IFERROR( X2 / $DA$1; 0 )
AS - –ß–∞—Å—Ç–∫–∞ —É –º–∞—Ä–∂—ñ =IFERROR( Z2 / $DA$2; 0 )
AT - –°–µ—Ä–µ–¥–Ω—è —Ü—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É (–≥—Ä–Ω/—à—Ç) =IFERROR( X2 / Y2 ; 0 )
AU - –ß–∞—Å—Ç–∫–∞ –ø—Ä–æ–¥–∞–∂ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó =IFERROR( 
  –í–∏—Ç–æ—Ä–≥_—Ç–æ–≤–∞—Ä—É / SUMIF(–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:–ö–∞—Ç–µ–≥–æ—Ä—ñ—è ; D2 ; –í–∏—Ç–æ—Ä–≥:–í–∏—Ç–æ—Ä–≥) ; 
  0
)
AV - –ß–∞—Å—Ç–∫–∞ –ø—Ä–æ–¥–∞–∂ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó =IFERROR(
  $X2 / SUMIF($D:$D; $D2; $X:$X);
  0
)

AW - –†–æ—Å—Ç / –ø–∞–¥—ñ–Ω–Ω—è –ø—Ä–æ–¥–∞–∂—ñ–≤ =IFERROR((SUM(FR2;FT2;FV2;FX2;FZ2;GB2) - SUM(FJ2;FL2;FN2;FP2;FR2;FT2)) / SUM(FJ2;FL2;FN2;FP2;FR2;FT2); 0)
AX - –°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ =IFERROR(AVERAGE(FT2;FV2;FX2); 0)
AY - –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ =IFERROR(0,5 * FT2 + 0,3 * FV2 + 0,2 * FX2; 0)
AZ -–õ–∏–Ω–µ–π–Ω—ã–π —Ç—Ä–µ–Ω–¥ =IFERROR(FORECAST.LINEAR(4; {FT2; FV2; FX2}; {1; 2; 3}); AVERAGE(FT2; FV2; FX2))
BJ1 - =SUM(X:X)
BJ2 - =SUMIF(Z:Z; ">0")
BJ3 - =SUM(Y:Y)
EF, EH, EJ... - FX, FZ, GB - =IFNA(SUMIFS('–°—ñ—á–µ–Ω—å 2026'!B:B; '–°—ñ—á–µ–Ω—å 2026'!E:E; $A2); 0)
EG,EI,EK... - FY,GA,GC - =IFNA(SUMIFS('–°—ñ—á–µ–Ω—å 2026'!C:C; '–°—ñ—á–µ–Ω—å 2026'!E:E; $A2); 0)
–ö–∞–∫ –≤–∏–¥–∏—à—å, —Ñ–æ—Ä–º—É–ª—ã –¥–ª—è –ü—Ä–æ–¥–∞–Ω–æ *–º–µ—Å—è—Ü* –∏ –í–∏—Ç–æ—Ä–≥ *–º–µ—Å—è—Ü* –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Å—Ç–æ–ª–±–∏–∫–æ–≤, –º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ (–º–µ—Å—è—Ü–∞) —Å –∫–æ—Ç–æ—Ä–æ–≥–æ –±–µ—Ä—É—Ç—Å—è –¥–∞–Ω–Ω—ã–µ
–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –¥—Ä—É–≥–∏–º –ª–∏—Å—Ç–∞–º.
–õ–∏—Å—Ç –ö–∞—Ç–õ–∏—Å—Ç–∏
–°—Ç–æ–ª–±–∏–∫ –ê - –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤ –Ω–∞—à–µ–π –°–†–ú, –ª–∏—Å—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π
–õ–∏—Å—Ç –ß. –ù.
–°—é–¥–∞ —è –∑–∞–ª–∏–≤–∞—é –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—É (—á–∏—Å—Ç–∫–∞ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã) –∏ —Å–∫—Ä–∏–ø—Ç —É–¥–∞–ª—è–µ—Ç –ª–∏—à–Ω–∏–µ —Ç–æ–≤–∞—Ä—ã –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É –∏ –ª–∏—à–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
–õ–∏—Å—Ç –ß.–ü.
–°—é–¥–∞ —è –∑–∞–ª–∏–≤–∞—é –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã (—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–¥–∞–∂) –∏ —Å–∫—Ä–∏–ø—Ç —É–¥–∞–ª—è–µ—Ç –ª–∏—à–Ω–∏–µ —Ç–æ–≤–∞—Ä—ã (–¥–µ—Ç–∞–ª–∏, –æ—Å–Ω–æ–≤–Ω—É—é —Ç–µ—Ö–Ω–∏–∫—É) –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –ø–æ–¥ –º–æ–∏–º –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –∏ –≤ –º–æ–µ–π —é—Ä–∏—Å–¥–∏–∫—Ü–∏–∏
–õ–∏—Å—Ç ID
A1 - –®–∞–ø–∫–∞ –ö–∞—Ç–µ–≥–æ—Ä—ñ—è
B1 - –®–∞–ø–∫–∞ ID
–ü–æ–¥ –Ω–∏–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –∏—Ö ID, –ª–∏—Å—Ç —Å–ª—É–∂–∏—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Ñ–æ—Ä–º—É–ª—ã –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–∞, —Ç.–∫. –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ –∏–∑ –°–†–ú –∫–∞—Ç–µ–≥–æ—Ä–∏—è –≤—ã–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ –±—É–∫–≤–µ–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, –∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ –°–†–ú —Ç—Ä–µ–±—É–µ—Ç —Ü–∏—Ñ—Ä–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, –±—É–∫–≤–µ–Ω–Ω—ã–π —è –∏–º–µ—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —Ü–∏—Ñ—Ä–æ–≤–æ–π –º–Ω–µ –¥–∞–µ—Ç —Ñ–æ—Ä–º—É–ª–∞.
–õ–∏—Å—Ç –ü–µ—Ä—à—ñ_–ø—Ä–æ–¥–∞–∂—ñ
A1 - SKU (–Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ –º–µ—Å—è—Ü—ã, –º–æ–∂–µ—à—å –≥–ª—è–Ω—É—Ç—å –ø–æ —Ñ–æ—Ä–º—É–ª–µ) =QUERY(
 {
   FILTER('–°—ñ—á–µ–Ω—å 2024'!E3:F; '–°—ñ—á–µ–Ω—å 2024'!E3:E<>"");
   FILTER('–õ—é—Ç–∏–π 2024'!E3:F; '–õ—é—Ç–∏–π 2024'!E3:E<>"");
   FILTER('–ë–µ—Ä–µ–∑–µ–Ω—å 2024'!E3:F; '–ë–µ—Ä–µ–∑–µ–Ω—å 2024'!E3:E<>"");
   FILTER('–ö–≤—ñ—Ç–µ–Ω—å 2024'!E3:F; '–ö–≤—ñ—Ç–µ–Ω—å 2024'!E3:E<>"");
   FILTER('–¢—Ä–∞–≤–µ–Ω—å 2024'!E3:F; '–¢—Ä–∞–≤–µ–Ω—å 2024'!E3:E<>"");
   FILTER('–ß–µ—Ä–≤–µ–Ω—å 2024'!E3:F; '–ß–µ—Ä–≤–µ–Ω—å 2024'!E3:E<>"");
   FILTER('–õ–∏–ø–µ–Ω—å 2024'!E3:F; '–õ–∏–ø–µ–Ω—å 2024'!E3:E<>"");
   FILTER('–°–µ—Ä–ø–µ–Ω—å 2024'!E3:F; '–°–µ—Ä–ø–µ–Ω—å 2024'!E3:E<>"");
   FILTER('–í–µ—Ä–µ—Å–µ–Ω—å 2024'!E3:F; '–í–µ—Ä–µ—Å–µ–Ω—å 2024'!E3:E<>"");
   FILTER('–ñ–æ–≤—Ç–µ–Ω—å 2024'!E3:F; '–ñ–æ–≤—Ç–µ–Ω—å 2024'!E3:E<>"");
   FILTER('–õ–∏—Å—Ç–æ–ø–∞–¥ 2024'!E3:F; '–õ–∏—Å—Ç–æ–ø–∞–¥ 2024'!E3:E<>"");
   FILTER('–ì—Ä—É–¥–µ–Ω—å 2024'!E3:F; '–ì—Ä—É–¥–µ–Ω—å 2024'!E3:E<>"");
   FILTER('–°—ñ—á–µ–Ω—å 2025'!E3:F; '–°—ñ—á–µ–Ω—å 2025'!E3:E<>"");
   FILTER('–õ—é—Ç–∏–π 2025'!E3:F; '–õ—é—Ç–∏–π 2025'!E3:E<>"");
   FILTER('–ë–µ—Ä–µ–∑–µ–Ω—å 2025'!E3:F; '–ë–µ—Ä–µ–∑–µ–Ω—å 2025'!E3:E<>"");
   FILTER('–ö–≤—ñ—Ç–µ–Ω—å 2025'!E3:F; '–ö–≤—ñ—Ç–µ–Ω—å 2025'!E3:E<>"");
   FILTER('–¢—Ä–∞–≤–µ–Ω—å 2025'!E3:F; '–¢—Ä–∞–≤–µ–Ω—å 2025'!E3:E<>"");
   FILTER('–ß–µ—Ä–≤–µ–Ω—å 2025'!E3:F; '–ß–µ—Ä–≤–µ–Ω—å 2025'!E3:E<>"");
   FILTER('–õ–∏–ø–µ–Ω—å 2025'!E3:F; '–õ–∏–ø–µ–Ω—å 2025'!E3:E<>"");
   FILTER('–°–µ—Ä–ø–µ–Ω—å 2025'!E3:F; '–°–µ—Ä–ø–µ–Ω—å 2025'!E3:E<>"");
   FILTER('–í–µ—Ä–µ—Å–µ–Ω—å 2025'!E3:F; '–í–µ—Ä–µ—Å–µ–Ω—å 2025'!E3:E<>"");
   FILTER('–ñ–æ–≤—Ç–µ–Ω—å 2025'!E3:F; '–ñ–æ–≤—Ç–µ–Ω—å 2025'!E3:E<>"");
   FILTER('–õ–∏—Å—Ç–æ–ø–∞–¥ 2025'!E3:F; '–õ–∏—Å—Ç–æ–ø–∞–¥ 2025'!E3:E<>"");
   FILTER('–ì—Ä—É–¥–µ–Ω—å 2025'!E3:F; '–ì—Ä—É–¥–µ–Ω—å 2025'!E3:E<>"")
 };
 "select Col1, min(Col2)
  where Col1 is not null
  group by Col1
  label Col1 'SKU', min(Col2) '–ü–µ—Ä—à–∞_–ø—Ä–æ–¥–∞–∂'";
 0
)
)
B1 - –ü–µ—Ä—à–∞_–ø—Ä–æ–¥–∞–∂
–ü–æ–¥ SKU –∏–¥—É—Ç –ê—Ä—Ç–∏–∫—É–ª–∞ —Ç–æ–≤–∞—Ä–∞
–ü–æ–¥ –ü–µ—Ä—à–∞_–ø—Ä–æ–¥–∞–∂ –∏–¥—É—Ç –¥–∞—Ç—ã –∫–æ–≥–¥–∞ —Ç–æ–≤–∞—Ä –≤–ø–µ—Ä–≤—ã–µ –Ω–∞—á–∞–ª —Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ –ø—Ä–æ–¥–∞–Ω–Ω—ã–π –≤ –°–†–ú (–≤–∞–∂–Ω–æ!–ø—Ä–æ—Å—Ç–∞–≤–ª—è–ª –≤—Ä—É—á–Ω—É—é)
–õ–∏—Å—Ç ShelfDates
A - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—â–∏–µ—Å—è –∞—Ä—Ç–∏–∫—É–ª–∞ =SORT( UNIQUE( FILTER( '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'!A2:A ; LEN('–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'!A2:A) ) ) )
B - –≤—Ä—É—á–Ω—É—é –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–∞—è –¥–∞—Ç–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–∫–ª–∞–¥–µ
–õ–∏—Å—Ç —Ç–∞–∫ –∂–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π, —Å–ª—É–∂–∏—Ç –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–≥–¥–∞ —Ç–æ–≤–∞—Ä –ø–æ—è–≤–∏–ª—Å—è –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤–æ–π –ø—Ä–æ–¥–∞–∂–µ–π.
–õ–∏—Å—Ç –ü—ñ–¥—Å—É–º–∫–∏_–º—ñ—Å—è—Ü—ñ–≤
–ù–∞ —ç—Ç–æ–º –ª–∏—Å—Ç–µ –∫—Ä–∞—Ç–∫–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞ –∫–ª—é—á–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º:
–ê - –î–∞—Ç–∞
B - –ê—Ä–∫—É—à
C - –ö-—Å—Ç—å (–≤—Å—ñ)
D - –í–∏—Ç–æ—Ä–≥ (–≤—Å—ñ)
E - –ú–∞—Ä–∂–∞ (–≤—Å—ñ)
F - –ö-—Å—Ç—å –®–µ–≤—á
G - –í–∏—Ç–æ—Ä–≥ –®–µ–≤—á
H - –ú–∞—Ä–∂–∞ –®–µ–≤—á
I - –ö-—Å—Ç—å –ù–∞–≥–æ—Ä
J - –í–∏—Ç–æ—Ä–≥ –ù–∞–≥–æ—Ä
K - –ú–∞—Ä–∂–∞ –ù–∞–≥–æ—Ä
L - –ö-—Å—Ç—å –ê–ø–ø–æ–ª–æ
M - –í–∏—Ç–æ—Ä–≥ –ê–ø–ø–æ–ª–æ
N - –ú–∞—Ä–∂–∞ –ê–ø–ø–æ–ª–æ
O - –ö-—Å—Ç—å –ì–æ—Ä–æ–¥–æ–∫
P - –í–∏—Ç–æ—Ä–≥ –ì–æ—Ä–æ–¥–æ–∫
Q - –ú–∞—Ä–∂–∞ –ì–æ—Ä–æ–¥–æ–∫
R - –ö-—Å—Ç—å –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç
S - –í–∏—Ç–æ—Ä–≥ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç
T - –ú–∞—Ä–∂–∞ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç
U - % –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
V - –°—Ä. —Ü–µ–Ω–∞ —à—Ç
W - –ß–∏—Å—Ç—ã–π –±–µ–∑ –º–æ–µ–≥–æ
X - –ß–∏—Å—Ç—ã–π —Å –º–æ–∏–º
(–º–Ω–µ –≤ –∑–∞—Ä–ø–ª–∞—Ç—É –∏–¥–µ—Ç 1.5% –æ—Ç –º–µ—Å—è—á–Ω–æ–≥–æ –≤–∏—Ç–æ—Ä–≥–∞, —Å–æ–æ—Ç–≤–µ—Å—Ç–≤–µ–Ω–Ω–æ, –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç–æ–ª–±–∏–∫ - –ß–∏—Å—Ç—ã–π —Å –º–æ–∏–º; —ç—Ç–æ—Ç —Å—Ç–æ–ª–±–∏–∫ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç +- —Ä–µ–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ—Å–ª–µ –ø—Ä–æ–¥–∞–∂)
–õ–∏—Å—Ç –°–ª–µ–ø–∫–∏
–°–ª—É–∂–∏—Ç –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–º –ª–∏—Å—Ç–æ–º –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±—Ä–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥, –ø–æ –±–æ–ª—å—à–µ–º—É —Å—á–µ—Ç—É —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ª–∏—Å—Ç
–õ–∏—Å—Ç –î–∞—à–±–æ—Ä–¥11 - –Ω–µ–∫–∏–π –¥–∞—à–±–æ—Ä–¥, –≥–¥–µ —è –≤–∏–∂—É —Ç–æ–ø –ø–æ–∑–∏—Ü–∏–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, —Ç–∞–∫ –∂–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –∫–æ—Ç–æ—Ä—ã–µ —è –≤–µ–¥—É, –ø–µ—Ä–∏–æ–¥—ã, –∏ –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –î–∞–Ω–Ω—ã–µ –Ω–∞ –ª–∏—Å—Ç–µ —Å—Ç–∞—Ç–∏—á–Ω—ã–µ, —É–≤–∏–¥–∏—à—å —Å–∞–º. –§–æ—Ä–º—É–ª —Ç—É—Ç –Ω–µ—Ç, –ø–æ–¥—Å—á–µ—Ç—ã –≤—ã–ø–æ–ª–Ω—è–µ—Ç gas —Å–∫—Ä–∏–ø—Ç.
–õ–∏—Å—Ç –ú–∞–ø–ø–∏–Ω–≥ - —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∑–∞–∫—É–ø–æ–∫, —á—Ç–æ–±—ã –ø–æ –ú–æ–¥–µ–ª—å –∏–ª–∏ ID –∏ –ü–æ—Å—Ç–∞–≤—â–∏–∫ —Å–≤–æ–¥–∏—Ç—å –Ω–∞—à –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç —Å –ø—Ä–∞–π—Å–æ–º –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞. –ú–∞–ø–ø–∏–Ω–≥ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç gas —Å–∫—Ä–∏–ø—Ç. 
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–∏—Å—Ç–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:
–õ–∏—Å—Ç—ã –ø–æ —Ç–∏–ø—É: Apple (–ü–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏ Apple); –Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ —Ç–∞ –≥–µ–π–º—ñ–Ω–≥; –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ —Ç–∞ –∫–æ–º–ø º—é—Ç–µ—Ä–Ω—ñ –º–∏—à—ñ –∏ —Ç–æ–º—É –ø–æ–¥–æ–±–Ω—ã–µ. 100% —Å–ª—É—á–∞–µ–≤ —ç—Ç–∏ –ª–∏—Å—Ç—ã - –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ç–æ–≤–∞—Ä–æ–≤.
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–∫–∏—Ö –ª–∏—Å—Ç–æ–≤ –ø–æ–¥–æ–±–Ω–∞—è:
A-H –∏–∑–≤–µ—Å—Ç–Ω–∞—è –Ω–∞–º –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞, –∫–æ—Ç–æ—Ä–∞—è —Ñ–æ—Ä–º—É–ª–æ–π –Ω–∞—Ö–æ–¥—è—â–µ–π—Å—è –≤ B (=ARRAYFORMULA(
  IF(
    LEN(A2:A)=0 ;
    "" ;
    IFERROR(
      VLOOKUP(
        TO_TEXT(A2:A) ;
        { TO_TEXT('–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'!A:A) \ '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'!B:H } ;
        {2\3\4\5\6\7\8} ;
        FALSE
      ) ;
      "‚ùå"
    )
  )
)
) –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –Ω–∞ –ª–∏—Å—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–Ω—Ñ–æ –ø–æ —Ç–æ–≤–∞—Ä—É.
–°–∏–Ω–∏–º —Ü–≤–µ—Ç–æ–º –≤—ã–¥–µ–ª–µ–Ω—ã —Å—Ç–æ–ª–±–∏–∫–∏ –æ—Ç–≤–µ—á–∞—é—â–∏–µ –∑–∞ –∞—Ç—Ä–∏–±—É—Ç—ã: —Ü–≤–µ—Ç, –±—Ä–µ–Ω–¥, —Ä–∞–∑–º–µ—Ä, —Ç–∏–ø, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –ø–∏—Ç–∞–Ω–∏–µ –∏ –ø—Ä–æ—á–µ–µ; –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –º–Ω–æ–≥–æ, –æ–Ω–∏ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è, –Ω–æ —Ä–∞–∑–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –≤–∞–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –≤—Å–µ.
–ö—Ä–∞—Å–Ω—ã–º —Ü–≤–µ—Ç–æ–º –≤—ã–¥–µ–ª–µ–Ω—ã —Å—Ç–æ–ª–±–∏–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –Ω–∞ –≤—Å–µ—Ö –ª–∏—Å—Ç–∞—Ö - 
–†–µ–º–æ–Ω—Ç - –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é, –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –∫ –∫–∞–∫–æ–º—É —Ç–∏–ø—É —Ä–µ–º–æ–Ω—Ç–∞ –º–æ–∂–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç–æ–≤–∞—Ä
–î–æ —á–æ–≥–æ - –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é, –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –∫ –∫–∞–∫–æ–º—É —Ç–∏–ø—É —Ç–µ—Ö–Ω–∏–∫–∏ –º–æ–∂–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç–æ–≤–∞—Ä	
–ù–∞–¥–º–∞—Ä–∂–∞ - —Ñ–æ—Ä–º—É–ª–∞ –≤—ã—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–∞—Ä–∂—É –¥–ª—è –ø—Ä–æ—Å—á–µ—Ç–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —Ö2 —Å—Ç–∞–≤–∫–∏ –∑–∞ –ø—Ä–æ–¥–∞–∂—É –º–µ–Ω–µ–¥–∂–µ—Ä—É
–°—Ç–∞–≤–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ - —Ö2 –µ—Å–ª–∏ –ù–∞–¥–º–∞—Ä–∂–∞ –≤—ã—à–µ 700 –≥—Ä–Ω
–ó–µ–ª–µ–Ω—ã–º —Ü–≤–µ—Ç–æ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ –Ω–∞ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π–Ω—ã—Ö –ª–∏—Å—Ç–∞—Ö —Å—Ç–æ–ª–±–∏–∫–∏:
–ú–æ–¥–µ–ª—å - –º–æ–¥–µ–ª—å –ø–æ —Å–∏—Å—Ç–µ–º–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
ID - –∞–π–¥–∏ –ø–æ —Å–∏—Å—Ç–µ–º–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ - –∫—Ç–æ –ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–≤–∞—Ä
–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–æ–≤–∞—Ä - —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä –≤ B2B –∫–∞–±–∏–Ω–µ—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
–ó–æ–ª–æ—Ç—ã–º\–æ—Ä–∞–Ω–∂–µ–≤—ã–º –≤—ã–¥–µ–ª–µ–Ω—ã —Å—Ç–æ–ª–±–∏–∫–∏ –æ—Ç–≤–µ—á–∞—é—â–∏–µ –∑–∞ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∞–π—Ç (–≤–∞–∂–Ω–æ!)
–û–ø–∏—Å - –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞, –≤—Å–µ–≥–¥–∞ UA —è–∑—ã–∫–æ–º
–§–æ—Ç–æ –¥–ª—è –∫–∞—Ä—Ç–∫–∏	- —Ñ–æ—Ç–æ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞
–§–æ—Ç–æ –¥–ª—è –æ–ø–∏—Å—É	 - —Ñ–æ—Ç–æ –≤ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
–ù–∞–∑–≤–∞ –Ω–∞ —Å–∞–π—Ç—ñ	- –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ —Å–∞–π—Ç (–º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –°–†–ú)
–ö–∞—Ç–µ–≥–æ—Ä—ñ—è —Å–∞–π—Ç–∞	- –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å–∞–π—Ç–∞ –∫—É–¥–∞ –ø—É–±–ª–∏–∫—É–µ–º (–º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –°–†–ú)
–ö–∞—Ç–µ–≥–æ—Ä—ñ—è –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞	- –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
–ì–∞—Ä–∞–Ω—Ç—ñ—è - –∫–∞–∫–æ–π –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Å—Ä–æ–∫	
–í–∏—Ä–æ–±–Ω–∏–∫ - —Å—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å
–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü—ñ—è - –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–∞
–ù–∞ –º–∞–≥–∞–∑–∏–Ω—ñ - –¢–∞–∫; –ù—ñ - –µ—Å–ª–∏ –±–æ–ª—å—à–µ 1 —à—Ç –≤ –Ω–∞–ª–∏—á–∏–∏ —Å—Ç–æ–∏—Ç –¢–∞–∫; —É–∂–µ –∑–∞–±—ã–ª –¥–ª—è —á–µ–≥–æ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ—Å—å. –í–∏–¥–∏–º–æ –¥–ª—è XML –æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∞–π—Ç–µ
–ì—Ä—É–ø–∞ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ - —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ—Å—å –∫–∞–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ, –Ω–æ –∏–º–µ–µ—Ç –æ–±—â–µ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–¥—è, –∏–ª–∏ –≤ –º–æ–¥–µ–ª–∏ –æ—Ç–ª–∏—á–∏–µ —Ç–æ–ª—å–∫–æ –≤ —Ü–≤–µ—Ç–µ. –ù–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø–æ–∫–∞ —á—Ç–æ —Ç.–∫. –∫–æ–Ω—Ü–µ–ø—Ü–∏—è –Ω–µ –ø—Ä–∏–¥—É–º–∞–Ω–∞	
–î–∂–µ—Ä–µ–ª–æ –¥–∞–Ω–∏—Ö - –æ—Ç–∫—É–¥–∞ –º–æ–∂–Ω–æ –≤–∑—è—Ç—å –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Ç–æ–≤–∞—Ä—É (–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã —á–∞—â–µ –≤—Å–µ–≥–æ)	
Hotline - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä—ã–Ω–æ—á–Ω—ã—Ö —Ü–µ–Ω —Å—Ä–µ–¥–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤

–¢–∞–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–º–µ—é—Ç —ç—Ç–∏ –ª–∏—Å—Ç—ã. –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –±—É–¥–µ—Ç —Ç—è–∂–µ–ª–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ.
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–∏—Å—Ç–æ–≤ –ø—Ä–æ–¥–∞–∂ (–æ—Ç –°—ñ—á–µ–Ω—å 2024 –¥–æ –°—ñ—á–µ–Ω—å 2026 –ø–æ–∫–∞ —á—Ç–æ. –î–æ–±–∞–≤–ª—è—é—Ç—Å—è –ø–æ –º–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤—Ä–µ–º–µ–Ω–∏)
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—Å—Ç–∞—è –∏ –∏–¥–µ–Ω—Ç–∏—á–Ω–∞—è, –Ω–∞ —Å—Ç–∞—Ä—ã—Ö –ª–∏—Å—Ç–∞—Ö –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—á–Ω–∞, –Ω–∞ –Ω–æ–≤—ã—Ö –ª–∏—Å—Ç–∞—Ö —Ñ–æ—Ä–º—É–ª—ã –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Ç–æ–º –∑–∞–º–µ–Ω—è—é —Å—Ç–∞—Ç–∏—á–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.
A-F - –æ–±—â–∏–π –±–ª–æ–∫ (–≤—Å–µ)
A - –ù–∞–∑–≤–∞ (–Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –°–†–ú –∏ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–µ)
B - –ö—ñ–ª—å–∫—ñ—Å—Ç—å =SUM(B3:B) (—Å–∫–æ–ª—å–∫–æ –µ–¥. —Ç–æ–≤–∞—Ä–∞ –ø—Ä–æ–¥–∞–Ω–æ)
C - –£—Å—å–æ–≥–æ =SUM(C3:C) (–≤—ã—Ç–æ—Ä–≥ –≤—Å–µ—Ö –µ–¥. —Ç–æ–≤–∞—Ä–∞)
D - –ú–∞—Ä–∂–∞ (–æ–±—â) =C3 - (B3 * VLOOKUP(E3; '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'!A:E; 5; FALSE)) (–º–∞—Ä–∂–∞ –≤—Å–µ—Ö –µ–¥. —Ç–æ–≤–∞—Ä–∞)
E - –ê—Ä—Ç–∏–∫—É–ª =ARRAYFORMULA( IF( LEN(A3:A)=0 ; ; IFERROR( VLOOKUP(TRIM(A3:A) ;{ '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'!C:C \ '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'!A:A } ; 2 ; FALSE ) ; "‚ùå –ù–ï –ó–ù–ê–ô–î–ï–ù–û" ) ) ) (–∞—Ä—Ç–∏–∫—É–ª —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –∏ –°–†–ú)
F - –î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏ (–¥–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏ –¥–ª—è –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ª–∏—Å—Ç–∞)

—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ñ–∏–ª–∏–∞–ª–æ–≤ –ø–æ—á—Ç–∏ –Ω–µ–∏–∑–º–µ–Ω–Ω–∞—è 
H:M - –®–µ–≤—á–µ–Ω–∫–æ
O:T- –ù–∞–≥–æ—Ä–∫–∞
V:AA - –ê–ø–ø–æ–ª–æ
AC:AH - –ì–æ—Ä–æ–¥–æ–∫
AJ:AO - –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω 

–õ–∏—Å—Ç—ã –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –º—ã –Ω–µ —Å–º–æ—Ç—Ä–∏–º:
MasterData; Attributes; –ê—Ç—Ä–∏–±—É—Ç–∏

Gas —Å–∫—Ä–∏–ø—Ç—ã - 
–ë–µ–∑ –Ω–∞–∑–≤–∏ - –∑–∞–±—ã–ª —á—Ç–æ –∑–∞ —Å–∫—Ä–∏–ø—Ç:
/***** –ö–∞—Ç–µ–≥–æ—Ä—ñ–π–Ω–µ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è: –¥–ª—è –≤—Å—ñ—Ö –ª–∏—Å—Ç—ñ–≤ *****/

function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('–§–æ—Ä–º–∞—Ç')
    .addItem('–ü–æ—Ñ–∞—Ä–±—É–≤–∞—Ç–∏ –≤—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó', 'formatAllCategorySheets')
    .addToUi();
}

function formatAllCategorySheets() {
  const CATEGORY_SHEETS = [
    "–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ —Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏","–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏","Apple (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ iPhone)","Xiaomi (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ Xiaomi)","Samsung (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ Samsung)","–¢–µ–ª–µ—Ñ–æ–Ω–∏",
    "–ü–ª–∞–Ω—à–µ—Ç–∏ —Ç–∞ –∫–Ω–∏–≥–∏","–ü–ª–∞–Ω—à–µ—Ç–∏","Apple (–ø–ª–∞–Ω—à–µ—Ç–∏ iPad)","Xiaomi (–ø–ª–∞–Ω—à–µ—Ç–∏ Xiaomi)","Samsung (–ø–ª–∞–Ω—à–µ—Ç–∏ Samsung)","–ì—Ä–∞—Ñ—ñ—á–Ω—ñ –ø–ª–∞–Ω—à–µ—Ç–∏","–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ñ –∫–Ω–∏–≥–∏",
    "–ù–æ—É—Ç–±—É–∫–∏ —Ç–∞ –ü–ö","–ù–æ—É—Ç–±—É–∫–∏","Apple (–ù–æ—É—Ç–±—É–∫–∏ MacBook)","–ü–ö","Apple (–ü–ö iMac)","–ú–æ–Ω—ñ—Ç–æ—Ä–∏ –¥–æ –ü–ö","–ö–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ –¥–ª—è –ü–ö","–ö–æ—Ä–ø—É—Å–∏ –¥–ª—è –ü–ö","–í—ñ–¥–µ–æ–∫–∞—Ä—Ç–∏ –¥–ª—è –ü–ö",
    "–°–∏—Å—Ç–µ–º–∏ –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è –¥–ª—è –ü–ö","SSD —Ç–∞ HDD –Ω–∞–∫–æ–ø–∏—á—É–≤–∞—á—ñ –¥–ª—è –ü–ö","–ú–∞–∏–µ—Ä–∏–Ω—Å—å–∫—ñ –ø–ª–∞—Ç–∏ –¥–ª—è –ü–ö","–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä–∏ –¥–ª—è –ü–ö","–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞ –ø–∞–º º—è—Ç—å –¥–ª—è –ü–ö",
    "–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ –Ω–æ—É—Ç–±—É–∫—ñ–≤ —Ç–∞ –ü–ö","–ó–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó –¥–ª—è –Ω–æ—É—Ç–±—É–∫—ñ–≤",
    "–ù–∞–≤—É—à–Ω–∏–∫–∏ —Ç–∞ –∞–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏","–ù–∞–≤—É—à–Ω–∏–∫–∏","Apple (–ù–∞–≤—É—à–Ω–∏–∫–∏ AirPods, EarPods)","Marshall (–ù–∞–≤—É—à–Ω–∏–∫–∏ Marshall)","Bang & Olufsen (–ù–∞–≤—É—à–Ω–∏–∫–∏ Bang & Olufsen)",
    "Bose (–ù–∞–≤—É—à–Ω–∏–∫–∏ Bose)","JBL (–ù–∞–≤—É—à–Ω–∏–∫–∏ JBL)","Baseus (–ù–∞–≤—É—à–Ω–∏–∫–∏ Baseus)",
    "–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏","Apple (–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ HomePod)","Marshall (–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ Marshall)","Bang & Olufsen (–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ Bang & Olufsen)",
    "Bose (–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ Bose)","JBL (–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ JBL)","–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ –Ω–∞–≤—É—à–Ω–∏–∫—ñ–≤ —Ç–∞ –∞–∫—É—Å—Ç–∏—á–Ω–∏—Ö —Å–∏—Å—Ç–µ–º",
    "–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏ —Ç–∞ —Ñ—ñ—Ç–Ω–µ—Å-–±—Ä–∞—Å–ª–µ—Ç–∏","–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏","Apple (–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏ Apple Watch)","Samsung (–°–º–∞—Ä—Ç –≥–æ–¥–∏–Ω–Ω–∏–∫–∏ Galaxy Watch)","–§—ñ—Ç–Ω–µ—Å-–±—Ä–∞—Å–ª–µ—Ç–∏",
    "Xiaomi (–§—ñ—Ç–Ω–µ—Å-–±—Ä–∞—Å–ª–µ—Ç–∏ Mi Band)","–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ —Å–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫—ñ–≤ —Ç–∞ —Ñ—ñ—Ç–Ω–µ—Å-–±—Ä–∞—Å–ª–µ—Ç—ñ–≤",
    "–¢–æ–≤–∞—Ä–∏ –¥–ª—è –¥–æ–º—É","–†–æ–±–æ—Ç–∏-–ø–∏–ª–æ—Å–æ—Å–∏","Xiaomi (–†–æ–±–æ—Ç–∏-–ø–∏–ª–æ—Å–æ—Å–∏ Xiaomi)","–†—É—á–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏","Xiaomi (–†—É—á–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏ Xiaomi)","Dyson (–†—É—á–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏ Dyson)",
    "–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏","Baseus (–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏ Baseus)","–ö–ª—ñ–º–∞—Ç–∏—á–Ω–∞ —Ç–µ—Ö–Ω—ñ–∫–∞","–ó–≤–æ–ª–æ–∂—É–≤–∞—á—ñ –ø–æ–≤—ñ—Ç—Ä—è","–û—á–∏—â—É–≤–∞—á—ñ –ø–æ–≤—ñ—Ç—Ä—è","–û—Å—É—à—É–≤–∞—á—ñ –ø–æ–≤—ñ—Ç—Ä—è","–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ —Ç–æ–≤–∞—Ä—ñ–≤ –¥–ª—è –¥–æ–º—É",
    "–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ —Ç–∞ –≥–µ–π–º—ñ–Ω–≥","–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ","Sony (–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ Sony PlayStation)","Xbox (–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ Xbox)","Nintendo (–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ Nintendo)","Steam (–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ Steam Deck)",
    "–ì–µ–π–º–ø–∞–¥–∏ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏","Sony (–ì–µ–π–º–ø–∞–¥–∏ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏ Sony)","Xbox (–ì–µ–π–º–ø–∞–¥–∏ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏ Xbox)","Logitech (–ì–µ–π–º–ø–∞–¥–∏ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏ Logitech)","–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ —ñ–≥—Ä–æ–≤–∏—Ö –∫–æ–Ω—Å–æ–ª–µ–π",
    "–î–æ–≥–ª—è–¥ —Ç–∞ –∫—Ä–∞—Å–∞","–§–µ–Ω–∏ —Ç–∞ —Å—Ç–∞–π–ª–µ—Ä–∏","Dyson (–§–µ–Ω–∏ —Ç–∞ —Å—Ç–∞–π–ª–µ—Ä–∏ Dyson)","–ü–ª–æ–π–∫–∏ —Ç–∞ –≤–∏–ø—Ä—è–º–ª—è—á—ñ","–í–∞–≥–∏ –ø—ñ–¥–ª–æ–≥–æ–≤—ñ","–ó—É–±–Ω—ñ —â—ñ—Ç–∫–∏ —Ç–∞ —ñ—Ä–∏–≥–∞—Ç–æ—Ä–∏","–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –¥–æ–≥–ª—è–¥—É —Ç–∞ –∫—Ä–∞—Å–∏",
    "–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏","–ê–≤—Ç–æ—Ç—Ä–∏–º–∞—á—ñ (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)","–ê—Ä–æ–º–∞—Ç–∏–∑–∞—Ç–æ—Ä–∏ (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)","–ó–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)","–ë—É—Å—Ç–µ—Ä–∏ —Ç–∞ –∫–æ–º–ø—Ä–µ—Å–æ—Ä–∏ (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)","–Ü–Ω–≤–µ—Ä—Ç–æ—Ä–∏ (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)","–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –∞–≤—Ç–æ–º–æ–±—ñ–ª—è (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)",
    "–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤","–ß–æ—Ö–ª–∏ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤","Apple (–ß–æ—Ö–ª–∏ –¥–ª—è iPhone)","Xiaomi (–ß–æ—Ö–ª–∏ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤ Xiaomi)","Samsung (–ß–æ—Ö–ª–∏ –¥–ª—è —Å–º–∞—Ä—Ç–≤–æ–Ω—ñ–≤ Samsung)",
    "–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ —ñ –ø–ª—ñ–≤–∫–∞ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤","Apple (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è iPhone)","Xiaomi (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤ Xiaomi)","Samsung (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤ Samsung)","–ó–∞—Ö–∏—Å–Ω–∞ –ø–ª—ñ–≤–∫–∞ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤",
    "–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤","–ß–æ—Ö–ª–∏ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤","Apple (–ß–æ—Ö–ª–∏ –¥–ª—è iPad)","Xiaomi (–ß–æ—Ö–ª–∏ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤ Xiaomi)","Samsung (–ß–æ—Ö–ª–∏ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤ Samsung)",
    "–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ —ñ –ø–ª—ñ–≤–∫–∞ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤","Apple (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è iPad)","Xiaomi (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤ Xiaomi)","Samsung (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤ Samsung)","–ó–∞—Ö–∏—Å–Ω–∞ –ø–ª—ñ–≤–∫–∞ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤",
    "–ü–∞–≤–µ—Ä–±–∞–Ω–∫–∏ —Ç–∞ –±–∞—Ç–∞—Ä–µ–π–∫–∏","–ü–∞–≤–µ—Ä–±–∞–Ω–∫–∏","–ë–∞—Ç–∞—Ä–µ–π–∫–∏",
    "–ö–≤–∞–¥—Ä–æ–∫–æ–ø—Ç–µ—Ä–∏","DJI (–ö–≤–∞–¥—Ä–æ–∫–æ–ø—Ç–µ—Ä–∏ DJI)","–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ –∫–≤–∞–¥—Ä–æ–∫–æ–ø—Ç–µ—Ä—ñ–≤",
    "–ù–∞–∫–æ–ø–∏—á—É–≤–∞—á—ñ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó","–§–ª–µ—à–∫–∏","–ö–∞—Ä—Ç–∫–∏ –ø–∞–º º—è—Ç—ñ MicroSD",
    "–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ —Ç–∞ –∫–æ–º–ø º—é—Ç–µ—Ä–Ω—ñ –º–∏—à—ñ","–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∏","Logitech (–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ Logitech)","–ö–æ–º–ø º—é—Ç–µ—Ä–Ω—ñ –º–∏—à—ñ","Logitech (–ö–æ–º–ø º—é—Ç–µ—Ä–Ω—ñ –º–∏—à—ñ Logitech)",
    "–ö–∞–±–µ–ª—ñ —Ç–∞ –ø–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏","–ö–∞–±–µ–ª—ñ","Apple (–ö–∞–±–µ–ª—ñ Apple)","Acefast (–ö–∞–±–µ–ª—ñ Acefast)","Baseus (–ö–∞–±–µ–ª—ñ Baseus)",
    "–ü–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏","Apple (–ü–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏ Apple)","Acefast (–ü–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏ Acefast)","Baseus (–ü–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏ Baseus)",
    "–ó–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó","–ë–µ–∑–¥—Ä–æ—Ç–æ–≤—ñ –∑–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó","Apple (–ë–µ–∑–¥—Ä–æ—Ç–æ–≤—ñ –ó–ü Apple)","Acefast (–ë–µ–∑–¥—Ä–æ—Ç–æ–≤—ñ –ó–ü Acefast)","Baseus (–ë–µ–∑–¥—Ä–æ—Ç–æ–≤—ñ –ó–ü Baseus)",
    "–ú–µ—Ä–µ–∂–µ–≤—ñ –∑–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó","Apple (–ú–µ—Ä–µ–∂–µ–≤—ñ –ó–ü Apple)","Acefast (–ú–µ—Ä–µ–∂–µ–≤—ñ –ó–ü Acefast)","Baseus (–ú–µ—Ä–µ–∂–µ–≤—ñ –ó–ü Baseus)",
    "–ì–∞–¥–∂–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º","–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º","Apple (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º iPhone)","Xiaomi (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Xiaomi)","Samsung (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Samsung)",
    "–ü–ª–∞–Ω—à–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º","Apple (–ü–ª–∞–Ω—à–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º iPad)","Xiaomi (–ø–ª–∞–Ω—à–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Xiaomi)","Samsung (–ø–ª–∞–Ω—à–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Samsung)",
    "–ù–æ—É—Ç–±—É–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º","Apple (–ù–æ—É—Ç–±—É–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º MacBook)","–ü–ö –∑ –ø—Ä–æ–±—ñ–≥–æ–º","Apple (–ü–ö –∑ –ø—Ä–æ–±—ñ–≥–æ–º iMac)",
    "–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º","Apple (–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Apple Watch)",
    "–Ü–Ω—à—ñ –≥–∞–¥–∂–µ—Ç–∏","–ü–æ–¥–∞—Ä—É–Ω–∫–æ–≤—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏",
    "–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ —Ç–∞ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è","–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏","–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏","Apple (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Apple)","Xiaomi (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Xiaomi)","Samsung (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Samsung)","Huawei (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Huawei)",
    "Google (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Google)","–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω—ñ –∞–∫—É–º—É–ª—è—Ç–æ—Ä–∏","–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è","Apple (–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è Apple)","Xiaomi (–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è Xiaomi)",
    "Samsung (–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è Samsung)","Huawei (–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è Huawei)","–î–∏–Ω–∞–º—ñ–∫–∏","Apple (–î–∏–Ω–∞–º—ñ–∫–∏ Apple)","–ó–∞–¥–Ω—ñ –∫—Ä–∏—à–∫–∏","Apple (–ó–∞–¥–Ω—ñ –∫—Ä–∏—à–∫–∏ Apple)",
    "–ö–º–µ—Ä–∏ —Ç–∞ —Å–∫–ª–æ –∫–∞–º–µ—Ä–∏","Apple (–ö–º–µ—Ä–∏ —Ç–∞ —Å–∫–ª–æ –∫–∞–º–µ—Ä–∏ Apple)","–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏","Apple (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏ Apple)","Xiaomi (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏ Xiaomi)","Samsung (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏ Samsung)","Huawei (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏ Huawei)",
    "–®–ª–µ–π—Ñ–∏","Apple (–®–ª–µ–π—Ñ–∏ Apple)","–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏ –¥–ª—è —ñ–≥—Ä–æ–≤–∏—Ö –∫–æ–Ω—Å–æ–ª–µ–π","–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏ –¥–ª—è Sony PlayStation Sony PlayStation"
  ];

  const ss = SpreadsheetApp.getActive();
  const existSheets = ss.getSheets().map(s => s.getName());
  const found = CATEGORY_SHEETS.filter(n => existSheets.includes(n));

  found.forEach(name => {
    try {
      formatOneSheet(ss.getSheetByName(name));
    } catch (err) {
      Logger.log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –Ω–∞ –∞—Ä–∫—É—à—ñ ${name}: ${err}`);
    }
  });

  SpreadsheetApp.getUi().alert(`‚úÖ –û–±—Ä–æ–±–ª–µ–Ω–æ ${found.length} –∫–∞—Ç–µ–≥–æ—Ä—ñ–π–Ω–∏—Ö –∞—Ä–∫—É—à—ñ–≤`);
}

/** –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –æ–¥–Ω–æ–≥–æ –∞—Ä–∫—É—à–∞ (—ñ–¥–µ–Ω—Ç–∏—á–Ω–æ —Ç–µ—Å—Ç–æ–≤–æ–º—É) */
function formatOneSheet(sh) {
  const lastCol = sh.getLastColumn();
  if (!lastCol) return;
  const headers = sh.getRange(1, 1, 1, lastCol).getDisplayValues()[0];
  const dataRange = sh.getDataRange();
  dataRange.setVerticalAlignment('middle');
  dataRange.setWrapStrategy(SpreadsheetApp.WrapStrategy.CLIP);

  // –õ—ñ–≤–µ –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è
  ['–Ü–º º—è','–ö–∞—Ç–µ–≥–æ—Ä—ñ—è','–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–æ–≤–∞—Ä','–ù–∞–∑–≤–∞ –Ω–∞ —Å–∞–π—Ç—ñ','–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü—ñ—è','–î–∂–µ—Ä–µ–ª–æ –¥–∞–Ω–∏—Ö','Hotline']
    .forEach(h => {
      const c = findColIndex(headers, h);
      if (c) sh.getRange(1, c, sh.getMaxRows(), 1).setHorizontalAlignment('left');
    });

  const COLORS = { blue:'#0000FF', red:'#FF0000', green:'#008000', yellow:'#B58900' };

  paintBlueSmart(headers, sh, COLORS.blue);
  paintHeaderSpan(sh, headers, '–†–µ–º–æ–Ω—Ç','–°—Ç–∞–≤–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞',COLORS.red,true);
  paintHeaderSpan(sh, headers, '–ú–æ–¥–µ–ª—å','–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–æ–≤–∞—Ä',COLORS.green,true);
  paintHeaderSpan(sh, headers, '–û–ø–∏—Å','Hotline',COLORS.yellow,true);

  autoWidthByHeader(sh, headers);
}

/** –°–ª—É–∂–±–æ–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó —Ç—ñ –∂ —Å–∞–º—ñ, —â–æ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º—É –≤–∞—Ä—ñ–∞–Ω—Ç—ñ */
function findColIndex(headersRow, headerName){for(let i=0;i<headersRow.length;i++){if(String(headersRow[i]).trim()===String(headerName).trim())return i+1;}return 0;}
function paintHeaderSpan(sheet,headersRow,startHeader,endHeader,fontColorHex,inclusiveEnd){const s=findColIndex(headersRow,startHeader),e=findColIndex(headersRow,endHeader);if(!s||!e)return;let from=Math.min(s,e),to=Math.max(s,e);if(!inclusiveEnd)to-=1;if(to<from)return;sheet.getRange(1,from,sheet.getMaxRows(),to-from+1).setFontColor(fontColorHex);}
function paintBlueSmart(headers,sheet,blueHex){const cB=findColIndex(headers,'–ë—Ä–µ–Ω–¥'),cM=findColIndex(headers,'–ú–∞—Ç–µ—Ä—ñ–∞–ª'),cR=findColIndex(headers,'–†–µ–º–æ–Ω—Ç');if(!cB)return;let end=0;if(cM&&(!cR||cM<=cR))end=cM;else if(cR&&cR>cB)end=cR-1;if(end&&end>=cB)sheet.getRange(1,cB,sheet.getMaxRows(),end-cB+1).setFontColor(blueHex);}
function autoWidthByHeader(sheet,headersRow){const MIN=70,MAX=320,PAD=20,PX=8;for(let i=0;i<headersRow.length;i++){const t=String(headersRow[i]||'').trim(),W=Math.min(MAX,Math.max(MIN,Math.round(t.length*PX+PAD)));sheet.setColumnWidth(i+1,W);}}
–ß–∏—Å—Ç–∫–∞ –ø—Ä–æ–¥–∞–∂+–Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ - —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ª–∏—Å—Ç–∞–º–∏ –ß.–ü. –∏ –ß. –ù.
/*** CONFIG ***/
const CFG = {
  SHEETS: {
    CATEGORIES: '–ß. –ù.',
    SALES:      '–ß.–ü.',
    NOMEN:      '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'
  },
  COLS: {
    // 1-based –∏–Ω–¥–µ–∫—Å—ã
    CAT:   4,   // D –≤ "–ß. –ù."
    ART:   1,   // A –≤ "–ß. –ù."
    NAME:  1,   // A –≤ "–ß.–ü."
    QTY:   2,   // B –≤ "–ß.–ü."
    TOTAL: 3,   // C –≤ "–ß.–ü."
    NOMEN_NAME: 3 // C –≤ "–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞"
  },
  TMP_SUFFIX: '_SNAPSHOT_VALUES',
  DELETE_CHUNK: 120
};

/*** –ß—ë—Ä–Ω—ã–µ —Å–ø–∏—Å–∫–∏ ***/
const BLACKLIST = new Set([
  '–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ —Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏','–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏','Apple (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ iPhone)','Xiaomi (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ Xiaomi)',
  'Samsung (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ Samsung)','–¢–µ–ª–µ—Ñ–æ–Ω–∏','–ü–ª–∞–Ω—à–µ—Ç–∏ —Ç–∞ –∫–Ω–∏–≥–∏','–ü–ª–∞–Ω—à–µ—Ç–∏','Apple (–ø–ª–∞–Ω—à–µ—Ç–∏ iPad)',
  'Xiaomi (–ø–ª–∞–Ω—à–µ—Ç–∏ Xiaomi)','Samsung (–ø–ª–∞–Ω—à–µ—Ç–∏ Samsung)','–ù–æ—É—Ç–±—É–∫–∏ —Ç–∞ –ü–ö','–ù–æ—É—Ç–±—É–∫–∏',
  'Apple (–ù–æ—É—Ç–±—É–∫–∏ MacBook)','–ü–ö','Apple (–ü–ö iMac)','–ú–æ–Ω—ñ—Ç–æ—Ä–∏ –¥–æ –ü–ö','–ö–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ –¥–ª—è –ü–ö',
  '–ö–æ—Ä–ø—É—Å–∏ –¥–ª—è –ü–ö','–í—ñ–¥–µ–æ–∫–∞—Ä—Ç–∏ –¥–ª—è –ü–ö','–°–∏—Å—Ç–µ–º–∏ –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è –¥–ª—è –ü–ö','SSD —Ç–∞ HDD –Ω–∞–∫–æ–ø–∏—á—É–≤–∞—á—ñ –¥–ª—è –ü–ö',
  '–ú–∞–∏–µ—Ä–∏–Ω—Å—å–∫—ñ –ø–ª–∞—Ç–∏ –¥–ª—è –ü–ö','–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä–∏ –¥–ª—è –ü–ö','–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞ –ø–∞–º º—è—Ç—å –¥–ª—è –ü–ö',
  'Apple (–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ HomePod)','Apple (–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏ Apple Watch)',
  'Samsung (–°–º–∞—Ä—Ç –≥–æ–¥–∏–Ω–Ω–∏–∫–∏ Galaxy Watch)','–†–æ–±–æ—Ç–∏-–ø–∏–ª–æ—Å–æ—Å–∏','Xiaomi (–†–æ–±–æ—Ç–∏-–ø–∏–ª–æ—Å–æ—Å–∏ Xiaomi)',
  '–†—É—á–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏','Xiaomi (–†—É—á–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏ Xiaomi)','Dyson (–†—É—á–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏ Dyson)',
  '–ö–ª—ñ–º–∞—Ç–∏—á–Ω–∞ —Ç–µ—Ö–Ω—ñ–∫–∞','–û—Å—É—à—É–≤–∞—á—ñ –ø–æ–≤—ñ—Ç—Ä—è','–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ —Ç–æ–≤–∞—Ä—ñ–≤ –¥–ª—è –¥–æ–º—É','–î–æ–≥–ª—è–¥ —Ç–∞ –∫—Ä–∞—Å–∞',
  '–§–µ–Ω–∏ —Ç–∞ —Å—Ç–∞–π–ª–µ—Ä–∏','Dyson (–§–µ–Ω–∏ —Ç–∞ —Å—Ç–∞–π–ª–µ—Ä–∏ Dyson)','–ü–ª–æ–π–∫–∏ —Ç–∞ –≤–∏–ø—Ä—è–º–ª—è—á—ñ',
  '–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –¥–æ–≥–ª—è–¥—É —Ç–∞ –∫—Ä–∞—Å–∏','–ö–≤–∞–¥—Ä–æ–∫–æ–ø—Ç–µ—Ä–∏','DJI (–ö–≤–∞–¥—Ä–æ–∫–æ–ø—Ç–µ—Ä–∏ DJI)',
  '–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ –∫–≤–∞–¥—Ä–æ–∫–æ–ø—Ç–µ—Ä—ñ–≤','–ì–∞–¥–∂–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º','–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º',
  'Apple (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º iPhone)','Xiaomi (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Xiaomi)',
  'Samsung (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Samsung)','–ü–ª–∞–Ω—à–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º','Apple (–ü–ª–∞–Ω—à–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º iPad)',
  'Xiaomi (–ø–ª–∞–Ω—à–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Xiaomi)','Samsung (–ø–ª–∞–Ω—à–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Samsung)','–ù–æ—É—Ç–±—É–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º',
  'Apple (–ù–æ—É—Ç–±—É–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º MacBook)','–ü–ö –∑ –ø—Ä–æ–±—ñ–≥–æ–º','Apple (–ü–ö –∑ –ø—Ä–æ–±—ñ–≥–æ–º iMac)',
  '–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º','Apple (–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Apple Watch)',
  '–ü–æ–¥–∞—Ä—É–Ω–∫–æ–≤—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏','–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ —Ç–∞ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è','–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏','–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏',
  'Apple (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Apple)','Xiaomi (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Xiaomi)','Samsung (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Samsung)',
  'Huawei (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Huawei)','Google (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Google)','–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω—ñ –∞–∫—É–º—É–ª—è—Ç–æ—Ä–∏',
  '–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è','Apple (–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è Apple)',
  'Xiaomi (–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è Xiaomi)','Samsung (–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è Samsung)',
  'Huawei (–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è Huawei)','–î–∏–Ω–∞–º—ñ–∫–∏','Apple (–î–∏–Ω–∞–º—ñ–∫–∏ Apple)','–ó–∞–¥–Ω—ñ –∫—Ä–∏—à–∫–∏',
  'Apple (–ó–∞–¥–Ω—ñ –∫—Ä–∏—à–∫–∏ Apple)','–ö–º–µ—Ä–∏ —Ç–∞ —Å–∫–ª–æ –∫–∞–º–µ—Ä–∏','Apple (–ö–º–µ—Ä–∏ —Ç–∞ —Å–∫–ª–æ –∫–∞–º–µ—Ä–∏ Apple)',
  '–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏','Apple (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏ Apple)','Xiaomi (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏ Xiaomi)','Samsung (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏ Samsung)',
  'Huawei (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏ Huawei)','–®–ª–µ–π—Ñ–∏','Apple (–®–ª–µ–π—Ñ–∏ Apple)','–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏ –¥–ª—è —ñ–≥—Ä–æ–≤–∏—Ö –∫–æ–Ω—Å–æ–ª–µ–π',
  '–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏ –¥–ª—è Sony PlayStation','Xbox (–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ Xbox)','Xbox (–ì–µ–π–º–ø–∞–¥–∏ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏ Xbox)',
  'Steam (–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ Steam Deck)','Sony (–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ Sony PlayStation)',
  'Sony (–ì–µ–π–º–ø–∞–¥–∏ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏ Sony)','Samsung (–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏ Galaxy Watch)',
  'Nintendo (–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ Nintendo)','–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏','–ù–æ—É–±—É–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º','–ï–∫—à–Ω-–∫–∞–º–µ—Ä–∏ GoPro'
]);

const BLACKLIST_ARTICLES = new Set([
  '100122','100011','100013','100010','100012','100841','102770','112791','112792','101101',
  '101583','101584','103093','103123','103124','103126','103127','103128','103132','103125',
  '103787','103788','103789','104543','104546','104547','104548','104555','104643','104644',
  '105201','105277','105278','105279','105280','105281','105282','105283','105442','107198',
  'BD1003','BD1004','BD1009','BD1005','BD1008','BD1007','BD1012','BD1011','BD1013','BD1010',
  'BD1001','BD1002','BD1006','BD1014','100950','100106','100859','101070','100105','100842',
  '100019','103067','103084','103131','101093','112784','103785','104884','104957','104963',
  '105146','105160','105161','105448','106899','106910','106911','107043','107186','107191',
  '107990','101426','102775','104711','104958','105213','105452','105734','105810','105976',
  '105981','106124','107030','107153','107227','107265','107284','107813','107207','100408',

  // –î–û–ë–ê–í–õ–ï–ù–û –ø–æ –∑–∞–ø—Ä–æ—Å—É:
  '110266','110274','110279','110283','109767','109713'
]);

/*** –û–¢–î–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ú–ï–ù–Æ ‚Äî –ß–¢–û–ë–´ –ù–ò–ö–¢–û –ù–ï –ü–ï–†–ï–ë–ò–õ ***/
function addSnapshotMenu_() {
  SpreadsheetApp.getUi()
    .createMenu('üßπ –ß–∏—Å—Ç–∫–∞ (snapshot)')
    .addItem('–ß.–ù. ‚Üí —É–¥–∞–ª–∏—Ç—å –ø–æ —á—ë—Ä–Ω—ã–º —Å–ø–∏—Å–∫–∞–º', 'cleanCategories_bySnapshot')
    .addItem('–ß.–ü. ‚Üí —É–¥–∞–ª–∏—Ç—å+—Å–æ—Ä—Ç (–ø–æ –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ñ)', 'cleanSales_bySnapshot')
    .addSeparator()
    .addItem('–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ñ–æ—Ä–º—É–ª/–∏–º–ø–æ—Ä—Ç–æ–≤', 'profileVolatile')
    .addToUi();
}

/*** –ü—Ä–æ—Å—Ç–æ–π onOpen (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–±–∏—Ç –¥—Ä—É–≥–∏–º —Å–∫—Ä–∏–ø—Ç–æ–º, —ç—Ç–æ –æ–∫) ***/
function onOpen(e) {
  addSnapshotMenu_();
}

/*** –ß.–ù. –ø–æ —Å–Ω–∏–º–∫—É ***/
function cleanCategories_bySnapshot(returnToSheetName) {
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName(CFG.SHEETS.CATEGORIES);
  if (!sh) { SpreadsheetApp.getUi().alert('–ù–µ –Ω–∞–π–¥–µ–Ω –ª–∏—Å—Ç "'+CFG.SHEETS.CATEGORIES+'"'); return; }

  // –∑–∞–ø–æ–º–∏–Ω–∞–µ–º, –≥–¥–µ –±—ã–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –º–æ–º–µ–Ω—Ç —Å—Ç–∞—Ä—Ç–∞
  const returnSheet = returnToSheetName ? ss.getSheetByName(returnToSheetName) : ss.getActiveSheet();

  const sheetId = sh.getSheetId();
  const snap = _makeValuesSnapshot_(sh, returnSheet);

  try {
    const lastRow = snap.getLastRow();
    if (lastRow < 2) return;

    // —á–∏—Ç–∞–µ–º –¢–û–õ–¨–ö–û A –∏ D –∏–∑ —Å–Ω–∏–º–∫–∞
    const arts = snap.getRange(2, CFG.COLS.ART, lastRow-1, 1).getValues();
    const cats = snap.getRange(2, CFG.COLS.CAT, lastRow-1, 1).getValues();

    const toDelete = new Array(lastRow-1).fill(false);
    for (let i=0;i<toDelete.length;i++){
      const art = (arts[i][0] == null ? '' : String(arts[i][0]).trim());
      const cat = (cats[i][0] == null ? '' : String(cats[i][0]).trim());
      if (BLACKLIST.has(cat) || BLACKLIST_ARTICLES.has(art)) toDelete[i] = true;
    }
    const ranges = _compressDeletionRanges_(toDelete, 1);
    if (ranges.length) _batchDeleteRows_(ss.getId(), sheetId, ranges);
  } finally {
    // 1) –≤–µ—Ä–Ω—É—Ç—å —Ñ–æ–∫—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    _safeSetActiveSheet_(ss, returnSheet);
    // 2) —É–¥–∞–ª–∏—Ç—å —Å–Ω–∏–º–æ–∫
    _safeDeleteSheet_(ss, snap);
  }
}

/*** –ß.–ü. –ø–æ —Å–Ω–∏–º–∫—É + —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ***/
function cleanSales_bySnapshot(returnToSheetName) {
  const ss = SpreadsheetApp.getActive();
  const sales = ss.getSheetByName(CFG.SHEETS.SALES);
  const nomen = ss.getSheetByName(CFG.SHEETS.NOMEN);
  if (!sales || !nomen) { SpreadsheetApp.getUi().alert('–ù–µ—Ç "–ß.–ü." –∏–ª–∏ "–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞"'); return; }

  const returnSheet = returnToSheetName ? ss.getSheetByName(returnToSheetName) : ss.getActiveSheet();

  const snapSales = _makeValuesSnapshot_(sales, returnSheet);
  const snapNomen = _makeValuesSnapshot_(nomen, returnSheet);

  try {
    // allowed names –∏–∑ C –≤ –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–µ
    const nLast = snapNomen.getLastRow();
    const allowed = new Set();
    if (nLast >= 2) {
      const nm = snapNomen.getRange(2, CFG.COLS.NOMEN_NAME, nLast-1, 1).getValues();
      for (let i=0;i<nm.length;i++){
        const v = nm[i][0];
        if (v != null && v !== '') allowed.add(String(v).trim());
      }
    }

    // –ß–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ A –≤ –ß.–ü.
    const sLast = snapSales.getLastRow();
    if (sLast < 2) return;
    const names = snapSales.getRange(2, CFG.COLS.NAME, sLast-1, 1).getValues();

    const toDelete = new Array(sLast-1).fill(false);
    for (let i=0;i<toDelete.length;i++){
      const name = names[i][0];
      if (name == null || name === '' || !allowed.has(String(name).trim())) toDelete[i] = true;
    }
    const ranges = _compressDeletionRanges_(toDelete, 1);
    const sheetId = sales.getSheetId();
    if (ranges.length) _batchDeleteRows_(ss.getId(), sheetId, ranges);

    // —Å–µ—Ä–≤–µ—Ä–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ B (–ö—ñ–ª—å–∫—ñ—Å—Ç—å) —É–±—ã–≤.
    Sheets.Spreadsheets.batchUpdate({
      requests: [{
        sortRange: {
          range: { sheetId, startRowIndex: 1 },
          sortSpecs: [{ dimensionIndex: CFG.COLS.QTY-1, sortOrder: 'DESCENDING' }]
        }
      }]
    }, ss.getId());
  } finally {
    // 1) –≤–µ—Ä–Ω—É—Ç—å —Ñ–æ–∫—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    _safeSetActiveSheet_(ss, returnSheet);
    // 2) —É–¥–∞–ª–∏—Ç—å —Å–Ω–∏–º–∫–∏
    _safeDeleteSheet_(ss, snapSales);
    _safeDeleteSheet_(ss, snapNomen);
  }
}

/*** –°–Ω–∏–º–æ–∫ –≤ values-only (–±–µ–∑ —Ñ–æ—Ä–º—É–ª) ***/
function _makeValuesSnapshot_(sourceSheet, returnSheet) {
  const ss = sourceSheet.getParent();
  const tmpName = sourceSheet.getName() + CFG.TMP_SUFFIX;
  const old = ss.getSheetByName(tmpName);
  if (old) _safeDeleteSheet_(ss, old);

  // copyTo –∏–Ω–æ–≥–¥–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π –ª–∏—Å—Ç ‚Äî —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—Ä–∞—Ç–Ω–æ
  const snap = sourceSheet.copyTo(ss).setName(tmpName);
  _safeSetActiveSheet_(ss, returnSheet);

  // –£–±–∏—Ä–∞–µ–º –∑–∞–º–µ—Ç–∫–∏/–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è
  try { snap.clearNotes(); } catch(_){}
  try { snap.breakApart(); } catch(_){}

  // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –í–ï–°–¨ —Å–Ω–∏–º–æ–∫ –≤ –∑–Ω–∞—á–µ–Ω–∏—è
  const lr = snap.getLastRow();
  const lc = Math.max(1, snap.getLastColumn());
  if (lr && lc) {
    const rng = snap.getRange(1,1,lr,lc);
    rng.copyTo(rng, SpreadsheetApp.CopyPasteType.PASTE_VALUES, false);
  }
  return snap;
}

/*** –°–∂–∞—Ç–∏–µ –≤ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã 0-based (end exclusive) ***/
function _compressDeletionRanges_(mask, offsetRows) {
  const out = [];
  let i = 0;
  while (i < mask.length) {
    if (!mask[i]) { i++; continue; }
    let j = i+1;
    while (j < mask.length && mask[j]) j++;
    out.push({ startRowIndex: offsetRows + i, endRowIndex: offsetRows + j });
    i = j;
  }
  out.reverse();
  return out;
}

/*** –ü–∞–∫–µ—Ç–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ —á–µ—Ä–µ–∑ Advanced Sheets API ***/
function _batchDeleteRows_(spreadsheetId, sheetId, ranges) {
  for (let i=0; i<ranges.length; i+=CFG.DELETE_CHUNK) {
    const part = ranges.slice(i, i+CFG.DELETE_CHUNK);
    const requests = part.map(r => ({
      deleteDimension: { range: {
        sheetId, dimension: 'ROWS',
        startIndex: r.startRowIndex, endIndex: r.endRowIndex
      }}
    }));
    Sheets.Spreadsheets.batchUpdate({ requests }, spreadsheetId);
  }
}

/*** –ë–µ–∑–æ–ø–∞—Å–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –ª–∏—Å—Ç (–Ω–µ –ª–æ–º–∞–µ–º—Å—è –≤ —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö) ***/
function _safeSetActiveSheet_(ss, sheet) {
  try {
    if (ss && sheet) ss.setActiveSheet(sheet);
  } catch(_) {}
}

/*** –ë–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª–∏—Ç—å –ª–∏—Å—Ç ***/
function _safeDeleteSheet_(ss, sheet) {
  try {
    if (ss && sheet) ss.deleteSheet(sheet);
  } catch(_) {}
}

/*** –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –≥–¥–µ –≤–µ—Ä—Ç—è—Ç—Å—è ¬´—Ç—è–∂—ë–ª—ã–µ¬ª —Ñ–æ—Ä–º—É–ª—ã ***/
function profileVolatile() {
  const suspect = /(IMPORTRANGE|IMPORTXML|IMPORTHTML|IMPORTDATA|NOW\(|TODAY\(|RAND\(|RANDBETWEEN\(|OFFSET\(|INDIRECT\()/i;
  const ss = SpreadsheetApp.getActive();
  const sheets = ss.getSheets();
  const report = [];
  for (const sh of sheets) {
    const lr = sh.getLastRow(), lc = sh.getLastColumn();
    if (!lr || !lc) continue;
    let cnt = 0;
    const step = 2000;
    for (let r=1; r<=lr; r+=step) {
      const h = Math.min(step, lr - r + 1);
      const fm = sh.getRange(r,1,h,lc).getFormulas();
      for (let i=0;i<fm.length;i++){
        for (let j=0;j<fm[i].length;j++){
          const f = fm[i][j];
          if (f && suspect.test(f)) cnt++;
        }
      }
    }
    if (cnt) report.push(`${sh.getName()}: –Ω–∞–π–¥–µ–Ω–æ ¬´—Ç—è–∂—ë–ª—ã—Ö¬ª —Ñ–æ—Ä–º—É–ª = ${cnt}`);
  }
  SpreadsheetApp.getUi().alert(report.length ? report.join('\n') : '–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.');
}

/* =====================================================================
 *    –¢–†–ò–ì–ì–ï–†–´ –î–õ–Ø –ê–í–¢–û-–ß–ò–°–¢–ö–ò –ò –ñ–ï–õ–ï–ó–ù–û–ì–û –ú–ï–ù–Æ
 * =====================================================================*/

/**
 * Installable onEdit —Ç—Ä–∏–≥–≥–µ—Ä.
 */
function handleEdit_SnapshotCleaner_(e) {
  if (!e || !e.range) return;

  try {
    const sh = e.range.getSheet();
    const name = sh.getName();

    if (name !== CFG.SHEETS.CATEGORIES && name !== CFG.SHEETS.SALES) return;

    const col = e.range.getColumn();
    if (name === CFG.SHEETS.CATEGORIES) {
      if (col !== CFG.COLS.ART && col !== CFG.COLS.CAT) return;
    } else if (name === CFG.SHEETS.SALES) {
      if (col !== CFG.COLS.NAME) return;
    }

    const lock = LockService.getDocumentLock();
    if (!lock.tryLock(1000)) return;

    try {
      // –ø–µ—Ä–µ–¥–∞—ë–º –∏—Å—Ö–æ–¥–Ω—ã–π –ª–∏—Å—Ç, –≥–¥–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      if (name === CFG.SHEETS.CATEGORIES) {
        cleanCategories_bySnapshot(name);
      } else if (name === CFG.SHEETS.SALES) {
        cleanSales_bySnapshot(name);
      }
    } finally {
      lock.releaseLock();
    }
  } catch (err) {
    console.error('handleEdit_SnapshotCleaner_ error:', err);
  }
}

/**
 * Installable onOpen —Ç—Ä–∏–≥–≥–µ—Ä: –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥—Ä—É–≥–∏—Ö onOpen.
 */
function onOpen_forced_(e) {
  try {
    addSnapshotMenu_();
  } catch (err) {
    console.error('onOpen_forced_ error:', err);
  }
}

/**
 * –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –û–î–ò–ù –†–ê–ó –≤—Ä—É—á–Ω—É—é).
 */
function installSnapshotCleanerTriggers() {
  const ss = SpreadsheetApp.getActive();
  const ssId = ss.getId();

  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(tr => {
    const fn = tr.getHandlerFunction();
    if (fn === 'handleEdit_SnapshotCleaner_' || fn === 'onOpen_forced_') {
      ScriptApp.deleteTrigger(tr);
    }
  });

  ScriptApp.newTrigger('handleEdit_SnapshotCleaner_')
    .forSpreadsheet(ssId)
    .onEdit()
    .create();

  ScriptApp.newTrigger('onOpen_forced_')
    .forSpreadsheet(ssId)
    .onOpen()
    .create();
}

–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–∞—è –∑–∞–∫—É–ø–∫–∞ - —Å–∫—Ä–∏–ø—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–≤–∞—Ä–∞ —Å —Ñ–∏–ª–∏–∞–ª–æ–≤, –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–¥–∞–∂, –ø—Ä–∞–π—Å–æ–≤ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Å–ø–∏—Å–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π, –∑–∞–∫—É–ø–æ–∫ –∏ –ø—Ä–æ—á–µ–≥–æ:
/***** ===================== –ù–ê–°–¢–†–û–ô–ö–ò ===================== *****/
const SRC_SHEETS    = ['–ó–∞–ª_–ê–ø–ø–æ–ª–æ','–ó–∞–ª_–ù–∞–≥–æ—Ä–∫–∞','–ó–∞–ª_–ì–æ—Ä–æ–¥–æ–∫','–ó–∞–ª_–®–µ–≤—á–µ–Ω–∫–æ'];
const OUTPUT_PREFIX = '–ó–∞–∫—É–ø–∫–∏_';
const MOVES_PREFIX  = '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏—è_';
const ABC_SHEET     = '–ê–Ω–∞–ª—ñ–∑ ABC-XYZ';
const MIN_PER_LOC   = 1;

// –ü–∞–ø–∫–∞ –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –∑–∞–∫–∞–∑–æ–≤ (–æ—Å—Ç–∞–≤—å "" ‚Äî —Å–æ–∑–¥–∞—Å—Ç—Å—è –≤ ¬´–ú–æ–π –¥–∏—Å–∫¬ª)
const ORDERS_FOLDER_ID = "";

// –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ —Ç–æ—á–µ–∫ –≤ –∑–∞–∫–∞–∑–∞—Ö (–∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ –§–û–ü–∞–º)
const FOP_HEADER_MAP = {
  '–ê–ø–ø–æ–ª–æ'   : '–ê–ø–ø–æ–ª–æ ‚Äî –ê–ø–ø–æ–ª–æ –î—å—è—á–µ–Ω–∫–æ',
  '–ù–∞–≥–æ—Ä–∫–∞'  : '–ù–∞–≥–æ—Ä–∫–∞ ‚Äî –ù–∞–≥–æ—Ä–∫–∞ –î—å—è—á–µ–Ω–∫–æ',
  '–®–µ–≤—á–µ–Ω–∫–æ' : '–®–µ–≤—á–µ–Ω–∫–æ ‚Äî –®–µ–≤—á–µ–Ω–∫–æ –ë—ñ–ª–∏–π',
  '–ì–æ—Ä–æ–¥–æ–∫'  : '–ì–æ—Ä–æ–¥–æ–∫ ‚Äî –ì–æ—Ä–æ–¥–æ–∫ –©–µ—Ä–±–∏–Ω–∞'
};

// –ö—Ç–æ –ú–û–ñ–ï–¢ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å—Å—è (–ª–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–∫–∞–∑—ã ‚Üí –¥–æ–∫—É–ø–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ—Å–ª–µ –≥–∏–ø–µ—Ä-–ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è)
const SUPPLIERS_MOVABLE = new Set(['artmobile','ncase','–Ω–∞—à —Ç–æ–≤–∞—Ä','–≥–º—Å']);

// –ö—Ç–æ –ù–ï –ú–û–ñ–ï–¢ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å—Å—è (–ª–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–∫–∞–∑—ã ‚Üí –¥–æ–∫—É–ø–∞–µ–º –¥–µ—Ñ–∏—Ü–∏—Ç –ø–æ –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–µ)
// –¥–æ–±–∞–≤–ª–µ–Ω—ã –ú–µ–Ω—Ç–∞–ª (–æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏—è –º–µ–Ω—Ç–∞–ª), —É–¥–∞–ª–µ–Ω ColorWay
const SUPPLIERS_NON_MOVABLE = new Set([
  '—Ü–∏—Ñ—Ä–æ—Ç–µ—Ö','edg','eletek','erc','ilera','makefuture',
  '–º–µ–Ω—Ç–∞–ª','mental'
]);

// –¶–≤–µ—Ç–æ–≤—ã–µ –ø–∞–ª–∏—Ç—Ä—ã –¥–ª—è ABC/XYZ
const PALETTE_ABCV = { GOOD:'#00C853', MED:'#FFF176', BAD:'#EF5350' };
const PALETTE_ABCM = { GOOD:'#00C853', MED:'#FFF176', BAD:'#EF5350' };
const PALETTE_ABCK = { GOOD:'#00C853', MED:'#FFF176', BAD:'#EF5350' };
const PALETTE_XYZ  = { X:'#2E7D32', Y:'#FBC02D', Z:'#E53935' };
const PALETTE_COMBO = { X:'#66BB6A', Y:'#FFEE58', Z:'#EF5350' };

/***** ===================== –•–ï–õ–ü–ï–†–´ ===================== *****/
function findColumnIndexFlexible(headers, variants) {
  const norm = v => String(v ?? '').trim().toLowerCase();
  const low  = headers.map(norm);
  for (const v of variants) {
    const i = low.indexOf(norm(v));
    if (i >= 0) return i;
  }
  for (let i = 0; i < low.length; i++) {
    const cell = low[i];
    if (!cell) continue;
    for (const v of variants) {
      const needle = norm(v);
      if (needle && cell.includes(needle)) return i;
    }
  }
  return -1;
}
function readAll(sh) {
  const lr = sh.getLastRow(), lc = sh.getLastColumn();
  return (lr && lc) ? sh.getRange(1,1,lr,lc).getValues() : [];
}

function findLatestProcSheet(ss){
  const safePrefix = OUTPUT_PREFIX.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  const re = new RegExp('^' + safePrefix + '(\\d{4}-\\d{2}-\\d{2})$');
  let best = null, bestTs = -1;
  for (const sh of ss.getSheets()){
    const m = sh.getName().match(re);
    if (!m) continue;
    const ts = Date.parse(m[1] + 'T00:00:00Z');
    if (!isNaN(ts) && ts > bestTs) { bestTs = ts; best = sh; }
  }
  return best;
}
function parseTurnoverToFraction(raw){
  if (raw == null) return '';
  const s = String(raw).trim();
  if (s === '') return '';
  const num = Number(s.replace('%','').replace(',','.'));
  if (isNaN(num)) return '';
  if (s.includes('%')) return num/100;
  return num;
}
function applyAbcColoring_(sheet, firstDataRow, rowsCount) {
  if (rowsCount <= 0) return;
  const rK = sheet.getRange(firstDataRow, 13, rowsCount, 1); // ABC (–≤)
  const rL = sheet.getRange(firstDataRow, 14, rowsCount, 1); // ABC (–º)
  const rM = sheet.getRange(firstDataRow, 15, rowsCount, 1); // ABC (–∫)
  const rN = sheet.getRange(firstDataRow, 16, rowsCount, 1); // XYZ
  const rO = sheet.getRange(firstDataRow, 17, rowsCount, 1); // ABC(–º)-XYZ
  const rP = sheet.getRange(firstDataRow, 18, rowsCount, 1); // ABC(–≤)-XYZ

  const B = SpreadsheetApp.newConditionalFormatRule;
  const rules = [];
  const addABC = (range, palette) => {
    rules.push(B().whenTextStartsWith('A').setBackground(palette.GOOD).setRanges([range]).build());
    rules.push(B().whenTextStartsWith('–ê').setBackground(palette.GOOD).setRanges([range]).build());
    rules.push(B().whenTextStartsWith('B').setBackground(palette.MED).setRanges([range]).build());
    rules.push(B().whenTextStartsWith('–í').setBackground(palette.MED).setRanges([range]).build());
    rules.push(B().whenTextStartsWith('C').setBackground(palette.BAD).setRanges([range]).build());
    rules.push(B().whenTextStartsWith('–°').setBackground(palette.BAD).setRanges([range]).build());
  };
  addABC(rK, PALETTE_ABCV);
  addABC(rL, PALETTE_ABCM);
  addABC(rM, PALETTE_ABCK);

  const addXYZ = (range) => {
    rules.push(B().whenTextEqualTo('X').setBackground(PALETTE_XYZ.X).setRanges([range]).build());
    rules.push(B().whenTextEqualTo('Y').setBackground(PALETTE_XYZ.Y).setRanges([range]).build());
    rules.push(B().whenTextEqualTo('Z').setBackground(PALETTE_XYZ.Z).setRanges([range]).build());
  };
  addXYZ(rN);

  const addCombo = (range, pal) => {
    rules.push(B().whenTextContains('X').setBackground(pal.X).setRanges([range]).build());
    rules.push(B().whenTextContains('Y').setBackground(pal.Y).setRanges([range]).build());
  };
  addCombo(rO, PALETTE_COMBO);
  addCombo(rP, PALETTE_COMBO);

  sheet.setConditionalFormatRules(rules);
}

/***** ======== –ó–ê–ì–†–£–ó–ö–ê ABC-–î–ê–ù–ù–´–• (–¥–ª—è –∑–∞–∫—É–ø–∫–∏/–∑–∞–∫–∞–∑–æ–≤) ======== *****/
function loadABCMap(ss){
  const sheet = ss.getSheetByName(ABC_SHEET);
  const map = new Map();
  if (!sheet) return map;
  const data = readAll(sheet);
  if (data.length < 2) return map;
  const head = data[0];
  const cArt       = findColumnIndexFlexible(head, ['–∞—Ä—Ç–∏–∫—É–ª','artikul','sku','–∫–æ–¥']);
  const cABCv      = findColumnIndexFlexible(head, ['abc (–≤)','abc(–≤)','abc–≤']);
  const cABCm      = findColumnIndexFlexible(head, ['abc (–º)','abc(–º)','abc–º']);
  const cABCk      = findColumnIndexFlexible(head, ['abc (–∫)','abc(–∫)','abc–∫']);
  const cXYZ       = findColumnIndexFlexible(head, ['xyz']);
  const cABCM_XYZ  = findColumnIndexFlexible(head, ['abc(–º)-xyz','abc (–º)-xyz','abc –º-xyz']);
  const cABCV_XYZ  = findColumnIndexFlexible(head, ['abc(–≤)-xyz','abc (–≤)-xyz','abc –≤-xyz']);
  const cTurnover  = findColumnIndexFlexible(head, ['–æ–±–æ—Ä–æ—Ç–Ω—ñ—Å—Ç—å (–∫–æ–µ—Ñ.)','–æ–±–æ—Ä–æ—Ç–Ω–æ—Å—Ç—å','turnover']);
  for (let i=1;i<data.length;i++){
    const r = data[i];
    const art = cArt>=0 ? String(r[cArt] ?? '').trim() : '';
    if (!art) continue;
    map.set(art, {
      ABCv: cABCv>=0 ? String(r[cABCv] ?? '').trim() : '',
      ABCm: cABCm>=0 ? String(r[cABCm] ?? '').trim() : '',
      ABCk: cABCk>=0 ? String(r[cABCk] ?? '').trim() : '',
      XYZ : cXYZ>=0  ? String(r[cXYZ]  ?? '').trim() : '',
      ABCm_XYZ: cABCM_XYZ>=0 ? String(r[cABCM_XYZ] ?? '').trim() : '',
      ABCv_XYZ: cABCV_XYZ>=0 ? String(r[cABCV_XYZ] ?? '').trim() : '',
      Turnover: cTurnover>=0 ? parseTurnoverToFraction(r[cTurnover]) : ''
    });
  }
  return map;
}

/***** ====== –î–û–ü. –•–ï–õ–ü–ï–†–´ –î–õ–Ø –ù–û–ú–ï–ù–ö–õ–ê–¢–£–†–´ / –ö–ê–¢–ï–ì–û–†–ò–ô ====== *****/

// –ö–∞—Ä—Ç–∞ –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã: –∞—Ä—Ç–∏–∫—É–ª ‚Üí {name, category, supplier}
function loadNomenclatureMap_(ss) {
  const sh = ss.getSheetByName('–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞');
  const map = new Map();
  if (!sh) return map;
  const data = readAll(sh);
  if (data.length < 2) return map;

  const head = data[0];
  const cArt  = findColumnIndexFlexible(head, ['–∞—Ä—Ç–∏–∫—É–ª','artikul','sku','–∫–æ–¥']);
  const cName = findColumnIndexFlexible(head, ["—ñ–º'—è",'—ñ–º—è','–Ω–∞–∑–≤–∞','–Ω–∞–∑–≤–∞–Ω–∏–µ','name','—Ç–æ–≤–∞—Ä']);
  const cCat  = findColumnIndexFlexible(head, ['–∫–∞—Ç–µ–≥–æ—Ä—ñ—è','–∫–∞—Ç–µ–≥–æ—Ä–∏—è','category']);
  const cSup  = findColumnIndexFlexible(head, ['–ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫','–ø–æ—Å—Ç–∞–≤—â–∏–∫','supplier','vendor']);

  for (let i = 1; i < data.length; i++) {
    const r = data[i];
    const art = cArt >= 0 ? String(r[cArt] ?? '').trim() : '';
    if (!art) continue;
    map.set(art, {
      name:     cName >= 0 ? String(r[cName] ?? '').trim() : '',
      category: cCat  >= 0 ? String(r[cCat]  ?? '').trim() : '',
      supplier: cSup  >= 0 ? String(r[cSup]  ?? '').trim() : ''
    });
  }
  return map;
}

// –ò–Ω—Ñ–æ –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º —Å –ª–∏—Å—Ç–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: –∞—Ä—Ç–∏–∫—É–ª ‚Üí {name, model, id, supplier, link}
function buildCategoryInfoForCategories_(ss, categorySet) {
  const infoByArt = new Map();

  const NAME_CAND   = ["—ñ–º'—è",'—ñ–º—è','–Ω–∞–∑–≤–∞','–Ω–∞–∑–≤–∞–Ω–∏–µ','name','—Ç–æ–≤–∞—Ä'];
  const MODEL_CAND  = ['–º–æ–¥–µ–ª—å','model'];
  const ID_CAND     = ['id','—ñ–¥','–∫–æ–¥','–∫–æ–¥ —Ç–æ–≤–∞—Ä—É','product id'];
  const SUPP_CAND   = ['–ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫','–ø–æ—Å—Ç–∞–≤—â–∏–∫','supplier','vendor'];
  const LINK_CAND   = ['–ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–æ–≤–∞—Ä','–ø–æ—Å–∏–ª–∞–Ω–Ω—è','—Å—Å—ã–ª–∫–∞','link','url'];

  for (const catName of categorySet) {
    if (!catName) continue;
    const sh = ss.getSheetByName(catName);
    if (!sh) continue;

    const data = readAll(sh);
    if (data.length < 2) continue;
    const head = data[0];

    const cArt  = findColumnIndexFlexible(head, ['–∞—Ä—Ç–∏–∫—É–ª','artikul','sku']);
    if (cArt < 0) continue;
    const cName = findColumnIndexFlexible(head, NAME_CAND);
    const cModel= findColumnIndexFlexible(head, MODEL_CAND);
    const cId   = findColumnIndexFlexible(head, ID_CAND);
    const cSup  = findColumnIndexFlexible(head, SUPP_CAND);
    const cLink = findColumnIndexFlexible(head, LINK_CAND);

    for (let i = 1; i < data.length; i++) {
      const r = data[i];
      const art = String(r[cArt] ?? '').trim();
      if (!art) continue;
      infoByArt.set(art, {
        name:   cName >= 0 ? String(r[cName] ?? '').trim() : '',
        model:  cModel>= 0 ? String(r[cModel]?? '').trim() : '',
        id:     cId   >= 0 ? String(r[cId]   ?? '').trim() : '',
        supplier: cSup>= 0 ? String(r[cSup]  ?? '').trim() : '',
        link:   cLink >= 0 ? String(r[cLink] ?? '').trim() : ''
      });
    }
  }
  return infoByArt;
}

/***** ================= 1) –û–ë–©–ò–ô –°–ü–ò–°–û–ö –ó–ê–ö–£–ü–ö–ò ================= */
function createProcurementList_Fast() {
  const t0 = Date.now();
  const lock = LockService.getDocumentLock(); lock.tryLock(30000);
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();

    // –ö–ª—é—á–∏
    const ART_KEYS = ['–∞—Ä—Ç–∏–∫—É–ª','artikul','sku'];
    const QTY_KEYS = ['–∫—ñ–ª—å–∫—ñ—Å—Ç—å','–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ','quantity','qty'];
    const CAT_KEYS = ['–∫–∞—Ç–µ–≥–æ—Ä—ñ—è','–∫–∞—Ç–µ–≥–æ—Ä–∏—è','category'];
    const NAME_KEYS = ["—ñ–º'—è",'—ñ–º—è','–Ω–∞–∑–≤–∞','–Ω–∞–∑–≤–∞–Ω–∏–µ','name','—Ç–æ–≤–∞—Ä'];

    const NAME_CAND = ["—ñ–º'—è",'—ñ–º—è','–Ω–∞–∑–≤–∞','–Ω–∞–∑–≤–∞–Ω–∏–µ','name','—Ç–æ–≤–∞—Ä'];
    const MODEL_CAND = ['–º–æ–¥–µ–ª—å','model'];
    const ID_CAND = ['id','—ñ–¥','–∫–æ–¥','–∫–æ–¥ —Ç–æ–≤–∞—Ä—É','product id'];
    const SUPPLIER_CAND = ['–ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫','–ø–æ—Å—Ç–∞–≤—â–∏–∫','supplier','vendor'];
    const LINK_CAND = ['–ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–æ–≤–∞—Ä','–ø–æ—Å–∏–ª–∞–Ω–Ω—è','—Å—Å—ã–ª–∫–∞','link','url'];

    // 1) –°–∫–∞–Ω–∏—Ä—É–µ–º ¬´–ó–∞–ª_*¬ª ‚Äî —Å–æ–±–∏—Ä–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏ –∏–º–µ–Ω–∞
    const qtyBySheet = {};
    const firstCategoryByArt = new Map();
    const nameFromZals = new Map();
    const allArtSet = new Set();

    for (const sName of SRC_SHEETS) {
      const sh = ss.getSheetByName(sName);
      if (!sh) continue;
      const data = readAll(sh);
      if (data.length < 2) continue;
      const head = data[0];

      const cArt = findColumnIndexFlexible(head, ART_KEYS);
      const cQty = findColumnIndexFlexible(head, QTY_KEYS);
      const cCat = findColumnIndexFlexible(head, CAT_KEYS);
      const cName = findColumnIndexFlexible(head, NAME_KEYS);

      const map = new Map();
      for (let i=1;i<data.length;i++){
        const row = data[i];
        const art = cArt>=0 ? String(row[cArt] ?? '').trim() : '';
        if (!art) continue;

        const qty = cQty>=0 ? Number(row[cQty] ?? 0) : 0;
        map.set(art, (isNaN(qty)?0:qty));

        if (!firstCategoryByArt.has(art)) {
          const cat = cCat>=0 ? String(row[cCat] ?? '').trim() : '';
          if (cat) firstCategoryByArt.set(art, cat);
        }
        if (cName>=0) {
          const nm = String(row[cName] ?? '').trim();
          if (nm && !nameFromZals.has(art)) nameFromZals.set(art, nm);
        }
        allArtSet.add(art);
      }
      qtyBySheet[sName] = map;
    }
    if (allArtSet.size === 0) {
      SpreadsheetApp.getUi().alert('–í "–ó–∞–ª_*" –ª–∏—Å—Ç–∞—Ö –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞—Ä—Ç–∏–∫—É–ª—ñ–≤.');
      return;
    }

    const usedCategories = new Set(firstCategoryByArt.values());

    // 2) –ß–∏—Ç–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∏; –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞ ‚Üí —Å—Ç–∞–≤–∏–º ¬´–ù–∞—à —Ç–æ–≤–∞—Ä¬ª
    const infoByArt = new Map(); // art -> {name, model, id, supplier, link}
    for (const catName of usedCategories) {
      const catSheet = ss.getSheetByName(catName);
      if (!catSheet) continue;

      const data = readAll(catSheet);
      if (data.length < 2) continue;
      const head = data[0];

      const cArt = findColumnIndexFlexible(head, ['–∞—Ä—Ç–∏–∫—É–ª','artikul','sku']); if (cArt < 0) continue;
      const cName = findColumnIndexFlexible(head, NAME_CAND);
      const cModel = findColumnIndexFlexible(head, MODEL_CAND);
      const cId = findColumnIndexFlexible(head, ID_CAND);
      const cSupplier = findColumnIndexFlexible(head, SUPPLIER_CAND);
      const cLink = findColumnIndexFlexible(head, LINK_CAND);

      for (let i=1;i<data.length;i++){
        const r = data[i];
        const art = String(r[cArt] ?? '').trim();
        if (!art) continue;

        let supplier = cSupplier>=0 ? String(r[cSupplier] ?? '').trim() : '';
        if (!supplier) supplier = '–ù–∞—à —Ç–æ–≤–∞—Ä';

        infoByArt.set(art, {
          name:   cName>=0 ? String(r[cName] ?? '').trim() : '',
          model:  cModel>=0 ? String(r[cModel] ?? '').trim() : '',
          id:     cId>=0 ? String(r[cId] ?? '').trim() : '',
          supplier,
          link:   cLink>=0 ? String(r[cLink] ?? '').trim() : ''
        });
      }
    }

    // 3) ABC –∫–∞—Ä—Ç–∞
    const ABCMAP = loadABCMap(ss);

    // 4) –í—ã–≥—Ä—É–∑–∫–∞
    const apollo   = qtyBySheet['–ó–∞–ª_–ê–ø–ø–æ–ª–æ']   || new Map();
    const nagorka  = qtyBySheet['–ó–∞–ª_–ù–∞–≥–æ—Ä–∫–∞']  || new Map();
    const shevchen = qtyBySheet['–ó–∞–ª_–®–µ–≤—á–µ–Ω–∫–æ'] || new Map();
    const gorodok  = qtyBySheet['–ó–∞–ª_–ì–æ—Ä–æ–¥–æ–∫']  || new Map();

    const withSupplier = [];
    const ourOwn = [];

    for (const art of allArtSet) {
      const info = infoByArt.get(art) || {supplier:'–ù–∞—à —Ç–æ–≤–∞—Ä', name:'', model:'', id:'', link:''};

      const name = nameFromZals.get(art) || info.name || '';
      const ABC = ABCMAP.get(art) || {};
      const row = [
        art,
        name,
        apollo.get(art)   || 0,
        nagorka.get(art)  || 0,
        shevchen.get(art) || 0,
        gorodok.get(art)  || 0,
        info.model,
        info.id,
        info.supplier,
        info.link,
        ABC.ABCv || '',
        ABC.ABCm || '',
        ABC.ABCk || '',
        ABC.XYZ  || '',
        ABC.ABCm_XYZ || '',
        ABC.ABCv_XYZ || '',
        ABC.Turnover === '' ? '' : Number(ABC.Turnover),
        // –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ ‚Äî ¬´–¢–∞–∫¬ª, –µ—Å–ª–∏ ABC(–º) –∏–ª–∏ ABC(–≤) –≤ A/B
        (String(ABC.ABCm||'').toUpperCase().startsWith('A') || String(ABC.ABCm||'').toUpperCase().startsWith('B') ||
         String(ABC.ABCv||'').toUpperCase().startsWith('A') || String(ABC.ABCv||'').toUpperCase().startsWith('B')) ? '–¢–∞–∫' : '–ù—ñ'
      ];

      if (info.supplier === '–ù–∞—à —Ç–æ–≤–∞—Ä') ourOwn.push(row); else withSupplier.push(row);
    }

    // 5) –í—ã–≤–æ–¥ –Ω–∞ –Ω–æ–≤—ã–π –ª–∏—Å—Ç (—Å–Ω–∞—á–∞–ª–∞ —Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–º, –ø–æ—Ç–æ–º ¬´–ù–∞—à —Ç–æ–≤–∞—Ä¬ª)
    const outName = OUTPUT_PREFIX + Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd');
    let outSheet = ss.getSheetByName(outName);
    if (!outSheet) outSheet = ss.insertSheet(outName); else outSheet.clear();

    const HEADER = [
      '–ê—Ä—Ç–∏–∫—É–ª',"–Ü–º\'—è",'–ê–ø–ø–æ–ª–æ','–ù–∞–≥–æ—Ä–∫–∞','–®–µ–≤—á–µ–Ω–∫–æ','–ì–æ—Ä–æ–¥–æ–∫','–ú–æ–¥–µ–ª—å','ID','–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫','–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–æ–≤–∞—Ä',
      'ABC (–≤)','ABC (–º)','ABC (–∫)','XYZ','ABC(–º)-XYZ','ABC(–≤)-XYZ','–û–±–æ—Ä–æ—Ç–Ω—ñ—Å—Ç—å (–∫–æ–µ—Ñ.)','–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ'
    ];

    outSheet.getRange(1,1,1,HEADER.length).setValues([HEADER]).setFontWeight('bold');

    withSupplier.sort((a,b)=> a[8].localeCompare(b[8]) || a[1].localeCompare(b[1]) || a[0].localeCompare(b[0]));
    ourOwn.sort((a,b)=> a[1].localeCompare(b[1]) || a[0].localeCompare(b[0]));

    const out = withSupplier.concat(ourOwn);
    if (out.length){
      outSheet.getRange(2,1,out.length,HEADER.length).setValues(out);
      outSheet.getRange(2,17,out.length,1).setNumberFormat('0.00%'); // –æ–±–æ—Ä–æ—Ç–Ω—ñ—Å—Ç—å
      for (let c=1;c<=HEADER.length;c++) try{ outSheet.autoResizeColumn(c); }catch(_){}
      applyAbcColoring_(outSheet, 2, out.length);
    }

    Logger.log(`‚úÖ –ó–∞–∫—É–ø–∫–∞: ${out.length} —Ä—è–¥–∫—ñ–≤. –ß–∞—Å: ${((Date.now()-t0)/1000).toFixed(2)}s`);
  } finally {
    lock.releaseLock();
  }
}

/***** ================= 2) –ü–ï–†–ï–ú–ï–©–ï–ù–ò–Ø ================= */
const ROUTE_ORDER = [
  ['–®–µ–≤—á–µ–Ω–∫–æ','–ê–ø–ø–æ–ª–æ'],
  ['–®–µ–≤—á–µ–Ω–∫–æ','–ì–æ—Ä–æ–¥–æ–∫'],
  ['–®–µ–≤—á–µ–Ω–∫–æ','–ù–∞–≥–æ—Ä–∫–∞'],
  ['–ê–ø–ø–æ–ª–æ','–®–µ–≤—á–µ–Ω–∫–æ'],
  ['–ê–ø–ø–æ–ª–æ','–ì–æ—Ä–æ–¥–æ–∫'],
  ['–ê–ø–ø–æ–ª–æ','–ù–∞–≥–æ—Ä–∫–∞'],
  ['–ù–∞–≥–æ—Ä–∫–∞','–®–µ–≤—á–µ–Ω–∫–æ'],
  ['–ù–∞–≥–æ—Ä–∫–∞','–ì–æ—Ä–æ–¥–æ–∫'],
  ['–ù–∞–≥–æ—Ä–∫–∞','–ê–ø–ø–æ–ª–æ'],
  ['–ì–æ—Ä–æ–¥–æ–∫','–ù–∞–≥–æ—Ä–∫–∞'],
  ['–ì–æ—Ä–æ–¥–æ–∫','–®–µ–≤—á–µ–Ω–∫–æ'],
  ['–ì–æ—Ä–æ–¥–æ–∫','–ê–ø–ø–æ–ª–æ'],
];

function _planMovesForRow_(qtyByLoc){
  const keys = ['–ê–ø–ø–æ–ª–æ','–ù–∞–≥–æ—Ä–∫–∞','–®–µ–≤—á–µ–Ω–∫–æ','–ì–æ—Ä–æ–¥–æ–∫'];
  const qty = keys.map(k => Number(qtyByLoc[k] || 0));
  const total = qty.reduce((a,b)=>a+b,0);
  if (total <= 1) return []; // –Ω–µ—á–µ–≥–æ —Ä–∞–≤–Ω—è—Ç—å
  const n = qty.length;
  const base = Math.floor(total/n);
  let rem = total % n;

  const idxByQtyDesc = [...qty.keys()].sort((i,j)=> qty[j]-qty[i]);
  const target = new Array(n).fill(base);
  for (let t=0; t<rem; t++) target[idxByQtyDesc[t]]++;

  const surplus = [], deficit = [];
  for (let i=0;i<n;i++){
    const diff = qty[i]-target[i];
    if (diff>0) surplus.push({i,left:diff});
    else if (diff<0) deficit.push({i,need:-diff});
  }
  if (!surplus.length || !deficit.length) return [];
  const moves = [];
  let si=0, di=0;
  while (si<surplus.length && di<deficit.length){
    const take = Math.min(surplus[si].left, deficit[di].need);
    if (take>0){
      moves.push({from: keys[surplus[si].i], to: keys[deficit[di].i], count: take});
      surplus[si].left -= take;
      deficit[di].need -= take;
    }
    if (surplus[si].left===0) si++;
    if (deficit[di].need===0) di++;
  }
  return moves;
}

function createTransfers_FromLatestProcurement(){
  const ss = SpreadsheetApp.getActive();
  const src = findLatestProcSheet(ss);
  if (!src) { SpreadsheetApp.getUi().alert('–ù–µ –Ω–∞–π–¥–µ–Ω –ª–∏—Å—Ç: ' + OUTPUT_PREFIX + 'YYYY-MM-DD'); return; }

  const data = readAll(src);
  if (data.length < 2) { SpreadsheetApp.getUi().alert('–õ–∏—Å—Ç –∑–∞–∫—É–ø–∫–∏ –ø—É—Å—Ç–æ–π.'); return; }
  const head = data[0];

  const cArt  = findColumnIndexFlexible(head, ['–∞—Ä—Ç–∏–∫—É–ª','artikul','sku','–∫–æ–¥']);
  const cName = findColumnIndexFlexible(head, ["—ñ–º'—è",'—ñ–º—è','–Ω–∞–∑–≤–∞','–Ω–∞–∑–≤–∞–Ω–∏–µ','name','—Ç–æ–≤–∞—Ä']);
  const cSup  = findColumnIndexFlexible(head, ['–ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫','–ø–æ—Å—Ç–∞–≤—â–∏–∫','supplier','vendor']);
  const cLoc = {
    '–ê–ø–ø–æ–ª–æ'   : findColumnIndexFlexible(head, ['–∞–ø–ø–æ–ª–æ','apollo','–∞–ø–ø–æ–ªo','–∞–ø–ø–∞–ª–æ']),
    '–ù–∞–≥–æ—Ä–∫–∞'  : findColumnIndexFlexible(head, ['–Ω–∞–≥–æ—Ä–∫–∞','nagorka']),
    '–®–µ–≤—á–µ–Ω–∫–æ' : findColumnIndexFlexible(head, ['—à–µ–≤—á–µ–Ω–∫–æ','shevchenko']),
    '–ì–æ—Ä–æ–¥–æ–∫'  : findColumnIndexFlexible(head, ['–≥–æ—Ä–æ–¥–æ–∫','gorodok']),
  };
  if (cArt<0 || cSup<0) { SpreadsheetApp.getUi().alert('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ –∑–∞–∫—É–ø–∫–µ.'); return; }
  for (const k in cLoc) if (cLoc[k] < 0) { SpreadsheetApp.getUi().alert('–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –ª–æ–∫–∞—Ü–∏–∏: ' + k); return; }

  const routeMap = {}; // 'from|to' -> Map(art -> {name, cnt})
  const routeKey = (f,t)=> f+'|'+t;

  for (let r=1; r<data.length; r++){
    const row = data[r];
    const art  = String(row[cArt] ?? '').trim();
    if (!art) continue;
    const name = cName>=0 ? String(row[cName] ?? '').trim() : '';
    const sup  = String(row[cSup] ?? '').trim().toLowerCase();

    // –ù–µ –ø–µ—Ä–µ–º–µ—â–∞–µ–º ¬´–∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö¬ª
    if (SUPPLIERS_NON_MOVABLE.has(sup)) continue;

    // –ò—Å–∫–ª—é—á–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Å "–ü–ª—ñ–≤–∫–∞", "–ø–ª—ñ–≤–∫–∞", "–ø–ª–µ–Ω–∫–∞", "–ü–ª–µ–Ω–∫–∞" –≤ –∏–º–µ–Ω–∏
    const lowerName = name.toLowerCase();
    if (lowerName.includes('–ø–ª—ñ–≤–∫–∞') || lowerName.includes('–ø–ª–µ–Ω–∫–∞')) continue;

    const qtyByLoc = {
      '–ê–ø–ø–æ–ª–æ'  : Number(row[cLoc['–ê–ø–ø–æ–ª–æ']]   || 0),
      '–ù–∞–≥–æ—Ä–∫–∞' : Number(row[cLoc['–ù–∞–≥–æ—Ä–∫–∞']]  || 0),
      '–®–µ–≤—á–µ–Ω–∫–æ': Number(row[cLoc['–®–µ–≤—á–µ–Ω–∫–æ']] || 0),
      '–ì–æ—Ä–æ–¥–æ–∫' : Number(row[cLoc['–ì–æ—Ä–æ–¥–æ–∫']]  || 0),
    };

    const moves = _planMovesForRow_(qtyByLoc);
    for (const mv of moves){
      const key = routeKey(mv.from, mv.to);
      if (!routeMap[key]) routeMap[key] = new Map();
      const m = routeMap[key];
      if (!m.has(art)) m.set(art, {name, cnt:0});
      m.get(art).cnt += mv.count;
    }
  }

  const outName = MOVES_PREFIX + Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd');
  let out = ss.getSheetByName(outName);
  if (!out) out = ss.insertSheet(outName); else out.clear();

  let rowPtr = 1;
  for (const [from,to] of ROUTE_ORDER){
    const key = from+'|'+to;
    out.getRange(rowPtr,1).setValue(from + ' - ' + to).setFontWeight('bold'); rowPtr++;
    out.getRange(rowPtr,1,1,3).setValues([['–ê—Ä—Ç–∏–∫—É–ª',"–Ü–º'—è",'–ö-—Å—Ç—å']]).setFontWeight('bold'); rowPtr++;

    const m = routeMap[key] || new Map();
    if (m.size){
      const rows = [];
      for (const [art, obj] of m.entries()) rows.push([art, obj.name, obj.cnt]);
      rows.sort((a,b)=> a[1].localeCompare(b[1]) || String(a[0]).localeCompare(String(b[0])));
      out.getRange(rowPtr,1,rows.length,3).setValues(rows);
      rowPtr += rows.length;
    }
    rowPtr++;
  }
  for (let c=1;c<=3;c++) try{ out.autoResizeColumn(c); }catch(_){}
  SpreadsheetApp.getUi().alert('–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã –∏–∑: ' + src.getName());
}

/***** ============ 3) –õ–û–ö–ê–õ–¨–ù–´–ï –ó–ê–ö–ê–ó–´ –ü–û –ü–û–°–¢–ê–í–©–ò–ö–£ ============ *****/
function computeBuyPlan_Movable(qtyByLoc){
  // –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å: –ø–æ–∫—É–ø–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Å—Ç–∞—Ç–æ–∫ –¥–æ 1 —à—Ç/—Ç–æ—á–∫—É
  const locs = ['–ê–ø–ø–æ–ª–æ','–ù–∞–≥–æ—Ä–∫–∞','–®–µ–≤—á–µ–Ω–∫–æ','–ì–æ—Ä–æ–¥–æ–∫'];
  const now  = locs.map(k => Number(qtyByLoc[k]||0));
  const total = now.reduce((a,b)=>a+b,0);
  const needTotal = MIN_PER_LOC*locs.length;
  if (total >= needTotal) return {needByLoc:{}, totalBuy:0};

  // –¥–æ–±–∏–≤–∞–µ–º —Ç–µ —Ç–æ—á–∫–∏, –≥–¥–µ < 1, –ø–æ–∫–∞ –Ω–µ –∏–∑—Ä–∞—Å—Ö–æ–¥—É–µ–º –Ω–µ–¥–æ—Å—Ç–∞—á—É
  const need = {'–ê–ø–ø–æ–ª–æ':0,'–ù–∞–≥–æ—Ä–∫–∞':0,'–®–µ–≤—á–µ–Ω–∫–æ':0,'–ì–æ—Ä–æ–¥–æ–∫':0};
  let buy = needTotal - total;
  for (let i=0;i<locs.length;i++){
    const lack = Math.max(0, MIN_PER_LOC - now[i]);
    const add = Math.min(buy, lack);
    if (add>0){ need[locs[i]] += add; buy -= add; }
  }
  return {needByLoc:need, totalBuy:Object.values(need).reduce((a,b)=>a+b,0)};
}
function computeBuyPlan_NonMovable(qtyByLoc){
  // –ø–µ—Ä–µ–º–µ—â–∞—Ç—å –Ω–µ–ª—å–∑—è: –ø–æ–∫—É–ø–∞–µ–º –¥–µ—Ñ–∏—Ü–∏—Ç –Ω–∞ –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–µ
  const need = {};
  let sum = 0;
  for (const k of ['–ê–ø–ø–æ–ª–æ','–ù–∞–≥–æ—Ä–∫–∞','–®–µ–≤—á–µ–Ω–∫–æ','–ì–æ—Ä–æ–¥–æ–∫']){
    const n = Math.max(0, MIN_PER_LOC - Number(qtyByLoc[k]||0));
    need[k] = n; sum += n;
  }
  return {needByLoc:need, totalBuy:sum};
}

function createLocalSupplierOrder(supplierName){
  const ss = SpreadsheetApp.getActive();
  const src = findLatestProcSheet(ss);
  if (!src) { SpreadsheetApp.getUi().alert('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ª–∏—Å—Ç –∑–∞–∫—É–ø–∫–∏.'); return; }

  const data = readAll(src);
  if (data.length < 2) { SpreadsheetApp.getUi().alert('–õ–∏—Å—Ç –∑–∞–∫—É–ø–∫–∏ –ø–æ—Ä–æ–∂–Ω—ñ–π.'); return; }
  const head = data[0];

  const cSup   = findColumnIndexFlexible(head, ['–ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫','–ø–æ—Å—Ç–∞–≤—â–∏–∫','supplier','vendor']);
  const cName  = findColumnIndexFlexible(head, ["—ñ–º'—è",'—ñ–º—è','–Ω–∞–∑–≤–∞','–Ω–∞–∑–≤–∞–Ω–∏–µ','name','—Ç–æ–≤–∞—Ä']);
  const cArt   = findColumnIndexFlexible(head, ['–∞—Ä—Ç–∏–∫—É–ª','artikul','sku','–∫–æ–¥']);
  const cRec   = findColumnIndexFlexible(head, ['—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ','recommended']);
  const cModel = findColumnIndexFlexible(head, ['–º–æ–¥–µ–ª—å','model']);
  const cId    = findColumnIndexFlexible(head, ['id','—ñ–¥','–∫–æ–¥','–∫–æ–¥ —Ç–æ–≤–∞—Ä—É','product id']);
  const cLink  = findColumnIndexFlexible(head, ['–ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–æ–≤–∞—Ä','–ø–æ—Å–∏–ª–∞–Ω–Ω—è','—Å—Å—ã–ª–∫–∞','link','url']);
  const cLoc = {
    '–ê–ø–ø–æ–ª–æ'   : findColumnIndexFlexible(head, ['–∞–ø–ø–æ–ª–æ','apollo','–∞–ø–ø–æ–ªo','–∞–ø–ø–∞–ª–æ']),
    '–ù–∞–≥–æ—Ä–∫–∞'  : findColumnIndexFlexible(head, ['–Ω–∞–≥–æ—Ä–∫–∞','nagorka']),
    '–®–µ–≤—á–µ–Ω–∫–æ' : findColumnIndexFlexible(head, ['—à–µ–≤—á–µ–Ω–∫–æ','shevchenko']),
    '–ì–æ—Ä–æ–¥–æ–∫'  : findColumnIndexFlexible(head, ['–≥–æ—Ä–æ–¥–æ–∫','gorodok']),
  };
  if ([cSup,cName,cArt,cRec,cModel].some(i=>i<0)) {
    SpreadsheetApp.getUi().alert('–ù–µ –∑–Ω–∞–π–¥–µ–Ω—ñ –∫–ª—é—á–æ–≤—ñ –∫–æ–ª–æ–Ω–∫–∏ —É –∑–∞–∫—É–ø—Ü—ñ.');
    return;
  }
  for (const k in cLoc) if (cLoc[k] < 0) { SpreadsheetApp.getUi().alert('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ —Ç–æ—á–∫–∏: '+k); return; }

  const ABCMAP = loadABCMap(ss);

  const wanted = String(supplierName).trim().toLowerCase();
  const rows = [];
  for (let r=1; r<data.length; r++){
    const row = data[r];
    const sup = String(row[cSup]||'').trim().toLowerCase();
    if (sup !== wanted) continue;
    if (String(row[cRec]||'').trim().toLowerCase() !== '—Ç–∞–∫') continue;

    const qtyByLoc = {
      '–ê–ø–ø–æ–ª–æ':   Number(row[cLoc['–ê–ø–ø–æ–ª–æ']]||0),
      '–ù–∞–≥–æ—Ä–∫–∞':  Number(row[cLoc['–ù–∞–≥–æ—Ä–∫–∞']]||0),
      '–®–µ–≤—á–µ–Ω–∫–æ': Number(row[cLoc['–®–µ–≤—á–µ–Ω–∫–æ']]||0),
      '–ì–æ—Ä–æ–¥–æ–∫':  Number(row[cLoc['–ì–æ—Ä–æ–¥–æ–∫']]||0),
    };

    const plan = SUPPLIERS_MOVABLE.has(wanted)
      ? computeBuyPlan_Movable(qtyByLoc)
      : computeBuyPlan_NonMovable(qtyByLoc);

    if (plan.totalBuy <= 0) continue;

    const art   = String(row[cArt]||'').trim();
    const name  = String(row[cName]||'').trim();
    const model = String(row[cModel]||'').trim();
    const id    = cId>=0 ? String(row[cId]||'').trim() : '';
    const link  = cLink>=0 ? String(row[cLink]||'').trim() : '';

    const abc = ABCMAP.get(art) || {};
    rows.push({
      art,name,model,id,link,
      needByLoc: plan.needByLoc,
      ABCv: abc.ABCv||'', ABCm: abc.ABCm||'', ABCk: abc.ABCk||'',
      XYZ: abc.XYZ||'', ABCm_XYZ: abc.ABCm_XYZ||'', ABCv_XYZ: abc.ABCv_XYZ||'',
      Turnover: (abc.Turnover===''? '' : Number(abc.Turnover))
    });
  }

  if (!rows.length){
    SpreadsheetApp.getUi().alert('–ù–µ–º–∞—î –ø–æ–∑–∏—Ü—ñ–π –¥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –¥–ª—è "'+supplierName+'".');
    return;
  }

  // ===== —Å–æ–∑–¥–∞—ë–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –∑–∞–∫–∞–∑–∞ =====
  const ts = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyy-MM-dd HH:mm");
  const title = '–ó–∞–∫–∞–∑ ' + supplierName + ' ' + ts + ' R';
  const newSS = SpreadsheetApp.create(title);
  if (ORDERS_FOLDER_ID){
    try{
      const file = DriveApp.getFileById(newSS.getId());
      const folder = DriveApp.getFolderById(ORDERS_FOLDER_ID);
      folder.addFile(file);
      DriveApp.getRootFolder().removeFile(file);
    }catch(e){ Logger.log('Move order file error: ' + e.message); }
  }

  const main = newSS.getActiveSheet();
  main.setName('–ó–≤–µ–¥–µ–Ω–∏–π');

  const HEADERS = [
    '–ê—Ä—Ç–∏–∫—É–ª',"–Ü–º\'—è",'–ú–æ–¥–µ–ª—å','ID','–ü–æ—Å–∏–ª–∞–Ω–Ω—è',
    FOP_HEADER_MAP['–ê–ø–ø–æ–ª–æ'],
    FOP_HEADER_MAP['–ù–∞–≥–æ—Ä–∫–∞'],
    FOP_HEADER_MAP['–®–µ–≤—á–µ–Ω–∫–æ'],
    FOP_HEADER_MAP['–ì–æ—Ä–æ–¥–æ–∫'],
    '–†–∞–∑–æ–º, —à—Ç',
    'ABC (–≤)','ABC (–º)','ABC (–∫)','XYZ','ABC(–º)-XYZ','ABC(–≤)-XYZ','–û–±–æ—Ä–æ—Ç–Ω—ñ—Å—Ç—å (–∫–æ–µ—Ñ.)'
  ];
  main.getRange(1,1,1,HEADERS.length).setValues([HEADERS]).setFontWeight('bold');

  const out = [];
  for (const r of rows){
    const a = r.needByLoc['–ê–ø–ø–æ–ª–æ']   || 0;
    const n = r.needByLoc['–ù–∞–≥–æ—Ä–∫–∞']  || 0;
    const s = r.needByLoc['–®–µ–≤—á–µ–Ω–∫–æ'] || 0;
    const g = r.needByLoc['–ì–æ—Ä–æ–¥–æ–∫']  || 0;
    const qty = a+n+s+g;
    out.push([
      r.art, r.name, r.model, r.id, r.link,
      a, n, s, g, qty,
      r.ABCv, r.ABCm, r.ABCk, r.XYZ, r.ABCm_XYZ, r.ABCv_XYZ, r.Turnover
    ]);
  }
  out.sort((A,B)=> A[1].localeCompare(B[1]) || String(A[0]).localeCompare(String(B[0])));
  main.getRange(2,1,out.length,HEADERS.length).setValues(out);
  main.getRange(2,17,out.length,1).setNumberFormat('0.00%');
  for (let c=1;c<=HEADERS.length;c++) try{ main.autoResizeColumn(c); }catch(_){}
  applyAbcColoring_(main, 2, out.length);

  const LOC_COL_IDX = { '–ê–ø–ø–æ–ª–æ':6, '–ù–∞–≥–æ—Ä–∫–∞':7, '–®–µ–≤—á–µ–Ω–∫–æ':8, '–ì–æ—Ä–æ–¥–æ–∫':9 };
  for (const loc of ['–ê–ø–ø–æ–ª–æ','–ù–∞–≥–æ—Ä–∫–∞','–®–µ–≤—á–µ–Ω–∫–æ','–ì–æ—Ä–æ–¥–æ–∫']){
    const per = out.filter(r => Number(r[LOC_COL_IDX[loc]-1]) > 0);
    const sh = newSS.insertSheet((FOP_HEADER_MAP[loc]||loc).split(' ‚Äî ')[1]);
    sh.getRange(1,1,1,HEADERS.length).setValues([HEADERS]).setFontWeight('bold');
    if (per.length){
      sh.getRange(2,1,per.length,HEADERS.length).setValues(per);
      sh.getRange(2,17,per.length,1).setNumberFormat('0.00%');
      for (let c=1;c<=HEADERS.length;c++) try{ sh.autoResizeColumn(c); }catch(_){}
      applyAbcColoring_(sh, 2, per.length);
    }
  }

  SpreadsheetApp.getUi().alert('–°—Ç–≤–æ—Ä–µ–Ω–æ —Ñ–∞–π–ª: ' + title);
}

/***** ============ 4) –ó–ê–ö–£–ü–ö–ê –ü–û –ü–†–û–î–ê–ñ–ê–ú (–ù–û–í–ê –õ–û–ì–ò–ö–ê) ============ *****/

/**
 * –í–∞—Ä–∏–∞–Ω—Ç 1: –ó–∞–∫—É–ø–∫–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º (–∑–∞–≥–∞–ª—å–Ω–∞)
 * –ê–∫—Ç–∏–≤–Ω—ã–π –ª–∏—Å—Ç ‚Äî –ª–∏—Å—Ç –ø—Ä–æ–¥–∞–∂.
 * B:B ‚Äî –ø—Ä–æ–¥–∞–Ω–æ, E:E ‚Äî –∞—Ä—Ç–∏–∫—É–ª.
 */
function createProcurementFromSales_Total() {
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getActiveSheet();
  const data = readAll(sh);
  if (data.length < 2) {
    SpreadsheetApp.getUi().alert('–õ–∏—Å—Ç –ø—Ä–æ–¥–∞–∂ –ø–æ—Ä–æ–∂–Ω—ñ–π.');
    return;
  }

  // 0-based –∏–Ω–¥–µ–∫—Å—ã: B=2‚Üí1, E=5‚Üí4
  const COL_QTY = 1;
  const COL_ART = 4;

  const soldMap = new Map(); // art -> total qty

  for (let r = 1; r < data.length; r++) {
    const row = data[r];
    const art = String(row[COL_ART] ?? '').trim();
    if (!art) continue;
    const qty = Number(row[COL_QTY] ?? 0);
    if (!qty || isNaN(qty)) continue;
    soldMap.set(art, (soldMap.get(art) || 0) + qty);
  }

  if (!soldMap.size) {
    SpreadsheetApp.getUi().alert('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—Ä–æ–¥–∞–∂ –∑ –∞—Ä—Ç–∏–∫—É–ª–æ–º (B/E).');
    return;
  }

  const nomMap = loadNomenclatureMap_(ss);
  const usedCategories = new Set();
  for (const art of soldMap.keys()) {
    const info = nomMap.get(art);
    if (info && info.category) usedCategories.add(info.category);
  }

  const catInfo = buildCategoryInfoForCategories_(ss, usedCategories);
  const ABCMAP = loadABCMap(ss);

  const rows = [];
  for (const [art, qty] of soldMap.entries()) {
    const nom  = nomMap.get(art) || {};
    const cat  = nom.category || '';
    const catRow = catInfo.get(art) || {};
    const abc  = ABCMAP.get(art) || {};

    const name = catRow.name || nom.name || '';
    const supplier = (catRow.supplier || nom.supplier || '–ù–∞—à —Ç–æ–≤–∞—Ä');

    rows.push([
      art,
      name,
      cat,
      qty,
      catRow.model || '',
      catRow.id || '',
      supplier,
      catRow.link || '',
      abc.ABCv || '',
      abc.ABCm || '',
      abc.ABCk || '',
      abc.XYZ  || '',
      abc.ABCm_XYZ || '',
      abc.ABCv_XYZ || '',
      abc.Turnover === '' ? '' : Number(abc.Turnover)
    ]);
  }

  rows.sort((a,b) =>
    String(a[6]||'').localeCompare(String(b[6]||'')) ||   // –ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫
    String(a[2]||'').localeCompare(String(b[2]||'')) ||   // –ö–∞—Ç–µ–≥–æ—Ä—ñ—è
    String(a[1]||'').localeCompare(String(b[1]||'')) ||   // –Ü–º'—è
    String(a[0]||'').localeCompare(String(b[0]||''))      // –ê—Ä—Ç–∏–∫—É–ª
  );

  const outName = '–ó–∞–∫—É–ø–∫–∞_–ø–æ_–ø—Ä–æ–¥–∞–∂–∞–º_–∑–∞–≥–∞–ª—å–Ω–∞_' +
    Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd');
  let outSheet = ss.getSheetByName(outName);
  if (!outSheet) outSheet = ss.insertSheet(outName); else outSheet.clear();

  const HEADER = [
    '–ê—Ä—Ç–∏–∫—É–ª',"–Ü–º\'—è",'–ö–∞—Ç–µ–≥–æ—Ä—ñ—è','–ü—Ä–æ–¥–∞–Ω–æ, —à—Ç',
    '–ú–æ–¥–µ–ª—å','ID','–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫','–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–æ–≤–∞—Ä',
    'ABC (–≤)','ABC (–º)','ABC (–∫)','XYZ',
    'ABC(–º)-XYZ','ABC(–≤)-XYZ','–û–±–æ—Ä–æ—Ç–Ω—ñ—Å—Ç—å (–∫–æ–µ—Ñ.)'
  ];

  outSheet.getRange(1,1,1,HEADER.length).setValues([HEADER]).setFontWeight('bold');
  if (rows.length) {
    outSheet.getRange(2,1,rows.length,HEADER.length).setValues(rows);
    // –û–±–æ—Ä–æ—Ç–Ω—ñ—Å—Ç—å ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–æ–ª–±–µ—Ü
    outSheet.getRange(2,15,rows.length,1).setNumberFormat('0.00%');
    for (let c=1;c<=HEADER.length;c++) try { outSheet.autoResizeColumn(c); } catch(_) {}
    // ABC-–∫–æ–ª–æ–Ω–∫–∏ ‚Äî K/L/M/N/O/P -> –∑–¥–µ—Å—å: 9‚Äì14
    applyAbcColoring_(outSheet, 2, rows.length);
  }

  SpreadsheetApp.getUi().alert('–ó–∞–∫—É–ø–∫–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º (–∑–∞–≥–∞–ª—å–Ω–∞) —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–∞: ' + outName);
}

/**
 * –í–∞—Ä–∏–∞–Ω—Ç 2: –ó–∞–∫—É–ø–∫–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º (–ø–æ —Ç–æ—á–∫–∞—Ö)
 * –ê–∫—Ç–∏–≤–Ω—ã–π –ª–∏—Å—Ç ‚Äî –ª–∏—Å—Ç –ø—Ä–æ–¥–∞–∂.
 * –î–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ —Å–≤–æ–∏ –ø–∞—Ä—ã –∫–æ–ª–æ–Ω–æ–∫:
 *   –®–µ–≤—á–µ–Ω–∫–æ: I (–ö—ñ–ª—å–∫—ñ—Å—Ç—å) / L (–ê—Ä—Ç–∏–∫—É–ª)
 *   –ù–∞–≥–æ—Ä–∫–∞ : P (–ö—ñ–ª—å–∫—ñ—Å—Ç—å) / S (–ê—Ä—Ç–∏–∫—É–ª)
 *   –ê–ø–ø–æ–ª–æ  : X (–ö—ñ–ª—å–∫—ñ—Å—Ç—å) / Z (–ê—Ä—Ç–∏–∫—É–ª)
 *   –ì–æ—Ä–æ–¥–æ–∫ : AD (–ö—ñ–ª—å–∫—ñ—Å—Ç—å) / AG (–ê—Ä—Ç–∏–∫—É–ª)
 */
function createProcurementFromSales_ByPoints() {
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getActiveSheet();
  const data = readAll(sh);
  if (data.length < 2) {
    SpreadsheetApp.getUi().alert('–õ–∏—Å—Ç –ø—Ä–æ–¥–∞–∂ –ø–æ—Ä–æ–∂–Ω—ñ–π.');
    return;
  }

  // 0-based –∏–Ω–¥–µ–∫—Å—ã –∫–æ–ª–æ–Ω–æ–∫ (—Å–º. —Ç–≤–æ—é —Ä–∞—Å–∫–ª–∞–¥–∫—É)
  const COLS_BY_LOC = {
    '–®–µ–≤—á–µ–Ω–∫–æ': { qty: 8,  art: 11 }, // I / L
    '–ù–∞–≥–æ—Ä–∫–∞' : { qty: 15, art: 18 }, // P / S
    '–ê–ø–ø–æ–ª–æ'  : { qty: 23, art: 25 }, // X / Z
    '–ì–æ—Ä–æ–¥–æ–∫' : { qty: 29, art: 32 }  // AD / AG
  };

  // art -> {–®–µ–≤—á–µ–Ω–∫–æ, –ù–∞–≥–æ—Ä–∫–∞, –ê–ø–ø–æ–ª–æ, –ì–æ—Ä–æ–¥–æ–∫}
  const soldByArt = new Map();

  for (let r = 1; r < data.length; r++) {
    const row = data[r];

    for (const loc of Object.keys(COLS_BY_LOC)) {
      const cfg = COLS_BY_LOC[loc];
      const art = String(row[cfg.art] ?? '').trim();
      if (!art) continue;
      const qty = Number(row[cfg.qty] ?? 0);
      if (!qty || isNaN(qty)) continue;

      if (!soldByArt.has(art)) {
        soldByArt.set(art, { '–®–µ–≤—á–µ–Ω–∫–æ':0, '–ù–∞–≥–æ—Ä–∫–∞':0, '–ê–ø–ø–æ–ª–æ':0, '–ì–æ—Ä–æ–¥–æ–∫':0 });
      }
      const rec = soldByArt.get(art);
      rec[loc] += qty;
    }
  }

  if (!soldByArt.size) {
    SpreadsheetApp.getUi().alert('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—Ä–æ–¥–∞–∂ –ø–æ —Ç–æ—á–∫–∞—Ö (I/L, P/S, X/Z, AD/AG).');
    return;
  }

  const nomMap = loadNomenclatureMap_(ss);
  const usedCategories = new Set();
  for (const art of soldByArt.keys()) {
    const info = nomMap.get(art);
    if (info && info.category) usedCategories.add(info.category);
  }
  const catInfo = buildCategoryInfoForCategories_(ss, usedCategories);
  const ABCMAP = loadABCMap(ss);

  const rows = [];
  for (const [art, locObj] of soldByArt.entries()) {
    const nom  = nomMap.get(art) || {};
    const cat  = nom.category || '';
    const catRow = catInfo.get(art) || {};
    const abc  = ABCMAP.get(art) || {};

    const name = catRow.name || nom.name || '';
    const supplier = (catRow.supplier || nom.supplier || '–ù–∞—à —Ç–æ–≤–∞—Ä');

    const qShev = locObj['–®–µ–≤—á–µ–Ω–∫–æ'] || 0;
    const qNag  = locObj['–ù–∞–≥–æ—Ä–∫–∞']  || 0;
    const qAp   = locObj['–ê–ø–ø–æ–ª–æ']   || 0;
    const qGor  = locObj['–ì–æ—Ä–æ–¥–æ–∫']  || 0;
    const qTotal= qShev + qNag + qAp + qGor;

    rows.push([
      art,
      name,
      cat,
      qShev,
      qNag,
      qAp,
      qGor,
      qTotal,
      catRow.model || '',
      catRow.id || '',
      supplier,
      catRow.link || '',
      abc.ABCv || '',
      abc.ABCm || '',
      abc.ABCk || '',
      abc.XYZ  || '',
      abc.ABCm_XYZ || '',
      abc.ABCv_XYZ || '',
      abc.Turnover === '' ? '' : Number(abc.Turnover)
    ]);
  }

  rows.sort((a,b) =>
    String(a[10]||'').localeCompare(String(b[10]||'')) ||   // –ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫
    String(a[2] ||'').localeCompare(String(b[2] ||'')) ||   // –ö–∞—Ç–µ–≥–æ—Ä—ñ—è
    String(a[1] ||'').localeCompare(String(b[1] ||'')) ||   // –Ü–º'—è
    String(a[0] ||'').localeCompare(String(b[0] ||''))      // –ê—Ä—Ç–∏–∫—É–ª
  );

  const outName = '–ó–∞–∫—É–ø–∫–∞_–ø–æ_–ø—Ä–æ–¥–∞–∂–∞–º_–ø–æ_—Ç–æ—á–∫–∞—Ö_' +
    Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd');
  let outSheet = ss.getSheetByName(outName);
  if (!outSheet) outSheet = ss.insertSheet(outName); else outSheet.clear();

  const HEADER = [
    '–ê—Ä—Ç–∏–∫—É–ª',"–Ü–º\'—è",'–ö–∞—Ç–µ–≥–æ—Ä—ñ—è',
    '–®–µ–≤—á–µ–Ω–∫–æ, —à—Ç','–ù–∞–≥–æ—Ä–∫–∞, —à—Ç','–ê–ø–ø–æ–ª–æ, —à—Ç','–ì–æ—Ä–æ–¥–æ–∫, —à—Ç','–†–∞–∑–æ–º, —à—Ç',
    '–ú–æ–¥–µ–ª—å','ID','–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫','–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–æ–≤–∞—Ä',
    'ABC (–≤)','ABC (–º)','ABC (–∫)','XYZ',
    'ABC(–º)-XYZ','ABC(–≤)-XYZ','–û–±–æ—Ä–æ—Ç–Ω—ñ—Å—Ç—å (–∫–æ–µ—Ñ.)'
  ];

  outSheet.getRange(1,1,1,HEADER.length).setValues([HEADER]).setFontWeight('bold');
  if (rows.length) {
    outSheet.getRange(2,1,rows.length,HEADER.length).setValues(rows);
    outSheet.getRange(2,19,rows.length,1).setNumberFormat('0.00%'); // –æ–±–æ—Ä–æ—Ç–Ω—ñ—Å—Ç—å
    for (let c=1;c<=HEADER.length;c++) try { outSheet.autoResizeColumn(c); } catch(_) {}
    applyAbcColoring_(outSheet, 2, rows.length);
  }

  SpreadsheetApp.getUi().alert('–ó–∞–∫—É–ø–∫–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º (–ø–æ —Ç–æ—á–∫–∞—Ö) —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–∞: ' + outName);
}

/***** ====================== –ú–ï–ù–Æ ====================== *****/

/**
 * –û—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–µ–Ω—é –∑–∞–∫—É–ø–æ–∫.
 * –ï—ë –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –∏ –æ–±—ã—á–Ω—ã–π onOpen, –∏ installable-—Ç—Ä–∏–≥–≥–µ—Ä.
 */
function addZakupMenu_() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('üßæ –ó–∞–∫—É–ø–∫–∏')
    .addItem('1) –°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –∑–∞–≥–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫', 'createProcurementList_Fast')
    .addItem('2) –°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è', 'createTransfers_FromLatestProcurement')
    .addSeparator()
    .addSubMenu(ui.createMenu('3) –õ–æ–∫–∞–ª—å–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è')
      .addItem('ArtMobile',  'order_ArtMobile')
      .addItem('Ncase',      'order_Ncase')
      .addItem('–ù–∞—à —Ç–æ–≤–∞—Ä',  'order_NashTovar')
      .addItem('–ì–ú–°',        'order_GMS')
      .addSeparator()
      .addItem('–¶–∏—Ñ—Ä–æ—Ç–µ—Ö',   'order_Cyfrotech')
      .addItem('EDG',        'order_EDG')
      .addItem('Eletek',     'order_Eletek')
      .addItem('ERC',        'order_ERC')
      .addItem('iLera',      'order_iLera')
      .addItem('MakeFuture', 'order_MakeFuture')
      .addItem('ColorWay',   'order_ColorWay')
      .addItem('–ú–µ–Ω—Ç–∞–ª',     'order_Mental')
    )
    .addSeparator()
    .addItem('4) –ó–∞–∫—É–ø–∫–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º (–∑–∞–≥–∞–ª—å–Ω–∞)', 'createProcurementFromSales_Total')
    .addItem('5) –ó–∞–∫—É–ø–∫–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º (–ø–æ —Ç–æ—á–∫–∞—Ö)', 'createProcurementFromSales_ByPoints')
    .addToUi();
}

/**
 * –û–±—ã—á–Ω—ã–π onOpen (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–±–∏—Ç –¥—Ä—É–≥–∏–º —Å–∫—Ä–∏–ø—Ç–æ–º ‚Äî —ç—Ç–æ –Ω–∞–º —É–∂–µ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ).
 */
function onOpen(e){
  addZakupMenu_();
}

// –û–±—ë—Ä—Ç–∫–∏ –ø–æ–¥ –ø—É–Ω–∫—Ç—ã –º–µ–Ω—é
function order_ArtMobile(){  createLocalSupplierOrder('ArtMobile'); }
function order_Ncase(){      createLocalSupplierOrder('Ncase'); }
function order_NashTovar(){  createLocalSupplierOrder('–ù–∞—à —Ç–æ–≤–∞—Ä'); }
function order_GMS(){        createLocalSupplierOrder('–ì–ú–°'); }
function order_Cyfrotech(){  createLocalSupplierOrder('–¶–∏—Ñ—Ä–æ—Ç–µ—Ö'); }
function order_EDG(){        createLocalSupplierOrder('EDG'); }
function order_Eletek(){     createLocalSupplierOrder('Eletek'); }
function order_ERC(){        createLocalSupplierOrder('ERC'); }
function order_iLera(){      createLocalSupplierOrder('iLera'); }
function order_MakeFuture(){ createLocalSupplierOrder('MakeFuture'); }
function order_ColorWay(){   createLocalSupplierOrder('ColorWay'); }
function order_Mental(){     createLocalSupplierOrder('–ú–µ–Ω—Ç–∞–ª'); }

/* =====================================================================
 *   –î–û–ë–ê–í–ö–ê: –ñ–ï–õ–ï–ó–ù–´–ô –¢–†–ò–ì–ì–ï–† –î–õ–Ø –ú–ï–ù–Æ ¬´üßæ –ó–∞–∫—É–ø–∫–∏¬ª
 * =====================================================================*/

/**
 * Installable onOpen-—Ç—Ä–∏–≥–≥–µ—Ä: –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –¥—Ä—É–≥–∏—Ö onOpen –≤ –ø—Ä–æ–µ–∫—Ç–µ.
 * –ü—Ä–æ—Å—Ç–æ —Ä–∏—Å—É–µ—Ç –Ω–∞—à–µ –º–µ–Ω—é.
 */
function onOpen_forced_Zakup_(e) {
  try {
    addZakupMenu_();
  } catch (err) {
    console.error('onOpen_forced_Zakup_ error:', err);
  }
}

/**
 * –£—Å—Ç–∞–Ω–æ–≤–∫–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ –º–µ–Ω—é.
 * –ó–∞–ø—É—Å–∫–∞–µ—à—å –≠–¢–£ —Ñ—É–Ω–∫—Ü–∏—é –æ–¥–∏–Ω —Ä–∞–∑ —Ä—É–∫–∞–º–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ —Å–∫—Ä–∏–ø—Ç–æ–≤.
 */
function installZakupMenuTriggers() {
  const ss = SpreadsheetApp.getActive();
  const ssId = ss.getId();

  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(tr => {
    const fn = tr.getHandlerFunction();
    if (fn === 'onOpen_forced_Zakup_') {
      ScriptApp.deleteTrigger(tr);
    }
  });

  ScriptApp.newTrigger('onOpen_forced_Zakup_')
    .forSpreadsheet(ssId)
    .onOpen()
    .create();
}
–ü–æ–¥—Å—á–µ—Ç –º–∞—Ä–∂–∏ –Ω–∞ –ª–∏—Å—Ç–∞—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π - –∑–∞–±—ã–ª –∑–∞—á–µ–º –¥–µ–ª–∞–ª —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
/** PAYALNYA ‚Äî Margin Formulas (Active Sheet) v3.1
 * - –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–π –ª–∏—Å—Ç. –ù–∏—á–µ–≥–æ –Ω–µ —Å–æ–∑–¥–∞—ë–º/–Ω–µ –¥–≤–∏–≥–∞–µ–º.
 * - –ò—â–µ–º 6 –±–ª–æ–∫–æ–≤ –ø–æ —à–∞–ø–∫–∞–º: –ù–∞–∑–≤–∞ / –ö—ñ–ª—å–∫—ñ—Å—Ç—å / –£—Å—å–æ–≥–æ / –ê—Ä—Ç–∏–∫—É–ª
 * - –î–ª—è –ö–ê–ñ–î–û–ô –ø—É—Å—Ç–æ–π —è—á–µ–π–∫–∏ –º–∞—Ä–∂–∏ —Å—Ç–∞–≤–∏–º –û–î–ù–£ –æ–±—ã—á–Ω—É—é —Ñ–æ—Ä–º—É–ª—É (–ê1), –±–µ–∑ –º–∞—Å—Å–∏–≤–æ–≤.
 * - –§–æ—Ä–º—É–ª–∞: =IF(OR(SKU="";SKU="‚ùå –ù–ï –ó–ù–ê–ô–î–ï–ù–û");""; SUM - QTY * IFERROR(VLOOKUP(SKU; –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞!$A:$E; 5; FALSE); IFERROR(VLOOKUP(NAME; –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞!$A:$E; 5; FALSE); "")))
 * - –°—Ç—Ä–æ–∫–∞ 2 –ø–æ–¥ –º–∞—Ä–∂–µ–π: –µ—Å–ª–∏ –ø—É—Å—Ç–æ –∏ –±–µ–∑ —Ñ–æ—Ä–º—É–ª—ã ‚Äî —Å—Ç–∞–≤–∏–º =SUM(<–∫–æ–ª–æ–Ω–∫–∞>3:<–∫–æ–ª–æ–Ω–∫–∞>)
 */

const PAYALNYA_MARGIN_FORMULA_LOCAL = (() => {
  const CFG = {
    NOMEN_SHEET: '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞',                       // A: –ê—Ä—Ç–∏–∫—É–ª, E: –¶—ñ–Ω–∞ –∑–∞–∫—É–ø—ñ–≤–ª—ñ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
    HEADERS: { NAME: '–ù–∞–∑–≤–∞', QTY: '–ö—ñ–ª—å–∫—ñ—Å—Ç—å', SUM: '–£—Å—å–æ–≥–æ', SKU: '–ê—Ä—Ç–∏–∫—É–ª' },
    MARGIN_TITLES: [
      '–ú–∞—Ä–∂–∞ (–æ–±—â)','–ú–∞—Ä–∂–∞ (–®–µ–≤—á–µ–Ω–∫–æ)','–ú–∞—Ä–∂–∞ (–ù–∞–≥–æ—Ä–∫–∞)',
      '–ú–∞—Ä–∂–∞ (–ê–ø–ø–æ–ª–æ)','–ú–∞—Ä–∂–∞ (–ì–æ—Ä–æ–¥–æ–∫)','–ú–∞—Ä–∂–∞ (–Ü–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω)'
    ],
    START_ROW: 3,
    END_ROW_HARD: 300,
    NOT_FOUND_TOKEN: '‚ùå –ù–ï –ó–ù–ê–ô–î–ï–ù–û'
  };

  // ===== utils
  const A1 = (row, col1) => {
    let c = col1, s = '';
    while (c > 0) { const m = (c - 1) % 26; s = String.fromCharCode(65 + m) + s; c = Math.floor((c - 1) / 26); }
    return s + row;
  };

  function findBlocks_(headers){
    const idxs = { name: [], qty: [], sum: [], sku: [] };
    headers.forEach((h, i) => {
      const t = String(h).trim();
      if (t === CFG.HEADERS.NAME) idxs.name.push(i);
      if (t === CFG.HEADERS.QTY)  idxs.qty.push(i);
      if (t === CFG.HEADERS.SUM)  idxs.sum.push(i);
      if (t === CFG.HEADERS.SKU)  idxs.sku.push(i);
    });
    const n = Math.min(idxs.name.length, idxs.qty.length, idxs.sum.length, idxs.sku.length);
    const blocks = [];
    for (let k=0;k<n;k++){
      blocks.push({ nameCol0: idxs.name[k], qtyCol0: idxs.qty[k], sumCol0: idxs.sum[k], skuCol0: idxs.sku[k] });
    }
    return blocks;
  }

  function findHeaderCol1_(sheet, title){
    const lastCol = sheet.getLastColumn();
    const hdr = sheet.getRange(1,1,1,lastCol).getValues()[0];
    for (let c=1;c<=lastCol;c++){
      if (String(hdr[c-1]).trim() === title) return c;
    }
    return -1;
  }

  function lastDataRowByName_(sheet, nameCol1){
    const maxRows = Math.min(CFG.END_ROW_HARD, sheet.getMaxRows());
    const vals = sheet.getRange(CFG.START_ROW, nameCol1, maxRows - CFG.START_ROW + 1, 1).getValues();
    let last = CFG.START_ROW - 1;
    for (let i=0;i<vals.length;i++){
      if (String(vals[i][0] ?? '').trim()) last = CFG.START_ROW + i;
    }
    return Math.max(last, CFG.START_ROW - 1);
  }

  // –§–æ—Ä–º—É–ª–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ r: —á–∏—Å—Ç–∞—è –ê1, –±–µ–∑ –º–∞—Å—Å–∏–≤–æ–≤.
  function buildFormulaA1_(r, cols){
    const aSKU = A1(r, cols.sku);
    const aQTY = A1(r, cols.qty);
    const aSUM = A1(r, cols.sum);
    const aNAME = A1(r, cols.name);

    // –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π A:E, 5-–π —Å—Ç–æ–ª–±–µ—Ü ‚Äî –∑–∞–∫—É–ø–∫–∞
    // IFERROR(VLOOKUP(SKU; A:E;5;FALSE); IFERROR(VLOOKUP(NAME;A:E;5;FALSE);""))
    // P.S. –í Google Sheets –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å ";" –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å ‚Äî –æ–Ω —Å–∞–º –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –ª–æ–∫–∞–ª–∏.
    const vlookupSKU  = `IFERROR(VLOOKUP(${aSKU};${CFG.NOMEN_SHEET}!$A:$E;5;FALSE)`;
    const vlookupNAME = `IFERROR(VLOOKUP(${aNAME};${CFG.NOMEN_SHEET}!$A:$E;5;FALSE)`;
    const costExpr    = `${vlookupSKU};${vlookupNAME};""))`;

    const notFoundCheck = `OR(${aSKU}="";${aSKU}="${CFG.NOT_FOUND_TOKEN}")`;
    const expr = `IF(${notFoundCheck};""; ${aSUM} - ${aQTY} * ${costExpr})`;
    return `=${expr}`;
  }

  function putFormulasForBlock_(sh, blockIndex, block, marginCol1){
    const nameCol1 = block.nameCol0 + 1;
    const qtyCol1  = block.qtyCol0  + 1;
    const sumCol1  = block.sumCol0  + 1;
    const skuCol1  = block.skuCol0  + 1;

    const endByName = lastDataRowByName_(sh, nameCol1);
    const end = Math.min(CFG.END_ROW_HARD, endByName > 0 ? endByName : CFG.END_ROW_HARD);
    if (end < CFG.START_ROW) return { placed: 0 };

    const nRows = end - CFG.START_ROW + 1;
    const rngVals = sh.getRange(CFG.START_ROW, marginCol1, nRows, 1);
    const vals = rngVals.getValues();
    const formulas = rngVals.getFormulas();

    let placed = 0;
    for (let i=0;i<nRows;i++){
      const hasFormula = !!formulas[i][0];
      const hasValue = vals[i][0] !== '' && vals[i][0] !== null;
      if (hasFormula || hasValue) continue; // –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ

      const r = CFG.START_ROW + i;
      const f = buildFormulaA1_(r, { name: nameCol1, qty: qtyCol1, sum: sumCol1, sku: skuCol1 });
      formulas[i][0] = f;
      placed++;
    }
    if (placed > 0) rngVals.setFormulas(formulas);

    // —Å—Ç—Ä–æ–∫–∞ 2 ‚Äî –µ—Å–ª–∏ –ø—É—Å—Ç–æ –∏ –±–µ–∑ —Ñ–æ—Ä–º—É–ª—ã, —Å—Ç–∞–≤–∏–º —Å—É–º–º—É
    const topCell = sh.getRange(2, marginCol1);
    if (!topCell.getFormula() && (topCell.getValue() === '' || topCell.getValue() === null)) {
      const colA = A1(CFG.START_ROW, marginCol1).replace(/[0-9]/g,''); // –±—É–∫–≤—ã –∫–æ–ª–æ–Ω–∫–∏
      topCell.setFormula(`=SUM(${colA}${CFG.START_ROW}:${colA})`);
    }
    return { placed };
  }

  function runActive_(){
    const ss = SpreadsheetApp.getActive();
    const sh = ss.getActiveSheet();

    // –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ –ª–∏—Å—Ç –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞
    const nom = ss.getSheetByName(CFG.NOMEN_SHEET);
    if (!nom) { SpreadsheetApp.getActive().toast('–ù–µ–º–∞—î –ª–∏—Å—Ç–∞ "–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞".','–ú–∞—Ä–∂–∞',6); return; }

    // —á–∏—Ç–∞–µ–º —à–∞–ø–∫—É –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ª–∏—Å—Ç–∞
    const headers = sh.getRange(1,1,1, sh.getLastColumn()).getValues()[0].map(v => String(v).trim());
    const blocks = findBlocks_(headers);
    if (blocks.length === 0) { SpreadsheetApp.getActive().toast('–ë–ª–æ–∫–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ.','–ú–∞—Ä–∂–∞',6); return; }

    const results = [];

    for (let b=0; b<blocks.length; b++){
      const title = CFG.MARGIN_TITLES[b] || `–ú–∞—Ä–∂–∞ (–±–ª–æ–∫ ${b+1})`;
      const marginCol1 = findHeaderCol1_(sh, title);
      if (marginCol1 < 1) { results.push(`${title}: –Ω–µ–º–∞—î –∫–æ–ª–æ–Ω–∫–∏`); continue; }

      const res = putFormulasForBlock_(sh, b, blocks[b], marginCol1);
      results.push(`${title}: —Ñ–æ—Ä–º—É–ª –¥–æ–¥–∞–Ω–æ ${res.placed}`);
    }

    SpreadsheetApp.getActive().toast(results.join(' | '), '–ú–∞—Ä–∂–∞ (—Ñ–æ—Ä–º—É–ª–∏, –ø–æ—Ç–æ—á–Ω–∏–π –ª–∏—Å—Ç)', 8);
  }

  function addMenu_(){
    SpreadsheetApp.getUi()
      .createMenu('–ú–∞—Ä–∂–∞ (–ª–æ–∫–∞–ª—å–Ω–æ)')
      .addItem('–ü–æ—Å—Ç–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É–ª—ã (–ø–æ—Ç–æ—á–Ω–∏–π –ª–∏—Å—Ç)', 'Run_PayalnyaMargin_Formula_Local')
      .addToUi();
  }

  return { runActive_: runActive_, addMenu_: addMenu_ };
})();

/** –ü—É–±–ª—ñ—á–Ω—ñ **/
function Setup_PayalnyaMarginMenu_Local(){
  PAYALNYA_MARGIN_FORMULA_LOCAL.addMenu_();
}
function Run_PayalnyaMargin_Formula_Local(){
  PAYALNYA_MARGIN_FORMULA_LOCAL.runActive_();
}

/* =====================================================================
 *   –î–û–ë–ê–í–ö–ê: –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–µ –º–µ–Ω—é –¥–ª—è "–ú–∞—Ä–∂–∞ (–ª–æ–∫–∞–ª—å–Ω–æ)"
 * =====================================================================*/

/**
 * Installable onOpen-—Ç—Ä–∏–≥–≥–µ—Ä.
 * –†–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö onOpen –≤ –ø—Ä–æ–µ–∫—Ç–µ.
 */
function onOpen_forced_PayalnyaMarginLocal_(e) {
  try {
    PAYALNYA_MARGIN_FORMULA_LOCAL.addMenu_();
  } catch (err) {
    console.error('onOpen_forced_PayalnyaMarginLocal_ error:', err);
  }
}

/**
 * –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ —Ç—Ä–∏–≥–≥–µ—Ä–∞.
 * –ó–∞–ø—É—Å–∫–∞–µ—à—å –û–î–ò–ù –†–ê–ó —Ä—É–∫–∞–º–∏ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤.
 */
function installPayalnyaMarginMenuLocalTriggers() {
  const ss = SpreadsheetApp.getActive();
  const ssId = ss.getId();

  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(tr => {
    const fn = tr.getHandlerFunction();
    if (fn === 'onOpen_forced_PayalnyaMarginLocal_') {
      ScriptApp.deleteTrigger(tr);
    }
  });

  ScriptApp.newTrigger('onOpen_forced_PayalnyaMarginLocal_')
    .forSpreadsheet(ssId)
    .onOpen()
    .create();
}

raised_coeffs_v2 - –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å –ù–∞–¥–º–∞—Ä–∂–∞ –≤—ã—à–µ 700 –≥—Ä–Ω –∏ —Å—Ç–∞–≤–∫–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Ö2 –∏ –∏–º–ø–æ—Ä—Ç–æ–º –≤ –¥—Ä—É–≥—É—é —Ç–∞–±–ª–∏—Ü—É: 
/***** –ü–Ü–î–í–ò–©–ï–ù–Ü –ö–û–ï–§–Ü–¶–Ü–Ñ–ù–¢–ò v8 (—Ñ–∏–Ω–∞–ª)
 *
 * –õ–æ–≥–∏–∫–∞:
 * 1. –ò–¥—ë–º –ø–æ –≤—Å–µ–º –ª–∏—Å—Ç–∞–º –≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.
 * 2. –ù–∞ –∫–∞–∂–¥–æ–º –ª–∏—Å—Ç–µ –∏—â–µ–º —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ "–°—Ç–∞–≤–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞" = —Ö2 –∏–ª–∏ —Ö3.
 *    –ó–∞–±–∏—Ä–∞–µ–º A:H –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–≤–∫—É –≤ I (—Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏—è, –±–µ–∑ —Ñ–æ—Ä–º—É–ª).
 *
 * 3. –°–∫–ª–µ–∏–≤–∞–µ–º –≤—Å—ë –≤ –æ–¥–∏–Ω –º–∞—Å—Å–∏–≤ –≤ –ø–æ—Ä—è–¥–∫–µ –ª–∏—Å—Ç–æ–≤ (–Ω–µ —Å–æ—Ä—Ç–∏—Ä—É–µ–º).
 *
 * 4. –ü–µ—Ä–µ–¥ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–æ–π –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∫–∞—Ç–µ–≥–æ—Ä–∏—è = –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∫–æ–ª–æ–Ω–∫–µ D —Ç–æ–π —Å—Ç—Ä–æ–∫–∏)
 *    –≤—Å—Ç–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é "—à–∞–ø–∫—É"-—Å—Ç—Ä–æ–∫—É:
 *      ["", "", "", <–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏>, "", "", "", "", ""]
 *    –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∏–Ω–¥–µ–∫—Å —ç—Ç–∏—Ö —à–∞–ø–æ–∫.
 *
 * 5. –ü–∏—à–µ–º –ø–æ–ª—É—á–∏–≤—à–∏–π—Å—è –º–∞—Å—Å–∏–≤ (stage2Rows) –≤ —Ñ–∞–π–ª
 *    "–ü–Ü–î–í–ò–©–ï–ù–Ü –ö–û–ï–§–Ü–¶–Ü–Ñ–ù–¢–ò" ‚Üí –ª–∏—Å—Ç "–ü–Ü–î–í–ò–©–ï–ù–Ü –ö–û–ï–§–Ü–¶–Ü–Ñ–ù–¢–ò", —Å A6.
 *    –ü–µ—Ä–µ–¥ —ç—Ç–∏–º —á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∏–∂–µ A5:I5.
 *
 * 6. –ü–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö:
 *    - –ö–æ–ª–æ–Ω–∫–∞ I (—Å—Ç–∞–≤–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞):
 *        "—Ö3"/"x3" ‚Üí –∑–µ–ª—ë–Ω—ã–π —Ñ–æ–Ω
 *        "—Ö2"/"x2" ‚Üí –æ—Ä–∞–Ω–∂–µ–≤—ã–π —Ñ–æ–Ω
 *    - –î–ª—è –∫–∞–∂–¥–æ–π —à–∞–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±–≤–æ–¥–∏–º —è—á–µ–π–∫—É –≤ –∫–æ–ª–æ–Ω–∫–µ D —Ä–∞–º–∫–æ–π —Å—Ä–µ–¥–Ω–µ–π —Ç–æ–ª—â–∏–Ω—ã.
 *
 * 7. –í –°–ê–ú–û–ú –ö–û–ù–¶–ï –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ —Ü–µ–Ω—Ç—Ä—É (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å) –∏ –ø–æ —Å–µ—Ä–µ–¥–∏–Ω–µ (–≤–µ—Ä—Ç–∏–∫–∞–ª—å)
 *    –¥–∏–∞–ø–∞–∑–æ–Ω—ã A:B –∏ D:I –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫.
 *****/

const RAISE_CFG_V8 = {
  DEST_SPREADSHEET_ID: '13BsvCZsmCEKvbwCv-63rc6s3ALe9R6lFJmsWRssh-yk',
  DEST_SHEET_NAME: '–ü–Ü–î–í–ò–©–ï–ù–Ü –ö–û–ï–§–Ü–¶–Ü–Ñ–ù–¢–ò',

  DEST_HEADER_ROW: 5,       // —Å—Ç—Ä–æ–∫–∞ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ A5:I5 –≤ –ø—Ä–∏—ë–º–Ω–∏–∫–µ
  DEST_FIRST_DATA_ROW: 6,   // –¥–∞–Ω–Ω—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å A6
  DEST_COLS: 9,             // A..I

  SRC_HEADER_ROW: 1,                // –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π–Ω–æ–º –ª–∏—Å—Ç–µ
  RATE_HEADER: '–°—Ç–∞–≤–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞',  // –∏–º—è –∫–æ–ª–æ–Ω–∫–∏ —Å—Ç–∞–≤–∫–∏

  SOURCE_SHEETS: [
    '–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ —Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏',
    '–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏',
    'Apple (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ iPhone)',
    'Xiaomi (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ Xiaomi)',
    'Samsung (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ Samsung)',
    '–¢–µ–ª–µ—Ñ–æ–Ω–∏',
    '–ü–ª–∞–Ω—à–µ—Ç–∏ —Ç–∞ –∫–Ω–∏–≥–∏',
    '–ü–ª–∞–Ω—à–µ—Ç–∏',
    'Apple (–ø–ª–∞–Ω—à–µ—Ç–∏ iPad)',
    'Xiaomi (–ø–ª–∞–Ω—à–µ—Ç–∏ Xiaomi)',
    'Samsung (–ø–ª–∞–Ω—à–µ—Ç–∏ Samsung)',
    '–ì—Ä–∞—Ñ—ñ—á–Ω—ñ –ø–ª–∞–Ω—à–µ—Ç–∏',
    '–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ñ –∫–Ω–∏–≥–∏',
    '–ù–æ—É—Ç–±—É–∫–∏ —Ç–∞ –ü–ö',
    '–ù–æ—É—Ç–±—É–∫–∏',
    'Apple (–ù–æ—É—Ç–±—É–∫–∏ MacBook)',
    '–ü–ö',
    'Apple (–ü–ö iMac)',
    '–ú–æ–Ω—ñ—Ç–æ—Ä–∏ –¥–æ –ü–ö',
    '–ö–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ –¥–ª—è –ü–ö',
    '–ö–æ—Ä–ø—É—Å–∏ –¥–ª—è –ü–ö',
    '–í—ñ–¥–µ–æ–∫–∞—Ä—Ç–∏ –¥–ª—è –ü–ö',
    '–°–∏—Å—Ç–µ–º–∏ –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è –¥–ª—è –ü–ö',
    'SSD —Ç–∞ HDD –Ω–∞–∫–æ–ø–∏—á—É–≤–∞—á—ñ –¥–ª—è –ü–ö',
    '–ú–∞–∏–µ—Ä–∏–Ω—Å—å–∫—ñ –ø–ª–∞—Ç–∏ –¥–ª—è –ü–ö',
    '–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä–∏ –¥–ª—è –ü–ö',
    '–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞ –ø–∞–º º—è—Ç—å –¥–ª—è –ü–ö',
    '–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ –Ω–æ—É—Ç–±—É–∫—ñ–≤ —Ç–∞ –ü–ö',
    '–ó–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó –¥–ª—è –Ω–æ—É—Ç–±—É–∫—ñ–≤',
    '–ù–∞–≤—É—à–Ω–∏–∫–∏ —Ç–∞ –∞–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏',
    '–ù–∞–≤—É—à–Ω–∏–∫–∏',
    'Apple (–ù–∞–≤—É—à–Ω–∏–∫–∏ AirPods, EarPods)',
    'Marshall (–ù–∞–≤—É—à–Ω–∏–∫–∏ Marshall)',
    'Bang & Olufsen (–ù–∞–≤—É—à–Ω–∏–∫–∏ Bang & Olufsen)',
    'Bose (–ù–∞–≤—É—à–Ω–∏–∫–∏ Bose)',
    'JBL (–ù–∞–≤—É—à–Ω–∏–∫–∏ JBL)',
    'Baseus (–ù–∞–≤—É—à–Ω–∏–∫–∏ Baseus)',
    '–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏',
    'Apple (–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ HomePod)',
    'Marshall (–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ Marshall)',
    'Bang & Olufsen (–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ Bang & Olufsen)',
    'Bose (–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ Bose)',
    'JBL (–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ JBL)',
    '–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ –Ω–∞–≤—É—à–Ω–∏–∫—ñ–≤ —Ç–∞ –∞–∫—É—Å—Ç–∏—á–Ω–∏—Ö —Å–∏—Å—Ç–µ–º',
    '–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏ —Ç–∞ —Ñ—ñ—Ç–Ω–µ—Å-–±—Ä–∞—Å–ª–µ—Ç–∏',
    '–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏',
    'Apple (–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏ Apple Watch)',
    'Samsung (–°–º–∞—Ä—Ç –≥–æ–¥–∏–Ω–Ω–∏–∫–∏ Galaxy Watch)',
    '–§—ñ—Ç–Ω–µ—Å-–±—Ä–∞—Å–ª–µ—Ç–∏',
    'Xiaomi (–§—ñ—Ç–Ω–µ—Å-–±—Ä–∞—Å–ª–µ—Ç–∏ Mi Band)',
    '–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ —Å–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫—ñ–≤ —Ç–∞ —Ñ—ñ—Ç–Ω–µ—Å-–±—Ä–∞—Å–ª–µ—Ç—ñ–≤',
    '–¢–æ–≤–∞—Ä–∏ –¥–ª—è –¥–æ–º—É',
    '–†–æ–±–æ—Ç–∏-–ø–∏–ª–æ—Å–æ—Å–∏',
    'Xiaomi (–†–æ–±–æ—Ç–∏-–ø–∏–ª–æ—Å–æ—Å–∏ Xiaomi)',
    '–†—É—á–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏',
    'Xiaomi (–†—É—á–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏ Xiaomi)',
    'Dyson (–†—É—á–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏ Dyson)',
    '–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏',
    'Baseus (–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏ Baseus)',
    '–ö–ª—ñ–º–∞—Ç–∏—á–Ω–∞ —Ç–µ—Ö–Ω—ñ–∫–∞',
    '–ó–≤–æ–ª–æ–∂—É–≤–∞—á—ñ –ø–æ–≤—ñ—Ç—Ä—è',
    '–û—á–∏—â—É–≤–∞—á—ñ –ø–æ–≤—ñ—Ç—Ä—è',
    '–û—Å—É—à—É–≤–∞—á—ñ –ø–æ–≤—ñ—Ç—Ä—è',
    '–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ —Ç–æ–≤–∞—Ä—ñ–≤ –¥–ª—è –¥–æ–º—É',
    '–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ —Ç–∞ –≥–µ–π–º—ñ–Ω–≥',
    '–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ',
    'Sony (–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ Sony PlayStation)',
    'Xbox (–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ Xbox)',
    'Nintendo (–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ Nintendo)',
    'Steam (–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ Steam Deck)',
    '–ì–µ–π–º–ø–∞–¥–∏ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏',
    'Sony (–ì–µ–π–º–ø–∞–¥–∏ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏ Sony)',
    'Xbox (–ì–µ–π–º–ø–∞–¥–∏ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏ Xbox)',
    'Logitech (–ì–µ–π–º–ø–∞–¥–∏ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏ Logitech)',
    '–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ —ñ–≥—Ä–æ–≤–∏—Ö –∫–æ–Ω—Å–æ–ª–µ–π',
    '–î–æ–≥–ª—è–¥ —Ç–∞ –∫—Ä–∞—Å–∞',
    '–§–µ–Ω–∏ —Ç–∞ —Å—Ç–∞–π–ª–µ—Ä–∏',
    'Dyson (–§–µ–Ω–∏ —Ç–∞ —Å—Ç–∞–π–ª–µ—Ä–∏ Dyson)',
    '–ü–ª–æ–π–∫–∏ —Ç–∞ –≤–∏–ø—Ä—è–º–ª—è—á—ñ',
    '–í–∞–≥–∏ –ø—ñ–¥–ª–æ–≥–æ–≤—ñ',
    '–ó—É–±–Ω—ñ —â—ñ—Ç–∫–∏ —Ç–∞ —ñ—Ä–∏–≥–∞—Ç–æ—Ä–∏',
    '–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –¥–æ–≥–ª—è–¥—É —Ç–∞ –∫—Ä–∞—Å–∏',
    '–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏',
    '–ê–≤—Ç–æ—Ç—Ä–∏–º–∞—á—ñ (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)',
    '–ê—Ä–æ–º–∞—Ç–∏–∑–∞—Ç–æ—Ä–∏ (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)',
    '–ó–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)',
    '–ë—É—Å—Ç–µ—Ä–∏ —Ç–∞ –∫–æ–º–ø—Ä–µ—Å–æ—Ä–∏ (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)',
    '–Ü–Ω–≤–µ—Ä—Ç–æ—Ä–∏ (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)',
    '–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –∞–≤—Ç–æ–º–æ–±—ñ–ª—è (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)',
    '–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤',
    '–ß–æ—Ö–ª–∏ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤',
    'Apple (–ß–æ—Ö–ª–∏ –¥–ª—è iPhone)',
    'Xiaomi (–ß–æ—Ö–ª–∏ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤ Xiaomi)',
    'Samsung (–ß–æ—Ö–ª–∏ –¥–ª—è —Å–º–∞—Ä—Ç–≤–æ–Ω—ñ–≤ Samsung)',
    '–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ —ñ –ø–ª—ñ–≤–∫–∞ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤',
    'Apple (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è iPhone)',
    'Xiaomi (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤ Xiaomi)',
    'Samsung (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤ Samsung)',
    '–ó–∞—Ö–∏—Å–Ω–∞ –ø–ª—ñ–≤–∫–∞ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤',
    '–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤',
    '–ß–æ—Ö–ª–∏ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤',
    'Apple (–ß–æ—Ö–ª–∏ –¥–ª—è iPad)',
    'Xiaomi (–ß–æ—Ö–ª–∏ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤ Xiaomi)',
    'Samsung (–ß–æ—Ö–ª–∏ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤ Samsung)',
    '–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ —ñ –ø–ª—ñ–≤–∫–∞ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤',
    'Apple (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è iPad)',
    'Xiaomi (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤ Xiaomi)',
    'Samsung (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤ Samsung)',
    '–ó–∞—Ö–∏—Å–Ω–∞ –ø–ª—ñ–≤–∫–∞ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤',
    '–ü–∞–≤–µ—Ä–±–∞–Ω–∫–∏ —Ç–∞ –±–∞—Ç–∞—Ä–µ–π–∫–∏',
    '–ü–∞–≤–µ—Ä–±–∞–Ω–∫–∏',
    '–ë–∞—Ç–∞—Ä–µ–π–∫–∏',
    '–ö–≤–∞–¥—Ä–æ–∫–æ–ø—Ç–µ—Ä–∏',
    'DJI (–ö–≤–∞–¥—Ä–æ–∫–æ–ø—Ç–µ—Ä–∏ DJI)',
    '–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ –∫–≤–∞–¥—Ä–æ–∫–æ–ø—Ç–µ—Ä—ñ–≤',
    '–ù–∞–∫–æ–ø–∏—á—É–≤–∞—á—ñ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó',
    '–§–ª–µ—à–∫–∏',
    '–ö–∞—Ä—Ç–∫–∏ –ø–∞–º º—è—Ç—ñ MicroSD',
    '–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ —Ç–∞ –∫–æ–º–ø º—é—Ç–µ—Ä–Ω—ñ –º–∏—à—ñ',
    '–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∏',
    'Logitech (–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ Logitech)',
    '–ö–æ–º–ø º—é—Ç–µ—Ä–Ω—ñ –º–∏—à—ñ',
    'Logitech (–ö–æ–º–ø º—é—Ç–µ—Ä–Ω—ñ –º–∏—à—ñ Logitech)',
    '–ö–∞–±–µ–ª—ñ —Ç–∞ –ø–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏',
    '–ö–∞–±–µ–ª—ñ',
    'Apple (–ö–∞–±–µ–ª—ñ Apple)',
    'Acefast (–ö–∞–±–µ–ª—ñ Acefast)',
    'Baseus (–ö–∞–±–µ–ª—ñ Baseus)',
    '–ü–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏',
    'Apple (–ü–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏ Apple)',
    'Acefast (–ü–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏ Acefast)',
    'Baseus (–ü–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏ Baseus)',
    '–ó–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó',
    '–ë–µ–∑–¥—Ä–æ—Ç–æ–≤—ñ –∑–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó',
    'Apple (–ë–µ–∑–¥—Ä–æ—Ç–æ–≤—ñ –ó–ü Apple)',
    'Acefast (–ë–µ–∑–¥—Ä–æ—Ç–æ–≤—ñ –ó–ü Acefast)',
    'Baseus (–ë–µ–∑–¥—Ä–æ—Ç–æ–≤—ñ –ó–ü Baseus)',
    '–ú–µ—Ä–µ–∂–µ–≤—ñ –∑–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó',
    'Apple (–ú–µ—Ä–µ–∂–µ–≤—ñ –ó–ü Apple)',
    'Acefast (–ú–µ—Ä–µ–∂–µ–≤—ñ –ó–ü Acefast)',
    'Baseus (–ú–µ—Ä–µ–∂–µ–≤—ñ –ó–ü Baseus)',
    '–ì–∞–¥–∂–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º',
    '–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º',
    'Apple (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º iPhone)',
    'Xiaomi (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Xiaomi)',
    'Samsung (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Samsung)',
    '–ü–ª–∞–Ω—à–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º',
    'Apple (–ü–ª–∞–Ω—à–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º iPad)',
    'Xiaomi (–ø–ª–∞–Ω—à–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Xiaomi)',
    'Samsung (–ø–ª–∞–Ω—à–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Samsung)',
    '–ù–æ—É—Ç–±—É–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º',
    'Apple (–ù–æ—É—Ç–±—É–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º MacBook)',
    '–ü–ö –∑ –ø—Ä–æ–±—ñ–≥–æ–º',
    'Apple (–ü–ö –∑ –ø—Ä–æ–±—ñ–≥–æ–º iMac)',
    '–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º',
    'Apple (–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Apple Watch)',
    '–Ü–Ω—à—ñ –≥–∞–¥–∂–µ—Ç–∏',
    '–ü–æ–¥–∞—Ä—É–Ω–∫–æ–≤—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏',
    '–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ —Ç–∞ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è',
    '–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏',
    '–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏',
    'Apple (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Apple)',
    'Xiaomi (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Xiaomi)',
    'Samsung (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Samsung)',
    'Huawei (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Huawei)',
    'Google (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Google)',
    '–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω—ñ –∞–∫—É–º—É–ª—è—Ç–æ—Ä–∏',
    '–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è',
    'Apple (–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è Apple)',
    'Xiaomi (–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è Xiaomi)',
    'Samsung (–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è Samsung)',
    'Huawei (–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è Huawei)',
    '–î–∏–Ω–∞–º—ñ–∫–∏',
    'Apple (–î–∏–Ω–∞–º—ñ–∫–∏ Apple)',
    '–ó–∞–¥–Ω—ñ –∫—Ä–∏—à–∫–∏',
    'Apple (–ó–∞–¥–Ω—ñ –∫—Ä–∏—à–∫–∏ Apple)',
    '–ö–º–µ—Ä–∏ —Ç–∞ —Å–∫–ª–æ –∫–∞–º–µ—Ä–∏',
    'Apple (–ö–º–µ—Ä–∏ —Ç–∞ —Å–∫–ª–æ –∫–∞–º–µ—Ä–∏ Apple)',
    '–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏',
    'Apple (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏ Apple)',
    'Xiaomi (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏ Xiaomi)',
    'Samsung (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏ Samsung)',
    'Huawei (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏ Huawei)',
    '–®–ª–µ–π—Ñ–∏',
    'Apple (–®–ª–µ–π—Ñ–∏ Apple)',
    '–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏ –¥–ª—è —ñ–≥—Ä–æ–≤–∏—Ö –∫–æ–Ω—Å–æ–ª–µ–π',
    '–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏ –¥–ª—è Sony PlayStation'
  ]
};


function buildRaisedCoeffsV8() {
  const srcSS = SpreadsheetApp.getActiveSpreadsheet(); // "–ê–Ω–∞–ª–∏–∑ NEW NOT FINAL"

  // stage1Rows: –≤—Å–µ —Ç–æ–≤–∞—Ä–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (–±–µ–∑ —à–∞–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π)
  // –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ = [A,B,C,D,E,F,G,H,–°—Ç–∞–≤–∫–∞–ú–µ–Ω–µ–¥–∂–µ—Ä–∞]
  const stage1Rows = [];

  // 1. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—Å–µ–º –ª–∏—Å—Ç–∞–º
  for (let s = 0; s < RAISE_CFG_V8.SOURCE_SHEETS.length; s++) {
    const sheetName = RAISE_CFG_V8.SOURCE_SHEETS[s];
    const sh = srcSS.getSheetByName(sheetName);
    if (!sh) continue;

    const lastRow = sh.getLastRow();
    if (lastRow < 2) continue;

    const lastCol = Math.max(9, sh.getLastColumn());
    const headerVals = sh
      .getRange(RAISE_CFG_V8.SRC_HEADER_ROW, 1, 1, lastCol)
      .getDisplayValues()[0];

    const rateColIdx = _findHeaderIndex_V8_(headerVals, RAISE_CFG_V8.RATE_HEADER);
    if (rateColIdx === -1) continue;

    const dataAH = sh.getRange(2, 1, lastRow - 1, 8).getDisplayValues();      // A..H
    const dataRate = sh.getRange(2, rateColIdx + 1, lastRow - 1, 1).getDisplayValues(); // —Å—Ç–∞–≤–∫–∞

    for (let r = 0; r < dataAH.length; r++) {
      const stakeRaw = (dataRate[r][0] || '').toString().trim();
      const norm = _normalizeRate_V8_(stakeRaw); // "x2", "x3", ""
      if (norm === 'x2' || norm === 'x3') {
        const rowVals = dataAH[r].slice();
        rowVals.push(stakeRaw); // I = "—Ö2"/"—Ö3" –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –≤–∏–¥–µ
        stage1Rows.push(rowVals);
      }
    }
  }

  // 2. –í—Å—Ç–∞–≤–∫–∞ —à–∞–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–ø–µ—Ä–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
  // stage2Rows = —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏
  // headerRowIndices = –∏–Ω–¥–µ–∫—Å—ã —Å—Ç—Ä–æ–∫-—à–∞–ø–æ–∫ (–≤ stage2Rows)
  const stage2Rows = [];
  const headerRowIndices = [];
  const seenCats = {};

  for (let i = 0; i < stage1Rows.length; i++) {
    const cat = (stage1Rows[i][3] || '').toString().trim(); // –∫–æ–ª–æ–Ω–∫–∞ D
    if (cat !== '' && !seenCats[cat]) {
      // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      stage2Rows.push(["", "", "", cat, "", "", "", "", ""]);
      headerRowIndices.push(stage2Rows.length - 1); // –∏–Ω–¥–µ–∫—Å —Ç–æ–ª—å–∫–æ —á—Ç–æ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
      seenCats[cat] = true;
    }
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–∞–º —Ç–æ–≤–∞—Ä
    stage2Rows.push(stage1Rows[i]);
  }

  // 3. –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏—ë–º–Ω—ã–π –ª–∏—Å—Ç
  const dstSh = _getDestSheet_V8_();

  // 4. –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ —Å—Ç—Ä–æ–∫–∏ A6:I..., –Ω–µ —Ç—Ä–æ–≥–∞—è –∑–∞–≥–æ–ª–æ–≤–æ–∫ A5:I5
  const lastDstRow = dstSh.getLastRow();
  if (lastDstRow >= RAISE_CFG_V8.DEST_FIRST_DATA_ROW) {
    dstSh
      .getRange(
        RAISE_CFG_V8.DEST_FIRST_DATA_ROW,
        1,
        lastDstRow - RAISE_CFG_V8.DEST_FIRST_DATA_ROW + 1,
        RAISE_CFG_V8.DEST_COLS
      )
      .clearContent()
      .setBorder(false, false, false, false, false, false);
  }

  if (stage2Rows.length > 0) {
    // 5. –ü–∏—à–µ–º –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    dstSh
      .getRange(
        RAISE_CFG_V8.DEST_FIRST_DATA_ROW,
        1,
        stage2Rows.length,
        RAISE_CFG_V8.DEST_COLS
      )
      .setValues(stage2Rows);

    const numRows = stage2Rows.length;
    const startRow = RAISE_CFG_V8.DEST_FIRST_DATA_ROW;
    const endRow = startRow + numRows - 1;

    // 6. –†–∞—Å–∫—Ä–∞—Å–∫–∞ –∫–æ–ª–æ–Ω–∫–∏ I (—Å—Ç–∞–≤–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞)
    //    —Ö3 ‚Üí –∑–µ–ª—ë–Ω—ã–π, —Ö2 ‚Üí –æ—Ä–∞–Ω–∂–µ–≤—ã–π
    const rateRange = dstSh.getRange(startRow, 9, numRows, 1); // col I = 9
    const rateVals = rateRange.getValues(); // 2D –º–∞—Å—Å–∏–≤ [ [val], [val], ... ]
    const bgColors = [];

    for (let r = 0; r < rateVals.length; r++) {
      const raw = (rateVals[r][0] || '').toString().trim();
      const norm = _normalizeRate_V8_(raw); // "x2"/"x3"/""
      let color = null;
      if (norm === 'x3') {
        // –∑–µ–ª—ë–Ω—ã–π
        color = '#00b050';
      } else if (norm === 'x2') {
        // –æ—Ä–∞–Ω–∂–µ–≤—ã–π
        color = '#FFA500';
      } else {
        // –ø—É—Å—Ç–æ ‚Üí —Å–±—Ä–æ—Å
        color = null;
      }
      bgColors.push([color]);
    }
    rateRange.setBackgrounds(bgColors);

    // 7. –†–∞–º–∫–∞ —Å—Ä–µ–¥–Ω–µ–π —Ç–æ–ª—â–∏–Ω—ã –≤–æ–∫—Ä—É–≥ —à–∞–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–ø–æ –∫–æ–ª–æ–Ω–∫–µ D)
    for (let h = 0; h < headerRowIndices.length; h++) {
      const headerLocalIdx = headerRowIndices[h]; // –∏–Ω–¥–µ–∫—Å –≤ stage2Rows
      const absRow = startRow + headerLocalIdx;
      dstSh
        .getRange(absRow, 4, 1, 1) // –∫–æ–ª–æ–Ω–∫–∞ D
        .setBorder(
          true,  // top
          true,  // left
          true,  // bottom
          true,  // right
          false, // inner vertical
          false, // inner horizontal
          null,
          SpreadsheetApp.BorderStyle.SOLID_MEDIUM
        );
    }

    // 8. –í —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ: —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∞ A:B –∏ D:I
    // A:B
    dstSh
      .getRange(startRow, 1, numRows, 2)
      .setHorizontalAlignment('center')
      .setVerticalAlignment('middle');

    // D:I
    dstSh
      .getRange(startRow, 4, numRows, 6)
      .setHorizontalAlignment('center')
      .setVerticalAlignment('middle');
  }

  // 9. –°–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ö–æ–¥–Ω–æ–π –∫–Ω–∏–≥–µ
  srcSS.toast(
    'V8 –≥–æ—Ç–æ–≤–æ: ' + stage2Rows.length + ' —Ä—è–¥–∫—ñ–≤ —É ¬´–ü–Ü–î–í–ò–©–ï–ù–Ü –ö–û–ï–§–Ü–¶–Ü–Ñ–ù–¢–ò¬ª, –∫–æ–ª—å–æ—Ä–∏ —Ç–∞ —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ.',
    '–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏',
    7
  );
}


/**
 * –ù–∞—Ö–æ–¥–∏–º –ª–∏—Å—Ç-–ø—Ä–∏—ë–º–Ω–∏–∫ –≤ —Ñ–∞–π–ª–µ "–ü–Ü–î–í–ò–©–ï–ù–Ü –ö–û–ï–§–Ü–¶–Ü–Ñ–ù–¢–ò".
 * 1) —Ç–æ—á–Ω–æ–µ –∏–º—è
 * 2) –∏–º—è –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
 * 3) –ª–∏—Å—Ç, –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å "–∫–æ–µ—Ñ"
 */
function _getDestSheet_V8_() {
  const dstSS = SpreadsheetApp.openById(RAISE_CFG_V8.DEST_SPREADSHEET_ID);

  let sh = dstSS.getSheetByName(RAISE_CFG_V8.DEST_SHEET_NAME);
  if (sh) return sh;

  const wantedLower = RAISE_CFG_V8.DEST_SHEET_NAME.toString().trim().toLowerCase();
  const sheets = dstSS.getSheets();
  for (let i = 0; i < sheets.length; i++) {
    const nm = sheets[i].getName().toString().trim().toLowerCase();
    if (nm === wantedLower) {
      return sheets[i];
    }
  }
  for (let i = 0; i < sheets.length; i++) {
    const nm = sheets[i].getName().toString().trim().toLowerCase();
    if (nm.indexOf('–∫–æ–µ—Ñ') !== -1) {
      return sheets[i];
    }
  }

  throw new Error(
    '–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞—Ä–∫—É—à "' +
      RAISE_CFG_V8.DEST_SHEET_NAME +
      '" —É —Ñ–∞–π–ª—ñ –ü–Ü–î–í–ò–©–ï–ù–Ü –ö–û–ï–§–Ü–¶–Ü–Ñ–ù–¢–ò'
  );
}


/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω–¥–µ–∫—Å —Å—Ç–æ–ª–±—Ü–∞ –ø–æ –∏–º–µ–Ω–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–ø–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞),
 * –∏–ª–∏ -1 –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.
 */
function _findHeaderIndex_V8_(headerRowArray, wantedHeader) {
  const target = wantedHeader.toString().trim().toLowerCase();
  for (let i = 0; i < headerRowArray.length; i++) {
    const h = (headerRowArray[i] || '').toString().trim().toLowerCase();
    if (h === target) {
      return i;
    }
  }
  return -1;
}


/**
 * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Å—Ç–∞–≤–∫—É –º–µ–Ω–µ–¥–∂–µ—Ä–∞:
 * - –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫—É—é "—Ö"/"–•" –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –≤ –ª–∞—Ç–∏–Ω—Å–∫—É—é "x"
 * - —É–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–±–µ–ª—ã
 * - –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
 * –†–µ–∑—É–ª—å—Ç–∞—Ç: "x2", "x3" –∏–ª–∏ "".
 */
function _normalizeRate_V8_(raw) {
  if (!raw) return '';
  return raw
    .toString()
    .replace(/[\u0445\u0425]/g, 'x') // –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∞—è —Ö/–• ‚Üí –ª–∞—Ç–∏–Ω—Å–∫–∞—è x
    .replace(/\s+/g, '')
    .toLowerCase();
}

/* =====================================================================
 *   –î–û–ë–ê–í–ö–ê: –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–µ –º–µ–Ω—é –¥–ª—è "–ü–Ü–î–í–ò–©–ï–ù–Ü –ö–û–ï–§–Ü–¶–Ü–Ñ–ù–¢–ò v8"
 * =====================================================================*/

/**
 * –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ—Ç –º–µ–Ω—é.
 */
function _addRaiseCoeffsV8Menu_() {
  SpreadsheetApp.getUi()
    .createMenu('–ü–Ü–î–í–ò–©–ï–ù–Ü –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏')
    .addItem('–û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ —Ö2/—Ö3', 'buildRaisedCoeffsV8')
    .addToUi();
}

/**
 * Installable onOpen-—Ç—Ä–∏–≥–≥–µ—Ä.
 * –†–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö onOpen –≤ –ø—Ä–æ–µ–∫—Ç–µ.
 */
function onOpen_forced_RaiseCoeffsV8_(e) {
  try {
    _addRaiseCoeffsV8Menu_();
  } catch (err) {
    Logger.log('onOpen_forced_RaiseCoeffsV8_ error: ' + err);
  }
}

/**
 * –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –¥–ª—è –º–µ–Ω—é.
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –û–î–ò–ù –†–ê–ó –≤—Ä—É—á–Ω—É—é –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Å–∫—Ä–∏–ø—Ç–∞.
 */
function installRaiseCoeffsV8MenuTrigger() {
  const ss = SpreadsheetApp.getActive();
  const ssId = ss.getId();

  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(tr => {
    const fn = tr.getHandlerFunction();
    if (fn === 'onOpen_forced_RaiseCoeffsV8_') {
      ScriptApp.deleteTrigger(tr);
    }
  });

  ScriptApp.newTrigger('onOpen_forced_RaiseCoeffsV8_')
    .forSpreadsheet(ssId)
    .onOpen()
    .create();
}

–ú–∞–ø–ø–∏–Ω–≥ - —É–∂–µ –≥–æ–≤–æ—Ä–∏–ª –¥–ª—è —á–µ–≥–æ –ª–∏—Å—Ç, —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å —É–≤–∏–¥–µ—Ç—å, —á—Ç–æ –∫–∞–∫ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç:
/***** –ö–ê–¢–ï–ì–û–†–Ü–ô–ù–ò–ô –ú–ê–ü–ü–Ü–ù–ì ‚Üí –°–≤–æ–¥ —É "–ú–∞–ø–ø–∏–Ω–≥"
 * –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –ª–∏—Å—Ç—ã-–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞ (—É—á–∏—Ç—ã–≤–∞—è Excel-–æ–±—Ä–µ–∑–∞–Ω–∏–µ –¥–æ 31 —Å–∏–º–≤–æ–ª–∞).
 * –ù–µ –º–µ–Ω—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏. –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ "China".
 *****/

const MAP_CFG = {
  MAPPING_SHEET_NAME: '–ú–∞–ø–ø–∏–Ω–≥',

  DEDUPE_MODE: 'none',         // 'none' | 'by_code' | 'by_code_id_supplier'
  ADD_TIMESTAMP: false,        // true -> –¥–æ–±–∞–≤–∏—Ç –∫–æ–ª–æ–Ω–∫—É "–î–∞—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è"
  TIMESTAMP_TZ: 'Europe/Kyiv',

  // –ó–∞–≥–æ–ª–æ–≤–∫–∏ (—Å–∏–Ω–æ–Ω–∏–º—ã)
  HDRS: {
    // –ò—Å—Ç–∏–Ω–Ω—ã–π –∫–æ–¥ (sitecode, –Ω–∞—à –∫–æ–¥ –∏ —Ç.–ø.)
    code:     ['–∫–æ–¥','–∫–æ–¥ —Ç–æ–≤–∞—Ä—É','–∫–æ–¥ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞','–∫–æ–¥ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞','–∫–æ–¥ –ø–æ—Å—Ç.','–∫–æ–¥ –ø–æ—Å—Ç–∞—á',
               'vendorcode','vendor code','sku','sitecode','–Ω–∞—à –∫–æ–¥','–Ω–∞—à_–∫–æ–¥','site code'],

    // –û—Ç–¥–µ–ª—å–Ω–æ –∞—Ä—Ç–∏–∫—É–ª
    article:  ['–∞—Ä—Ç–∏–∫—É–ª','–∞—Ä—Ç.','–∞—Ä—Ç–∏–∫—É–ª –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞','–∞—Ä—Ç–∏–∫—É–ª –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞','–∞—Ä—Ç–∏–∫—É–ª –ø–æ—Å—Ç.','–∞—Ä—Ç–∏–∫—É–ª –ø–æ—Å—Ç–∞—á'],

    model:    ['–º–æ–¥–µ–ª—å','model','–Ω–∞–∑–≤–∞ –º–æ–¥–µ–ª—ñ','–Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏','–º–æ–¥–µ–ª—å/–∞—Ä—Ç–∏–∫—É–ª','—ñ–º º—è –º–æ–¥–µ–ª—ñ','–∏–º—è –º–æ–¥–µ–ª–∏','name','–Ω–∞–∑–≤–∞','–Ω–∞–∑–≤–∞–Ω–∏–µ'],
    id:       ['id','@id','—ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä','–∞–π–¥–∏'],
    supplier: ['–ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫','–ø–æ—Å—Ç–∞–≤—â–∏–∫','supplier','vendor','–≤–∏—Ä–æ–±–Ω–∏–∫'],
    link:     ['—Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä','–ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–æ–≤–∞—Ä','–ø–æ—Å–∏–ª–∞–Ω–Ω—è','—Å—Å—ã–ª–∫–∞','link','url','–∞–¥—Ä–µ—Å','url —Å—Ç–æ—Ä—ñ–Ω–∫–∏','url —Å—Ç—Ä–∞–Ω–∏—Ü—ã']
  },

  // –ò–º–µ–Ω–∞ –ª–∏—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤—Å–µ–≥–¥–∞
  EXCLUDE_SHEETS: [
    '–ú–∞–ø–ø–∏–Ω–≥','–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏','XML_FLAT','–ö–æ–¥—ã','LOG_RRP','PRICE_CHANGES','PRICE_CHANGES_SUPPLIER',
    'ELTK__SUPPLIER_SNAPSHOT','ELTK__PRICE_SNAPSHOT','ELTK__KNOWN_IDS','ELTK__NOTIFIED_NO_SC'
  ],

  // –õ–∏—Å—Ç—ã-–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∫–∞–Ω–æ–Ω—ñ—á–Ω—ñ –ø–æ–≤–Ω—ñ –Ω–∞–∑–≤–∏ –∑ —Ç–≤–æ–≥–æ —Å–ø–∏—Å–∫—É)
  CATEGORY_SHEETS_CANONICAL: [
    '–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ —Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏','–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏','Apple (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ iPhone)','Xiaomi (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ Xiaomi)','Samsung (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ Samsung)','–¢–µ–ª–µ—Ñ–æ–Ω–∏',
    '–ü–ª–∞–Ω—à–µ—Ç–∏ —Ç–∞ –∫–Ω–∏–≥–∏','–ü–ª–∞–Ω—à–µ—Ç–∏','Apple (–ø–ª–∞–Ω—à–µ—Ç–∏ iPad)','Xiaomi (–ø–ª–∞–Ω—à–µ—Ç–∏ Xiaomi)','Samsung (–ø–ª–∞–Ω—à–µ—Ç–∏ Samsung)','–ì—Ä–∞—Ñ—ñ—á–Ω—ñ –ø–ª–∞–Ω—à–µ—Ç–∏','–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ñ –∫–Ω–∏–≥–∏',
    '–ù–æ—É—Ç–±—É–∫–∏ —Ç–∞ –ü–ö','–ù–æ—É—Ç–±—É–∫–∏','Apple (–ù–æ—É—Ç–±—É–∫–∏ MacBook)','–ü–ö','Apple (–ü–ö iMac)','–ú–æ–Ω—ñ—Ç–æ—Ä–∏ –¥–æ –ü–ö','–ö–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ –¥–ª—è –ü–ö','–ö–æ—Ä–ø—É—Å–∏ –¥–ª—è –ü–ö','–í—ñ–¥–µ–æ–∫–∞—Ä—Ç–∏ –¥–ª—è –ü–ö',
    '–°–∏—Å—Ç–µ–º–∏ –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è –¥–ª—è –ü–ö','SSD —Ç–∞ HDD –Ω–∞–∫–æ–ø–∏—á—É–≤–∞—á—ñ –¥–ª—è –ü–ö','–ú–∞–∏–µ—Ä–∏–Ω—Å—å–∫—ñ –ø–ª–∞—Ç–∏ –¥–ª—è –ü–ö','–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä–∏ –¥–ª—è –ü–ö','–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞ –ø–∞–º º—è—Ç—å –¥–ª—è –ü–ö',
    '–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ –Ω–æ—É—Ç–±—É–∫—ñ–≤ —Ç–∞ –ü–ö','–ó–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó –¥–ª—è –Ω–æ—É—Ç–±—É–∫—ñ–≤',
    '–ù–∞–≤—É—à–Ω–∏–∫–∏ —Ç–∞ –∞–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏','–ù–∞–≤—É—à–Ω–∏–∫–∏','Apple (–ù–∞–≤—É—à–Ω–∏–∫–∏ AirPods, EarPods)','Marshall (–ù–∞–≤—É—à–Ω–∏–∫–∏ Marshall)','Bang & Olufsen (–ù–∞–≤—É—à–Ω–∏–∫–∏ Bang & Olufsen)',
    'Bose (–ù–∞–≤—É—à–Ω–∏–∫–∏ Bose)','JBL (–ù–∞–≤—É—à–Ω–∏–∫–∏ JBL)','Baseus (–ù–∞–≤—É—à–Ω–∏–∫–∏ Baseus)','–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏','Apple (–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ HomePod)','Marshall (–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ Marshall)',
    'Bang & Olufsen (–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ Bang & Olufsen)','Bose (–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ Bose)','JBL (–ê–∫—É—Å—Ç–∏—á–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ JBL)','–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ –Ω–∞–≤—É—à–Ω–∏–∫—ñ–≤ —Ç–∞ –∞–∫—É—Å—Ç–∏—á–Ω–∏—Ö —Å–∏—Å—Ç–µ–º',
    '–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏ —Ç–∞ —Ñ—ñ—Ç–Ω–µ—Å-–±—Ä–∞—Å–ª–µ—Ç–∏','–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏','Apple (–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏ Apple Watch)','Samsung (–°–º–∞—Ä—Ç –≥–æ–¥–∏–Ω–Ω–∏–∫–∏ Galaxy Watch)','–§—ñ—Ç–Ω–µ—Å-–±—Ä–∞—Å–ª–µ—Ç–∏',
    'Xiaomi (–§—ñ—Ç–Ω–µ—Å-–±—Ä–∞—Å–ª–µ—Ç–∏ Mi Band)','–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ —Å–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫—ñ–≤ —Ç–∞ —Ñ—ñ—Ç–Ω–µ—Å-–±—Ä–∞—Å–ª–µ—Ç—ñ–≤',
    '–¢–æ–≤–∞—Ä–∏ –¥–ª—è –¥–æ–º—É','–†–æ–±–æ—Ç–∏-–ø–∏–ª–æ—Å–æ—Å–∏','Xiaomi (–†–æ–±–æ—Ç–∏-–ø–∏–ª–æ—Å–æ—Å–∏ Xiaomi)','–†—É—á–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏','Xiaomi (–†—É—á–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏ Xiaomi)','Dyson (–†—É—á–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏ Dyson)',
    '–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏','Baseus (–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω—ñ –ø–∏–ª–æ—Å–æ—Å–∏ Baseus)','–ö–ª—ñ–º–∞—Ç–∏—á–Ω–∞ —Ç–µ—Ö–Ω—ñ–∫–∞','–ó–≤–æ–ª–æ–∂—É–≤–∞—á—ñ –ø–æ–≤—ñ—Ç—Ä—è','–û—á–∏—â—É–≤–∞—á—ñ –ø–æ–≤—ñ—Ç—Ä—è','–û—Å—É—à—É–≤–∞—á—ñ –ø–æ–≤—ñ—Ç—Ä—è','–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ —Ç–æ–≤–∞—Ä—ñ–≤ –¥–ª—è –¥–æ–º—É',
    '–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ —Ç–∞ –≥–µ–π–º—ñ–Ω–≥','–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ','Sony (–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ Sony PlayStation)','Xbox (–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ Xbox)','Nintendo (–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ Nintendo)',
    'Steam (–Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å–æ–ª—ñ Steam Deck)','–ì–µ–π–º–ø–∞–¥–∏ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏','Sony (–ì–µ–π–º–ø–∞–¥–∏ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏ Sony)','Xbox (–ì–µ–π–º–ø–∞–¥–∏ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏ Xbox)',
    'Logitech (–ì–µ–π–º–ø–∞–¥–∏ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏ Logitech)','–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ —ñ–≥—Ä–æ–≤–∏—Ö –∫–æ–Ω—Å–æ–ª–µ–π',
    '–î–æ–≥–ª—è–¥ —Ç–∞ –∫—Ä–∞—Å–∞','–§–µ–Ω–∏ —Ç–∞ —Å—Ç–∞–π–ª–µ—Ä–∏','Dyson (–§–µ–Ω–∏ —Ç–∞ —Å—Ç–∞–π–ª–µ—Ä–∏ Dyson)','–ü–ª–æ–π–∫–∏ —Ç–∞ –≤–∏–ø—Ä—è–º–ª—è—á—ñ','–í–∞–≥–∏ –ø—ñ–¥–ª–æ–≥–æ–≤—ñ','–ó—É–±–Ω—ñ —â—ñ—Ç–∫–∏ —Ç–∞ —ñ—Ä–∏–≥–∞—Ç–æ—Ä–∏','–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –¥–æ–≥–ª—è–¥—É —Ç–∞ –∫—Ä–∞—Å–∏',
    '–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏','–ê–≤—Ç–æ—Ç—Ä–∏–º–∞—á—ñ (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)','–ê—Ä–æ–º–∞—Ç–∏–∑–∞—Ç–æ—Ä–∏ (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)','–ó–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)','–ë—É—Å—Ç–µ—Ä–∏ —Ç–∞ –∫–æ–º–ø—Ä–µ—Å–æ—Ä–∏ (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)',
    '–Ü–Ω–≤–µ—Ä—Ç–æ—Ä–∏ (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)','–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –∞–≤—Ç–æ–º–æ–±—ñ–ª—è (–ê–≤—Ç–æ—Ç–æ–≤–∞—Ä–∏)',
    '–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤','–ß–æ—Ö–ª–∏ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤','Apple (–ß–æ—Ö–ª–∏ –¥–ª—è iPhone)','Xiaomi (–ß–æ—Ö–ª–∏ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤ Xiaomi)','Samsung (–ß–æ—Ö–ª–∏ –¥–ª—è —Å–º–∞—Ä—Ç–≤–æ–Ω—ñ–≤ Samsung)',
    '–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ —ñ –ø–ª—ñ–≤–∫–∞ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤','Apple (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è iPhone)','Xiaomi (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤ Xiaomi)','Samsung (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤ Samsung)',
    '–ó–∞—Ö–∏—Å–Ω–∞ –ø–ª—ñ–≤–∫–∞ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤',
    '–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤','–ß–æ—Ö–ª–∏ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤','Apple (–ß–æ—Ö–ª–∏ –¥–ª—è iPad)','Xiaomi (–ß–æ—Ö–ª–∏ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤ Xiaomi)','Samsung (–ß–æ—Ö–ª–∏ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤ Samsung)',
    '–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ —ñ –ø–ª—ñ–≤–∫–∞ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤','Apple (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è iPad)','Xiaomi (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤ Xiaomi)','Samsung (–ó–∞—Ö–∏—Å–Ω–µ —Å–∫–ª–æ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤ Samsung)',
    '–ó–∞—Ö–∏—Å–Ω–∞ –ø–ª—ñ–≤–∫–∞ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç—ñ–≤',
    '–ü–∞–≤–µ—Ä–±–∞–Ω–∫–∏ —Ç–∞ –±–∞—Ç–∞—Ä–µ–π–∫–∏','–ü–∞–≤–µ—Ä–±–∞–Ω–∫–∏','–ë–∞—Ç–∞—Ä–µ–π–∫–∏',
    '–ö–≤–∞–¥—Ä–æ–∫–æ–ø—Ç–µ—Ä–∏','DJI (–ö–≤–∞–¥—Ä–æ–∫–æ–ø—Ç–µ—Ä–∏ DJI)','–ê–∫—Å–µ—Å—É–∞—Ä–∏ –¥–æ –∫–≤–∞–¥—Ä–æ–∫–æ–ø—Ç–µ—Ä—ñ–≤',
    '–ù–∞–∫–æ–ø–∏—á—É–≤–∞—á—ñ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó','–§–ª–µ—à–∫–∏','–ö–∞—Ä—Ç–∫–∏ –ø–∞–º º—è—Ç—ñ MicroSD',
    '–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ —Ç–∞ –∫–æ–º–ø º—é—Ç–µ—Ä–Ω—ñ –º–∏—à—ñ','–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∏','Logitech (–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ Logitech)','–ö–æ–º–ø º—é—Ç–µ—Ä–Ω—ñ –º–∏—à—ñ','Logitech (–ö–æ–º–ø º—é—Ç–µ—Ä–Ω—ñ –º–∏—à—ñ Logitech)',
    '–ö–∞–±–µ–ª—ñ —Ç–∞ –ø–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏','–ö–∞–±–µ–ª—ñ','Apple (–ö–∞–±–µ–ª—ñ Apple)','Acefast (–ö–∞–±–µ–ª—ñ Acefast)','Baseus (–ö–∞–±–µ–ª—ñ Baseus)',
    '–ü–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏','Apple (–ü–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏ Apple)','Acefast (–ü–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏ Acefast)','Baseus (–ü–µ—Ä–µ—Ö—ñ–¥–Ω–∏–∫–∏ Baseus)',
    '–ó–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó','–ë–µ–∑–¥—Ä–æ—Ç–æ–≤—ñ –∑–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó','Apple (–ë–µ–∑–¥—Ä–æ—Ç–æ–≤—ñ –ó–ü Apple)','Acefast (–ë–µ–∑–¥—Ä–æ—Ç–æ–≤—ñ –ó–ü Acefast)','Baseus (–ë–µ–∑–¥—Ä–æ—Ç–æ–≤—ñ –ó–ü Baseus)',
    '–ú–µ—Ä–µ–∂–µ–≤—ñ –∑–∞—Ä—è–¥–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó','Apple (–ú–µ—Ä–µ–∂–µ–≤—ñ –ó–ü Apple)','Acefast (–ú–µ—Ä–µ–∂–µ–≤—ñ –ó–ü Acefast)','Baseus (–ú–µ—Ä–µ–∂–µ–≤—ñ –ó–ü Baseus)',
    '–ì–∞–¥–∂–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º','–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º','Apple (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º iPhone)','Xiaomi (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Xiaomi)','Samsung (–°–º–∞—Ä—Ç—Ñ–æ–Ω–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Samsung)',
    '–ü–ª–∞–Ω—à–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º','Apple (–ü–ª–∞–Ω—à–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º iPad)','Xiaomi (–ø–ª–∞–Ω—à–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Xiaomi)','Samsung (–ø–ª–∞–Ω—à–µ—Ç–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Samsung)',
    '–ù–æ—É—Ç–±—É–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º','Apple (–ù–æ—É—Ç–±—É–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º MacBook)','–ü–ö –∑ –ø—Ä–æ–±—ñ–≥–æ–º','Apple (–ü–ö –∑ –ø—Ä–æ–±—ñ–≥–æ–º iMac)',
    '–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º','Apple (–°–º–∞—Ä—Ç-–≥–æ–¥–∏–Ω–Ω–∏–∫–∏ –∑ –ø—Ä–æ–±—ñ–≥–æ–º Apple Watch)',
    '–Ü–Ω—à—ñ –≥–∞–¥–∂–µ—Ç–∏','–ü–æ–¥–∞—Ä—É–Ω–∫–æ–≤—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏','–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ —Ç–∞ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è','–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏',
    '–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏','Apple (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Apple)','Xiaomi (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Xiaomi)','Samsung (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Samsung)','Huawei (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Huawei)','Google (–ê–∫—É–º—É–ª—è—Ç–æ—Ä–∏ Google)','–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω—ñ –∞–∫—É–º—É–ª—è—Ç–æ—Ä–∏',
    '–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è','Apple (–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è Apple)','Xiaomi (–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è Xiaomi)','Samsung (–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è Samsung)','Huawei (–î–∏—Å–ø–ª–µ—ó —Ç–∞ —Å–∫–ª–æ –¥–∏—Å–ø–ª–µ—è Huawei)',
    '–î–∏–Ω–∞–º—ñ–∫–∏','Apple (–î–∏–Ω–∞–º—ñ–∫–∏ Apple)','–ó–∞–¥–Ω—ñ –∫—Ä–∏—à–∫–∏','Apple (–ó–∞–¥–Ω—ñ –∫—Ä–∏—à–∫–∏ Apple)','–ö–º–µ—Ä–∏ —Ç–∞ —Å–∫–ª–æ –∫–∞–º–µ—Ä–∏','Apple (–ö–º–µ—Ä–∏ —Ç–∞ —Å–∫–ª–æ –∫–∞–º–µ—Ä–∏ Apple)',
    '–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏','Apple (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏ Apple)','Xiaomi (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏ Xiaomi)','Samsung (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏ Samsung)','Huawei (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω–∏ Huawei)','–®–ª–µ–π—Ñ–∏','Apple (–®–ª–µ–π—Ñ–∏ Apple)',
    '–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏ –¥–ª—è —ñ–≥—Ä–æ–≤–∏—Ö –∫–æ–Ω—Å–æ–ª–µ–π','–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏ –¥–ª—è Sony PlayStation'
  ],

  // –°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–∫–∞ –ù–ï —Å–æ–±–∏—Ä–∞–µ–º
  SKIP_SUPPLIERS: ['china'],

  // –õ–∏—Å—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞–π–¥—ë–º —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–∑ —ç—Ç–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
  REQUIRE_MIN_HEADERS: 1
};

/* ===== –ú–µ–Ω—é ‚Äî –ñ–ï–õ–ï–ó–ù–û–ï (—á–µ—Ä–µ–∑ installable onOpen) ===== */

function _MAP_addMenu_() {
  SpreadsheetApp.getUi()
    .createMenu('–ú–∞–ø–ø–∏–Ω–≥')
    .addItem('–°–æ–±—Ä–∞—Ç—å —Å–µ–π—á–∞—Å', 'MAP_buildNow')
    .addSeparator()
    .addItem('–í–∫–ª—é—á–∏—Ç—å –µ–∂–µ—á–∞—Å–Ω—ã–π –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫', 'MAP_createHourlyTrigger')
    .addItem('–û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫', 'MAP_removeTriggers')
    .addToUi();
}

// –≠—Ç–æ—Ç onOpen –≤ —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º –æ—Ç –¥—Ä—É–≥–∏—Ö onOpen –≤ –ø—Ä–æ–µ–∫—Ç–µ
function onOpen_forced_MAP_(e) {
  try {
    _MAP_addMenu_();
  } catch (err) {
    Logger.log('onOpen_forced_MAP_ error: ' + err);
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ—à—å –û–î–ò–ù –†–ê–ó –≤—Ä—É—á–Ω—É—é, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä
function MAP_installMenuTrigger() {
  const ss = SpreadsheetApp.getActive();
  const ssId = ss.getId();

  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(tr => {
    const fn = tr.getHandlerFunction();
    if (fn === 'onOpen_forced_MAP_') {
      ScriptApp.deleteTrigger(tr);
    }
  });

  ScriptApp.newTrigger('onOpen_forced_MAP_')
    .forSpreadsheet(ssId)
    .onOpen()
    .create();

  try {
    ss.toast('–ú–µ–Ω—é "–ú–∞–ø–ø–∏–Ω–≥" –ø—Ä–∏–≤—è–∑–∞–Ω–æ —á–µ—Ä–µ–∑ onOpen-—Ç—Ä–∏–≥–≥–µ—Ä','–ú–∞–ø–ø–∏–Ω–≥',5);
  } catch (e) {}
}

/* ===== –û—Å–Ω–æ–≤–Ω–æ–π —Å–±–æ—Ä—â–∏–∫ ===== */
function MAP_buildNow() {
  const ss = SpreadsheetApp.getActive();
  const sheets = ss.getSheets();

  const allow = _buildAllowedNameSet_(MAP_CFG.CATEGORY_SHEETS_CANONICAL);
  const out = [];
  const buildTs = (MAP_CFG.ADD_TIMESTAMP ? _nowStr_(MAP_CFG.TIMESTAMP_TZ) : '');

  for (const sh of sheets) {
    const name = sh.getName();
    if (_isExcluded_(name)) continue;
    if (!_isAllowedCategory_(name, allow)) continue;

    const rng = sh.getDataRange();
    const lr = rng.getLastRow(), lc = rng.getLastColumn();
    if (lr < 2 || lc < 1) continue;

    const hdr = sh.getRange(1,1,1,lc).getDisplayValues()[0].map(s => String(s||'').trim());
    const idx = _mapHeaderIndexes_(hdr, MAP_CFG.HDRS);

    // –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ª–∏—Å—Ç, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –º–∏–Ω–∏–º—É–º —Ç—Ä–µ–±—É–µ–º—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    const foundCount = Object.values(idx).filter(i => i >= 0).length;
    if (foundCount < (MAP_CFG.REQUIRE_MIN_HEADERS||1)) continue;

    const vals = sh.getRange(2,1,lr-1,lc).getDisplayValues();

    // RichText –¥–ª—è —Å—Å—ã–ª–∫–∏
    let rich = null;
    if (idx.link >= 0) {
      try { rich = sh.getRange(2, idx.link+1, lr-1, 1).getRichTextValues(); } catch(e) { rich = null; }
    }

    for (let r=0; r<vals.length; r++) {
      const row = vals[r];

      const rawCode = _clean(_pick(row, idx.code));
      const article = _clean(_pick(row, idx.article));
      const model = _clean(_pick(row, idx.model));
      const id = _clean(_pick(row, idx.id));
      let supplier = _clean(_pick(row, idx.supplier));
      let link = _clean(_pick(row, idx.link));

      // –µ—Å–ª–∏ —è—á–µ–π–∫–∞ ‚Äî –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç, –≤–æ–∑—å–º—ë–º URL
      if (idx.link >= 0 && rich && rich[r] && rich[r][0]) {
        const rt = rich[r][0];
        const url = (rt.getLinkUrl && rt.getLinkUrl()) || '';
        if (url) link = _clean(url);
      }

      // –ö–æ–¥:
      //  - –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ —è–≤–Ω—ã–π "–ö–æ–¥" (sitecode –∏ —Ç.–ø.)
      //  - –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å –ê—Ä—Ç–∏–∫—É–ª ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞—Ä—Ç–∏–∫—É–ª –∫–∞–∫ –∫–æ–¥ (—Ñ–æ–ª–ª–±–µ–∫, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å —Å—Ç—Ä–æ–∫–∏)
      let code = rawCode;
      if (_isBlank(code) && !_isBlank(article)) {
        code = article;
      }

      // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –≥–¥–µ –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è –ø—É—Å—Ç—ã–µ/—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ
      const nonEmpty = [code, article, model, id, supplier, link].filter(v => !_isBlank(v)).length;
      if (nonEmpty === 0) continue;

      // skip –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –∏–∑ —Å—Ç–æ–ø-–ª–∏—Å—Ç–∞ (China –∏ —Ç.–ø.)
      if (!_isBlank(supplier) && _shouldSkipSupplier_(supplier)) continue;

      if (MAP_CFG.ADD_TIMESTAMP) {
        out.push([code, article, model, id, supplier, link, name, (r+2).toString(), buildTs]);
      } else {
        out.push([code, article, model, id, supplier, link, name, (r+2).toString()]);
      }
    }
  }

  const rows = _dedupeRows_(out, MAP_CFG.DEDUPE_MODE);
  // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ –ü–æ—Å—Ç–∞–≤—â–∏–∫—É, –∑–∞—Ç–µ–º –ø–æ –ö–æ–¥—É / ID
  rows.sort((a,b)=>_cmp(a[4],b[4])||_cmp(a[0],b[0])||_cmp(a[3],b[3]));
  _writeMapping_(SpreadsheetApp.getActive(), rows, MAP_CFG.ADD_TIMESTAMP);
}

/* ===== –¢—Ä–∏–≥–≥–µ—Ä—ã ===== */
function MAP_createHourlyTrigger() {
  MAP_removeTriggers();
  ScriptApp.newTrigger('MAP_buildNow').timeBased().everyHours(1).create();
  try { SpreadsheetApp.getActive().toast('–¢—Ä–∏–≥–≥–µ—Ä –≤–∫–ª—é—á—ë–Ω: –∫–∞–∂–¥—ã–π —á–∞—Å'); } catch(e){}
}
function MAP_removeTriggers() {
  ScriptApp.getProjectTriggers().forEach(t => {
    if (t.getHandlerFunction() === 'MAP_buildNow') ScriptApp.deleteTrigger(t);
  });
}

/* ===== Helpers ===== */

function _isExcluded_(name) {
  return MAP_CFG.EXCLUDE_SHEETS.some(x => x.toLowerCase() === String(name).toLowerCase());
}

function _normalizeName_(s) {
  return String(s||'')
    .toLowerCase()
    .replace(/\u00A0/g,' ')         // nbsp ‚Üí space
    .replace(/\s+/g,' ')
    .trim()
    .replace(/[\s\-‚Äì‚Äî_/\\.,:;'"`]+/g,'') // —É–±–∏—Ä–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
    .replace(/[()]/g,'')
    .replace(/—ë/g,'–µ');
}
function _truncateExcel31_(s){ s=String(s||''); return (s.length>31)?s.slice(0,31):s; }

function _buildAllowedNameSet_(list) {
  const set = new Set();
  for (const full of list) {
    const nFull = _normalizeName_(full);
    const nTrunc = _normalizeName_(_truncateExcel31_(full));
    set.add(nFull);
    set.add(nTrunc);
  }
  return set;
}

function _isAllowedCategory_(sheetName, allowSet) {
  const n = _normalizeName_(sheetName);
  if (allowSet.has(n)) return true;
  for (const key of allowSet) {
    if (n.startsWith(key) || key.startsWith(n)) return true;
  }
  return false;
}

function _mapHeaderIndexes_(hdr, dict) {
  function findOne(syns) {
    for (let c=0;c<hdr.length;c++) {
      const h = hdr[c].toLowerCase().replace(/\s+/g,' ').trim();
      for (const s of syns) if (h === s.toLowerCase()) return c;
    }
    return -1;
  }
  return {
    code:     findOne(dict.code),
    article:  findOne(dict.article),
    model:    findOne(dict.model),
    id:       findOne(dict.id),
    supplier: findOne(dict.supplier),
    link:     findOne(dict.link)
  };
}

function _pick(row, idx){ if(idx<0) return ''; const v=row[idx]; return (v==null)?'':String(v); }
function _clean(s){ return String(s||'').replace(/\u00A0/g,' ').trim(); }
function _isBlank(s){
  const v = _clean(s).toLowerCase();
  return !v || v === '-' || v === '‚Äî' || v === '‚Äì' || v === 'n/a' || v === 'none' || v === 'null' || v === '–Ω–µ—Ç' || v === '–Ω–µ–º–∞—î';
}
function _shouldSkipSupplier_(s){
  const v = _clean(s).toLowerCase();
  return MAP_CFG.SKIP_SUPPLIERS.some(x => v === x);
}

function _cmp(a,b){ const A=String(a||'').toLowerCase(); const B=String(b||'').toLowerCase(); return A<B?-1:(A>B?1:0); }

function _dedupeRows_(rows, mode) {
  if (mode === 'by_code') {
    const seen = new Set(), out=[];
    for (const r of rows) {
      const k = r[0] || ''; // –ö–æ–¥
      const key = k ? k : JSON.stringify(r);
      if (seen.has(key)) continue;
      seen.add(key); out.push(r);
    }
    return out;
  }
  if (mode === 'by_code_id_supplier') {
    const seen = new Set(), out=[];
    for (const r of rows) {
      // –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: 0=–ö–æ–¥, 1=–ê—Ä—Ç–∏–∫—É–ª, 2=–ú–æ–¥–µ–ª—å, 3=ID, 4=–ü–æ—Å—Ç–∞–≤—â–∏–∫
      const key = [r[0], r[3], r[4]].map(x=>String(x||'')).join('¬¶');
      if (seen.has(key)) continue;
      seen.add(key); out.push(r);
    }
    return out;
  }
  return rows.slice();
}

function _writeMapping_(ss, rows, withTs) {
  const name = MAP_CFG.MAPPING_SHEET_NAME;
  let sh = ss.getSheetByName(name);
  if (!sh) sh = ss.insertSheet(name); else sh.clear();

  const hdr = withTs
    ? [['–ö–æ–¥','–ê—Ä—Ç–∏–∫—É–ª','–ú–æ–¥–µ–ª—å','ID','–ü–æ—Å—Ç–∞–≤—â–∏–∫','–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä','–õ–∏—Å—Ç','–†—è–¥','–î–∞—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è']]
    : [['–ö–æ–¥','–ê—Ä—Ç–∏–∫—É–ª','–ú–æ–¥–µ–ª—å','ID','–ü–æ—Å—Ç–∞–≤—â–∏–∫','–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä','–õ–∏—Å—Ç','–†—è–¥']];

  sh.getRange(1,1,1,hdr[0].length).setValues(hdr);
  if (rows.length) sh.getRange(2,1,rows.length,hdr[0].length).setValues(rows);

  const lr = Math.max(2, sh.getLastRow());
  const lc = hdr[0].length;
  sh.setFrozenRows(1);
  sh.getRange(1,1,lr,lc).setNumberFormat('@');
  sh.autoResizeColumns(1, lc);

  try {
    const rng = sh.getRange(1,1,lr,lc);
    if (sh.getFilter()) sh.getFilter().remove();
    rng.createFilter();
    // –ü–æ—Å—Ç–∞–≤—â–∏–∫ —Ç–µ–ø–µ—Ä—å –≤ 5-–π –∫–æ–ª–æ–Ω–∫–µ
    sh.getFilter().sort(5, true); // –ü–æ—Å—Ç–∞–≤—â–∏–∫ A‚Üí–Ø
  } catch(e) {}
}

function _nowStr_(tz) {
  return Utilities.formatDate(new Date(), tz || Session.getScriptTimeZone() || 'UTC', 'yyyy-MM-dd HH:mm:ss');
}

CategoryStats - —Å–∫—Ä–∏–ø—Ç —Ä–∞–±–æ—Ç–∞—é—â–∏–π –Ω–∞ –ª–∏—Å—Ç–µ –î–∞—à–±–æ—Ä–¥11: 
// –£–Ω—ñ–∫–∞–ª—å–Ω–∞ –Ω–∞–∑–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function autoUpdateCategoryStats() {
  var sheet = SpreadsheetApp.getActiveSheet();
  if (sheet.getName() !== '–î–∞—à–±–æ—Ä–¥11') {
    return; // –í–∏—Ö—ñ–¥, —è–∫—â–æ –Ω–µ "–î–∞—à–±–æ—Ä–¥11"
  }
  var startDate = sheet.getRange('B3').getValue();
  var endDate = sheet.getRange('D3').getValue();
  var point = sheet.getRange('B13').getValue(); // –¢–æ—á–∫–∞: –ó–∞–≥–∞–ª—å–Ω—ñ, –®–µ–≤—á–µ–Ω–∫–æ, –ê–ø–ø–æ–ª–æ, –ù–∞–≥–æ—Ä–∫–∞, –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç, –ì–æ—Ä–æ–¥–æ–∫
  var categories = sheet.getRange('J6:J73').getValues().flat().filter(String);

  // –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ–ª–æ–Ω–æ–∫ –∑–∞ —Ç–æ—á–∫–æ—é –¥–ª—è —Ç–æ–ø-–ø–æ–∑–∏—Ü—ñ–π
  var colMap = {
    '–ó–∞–≥–∞–ª—å–Ω—ñ': { qty: 1, revenue: 2, margin: 3 }, // B, C, D (—ñ–Ω–¥–µ–∫—Å–∏: 1,2,3)
    '–®–µ–≤—á–µ–Ω–∫–æ': { qty: 8, revenue: 9, margin: 10 }, // I, J, K
    '–ù–∞–≥–æ—Ä–∫–∞': { qty: 15, revenue: 16, margin: 17 }, // P, Q, R
    '–ê–ø–ø–æ–ª–æ': { qty: 22, revenue: 23, margin: 24 }, // W, X, Y
    '–ì–æ—Ä–æ–¥–æ–∫': { qty: 29, revenue: 30, margin: 31 }, // AD, AE, AF
    '–Ü–Ω—Ç–µ—Ä–Ω–µ—Ç': { qty: 36, revenue: 37, margin: 38 } // AK, AL, AM
  };
  var cols = colMap[point] || colMap['–ó–∞–≥–∞–ª—å–Ω—ñ'];

  // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
  sheet.getRange('K6:U73').clearContent(); // K-U –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
  sheet.getRange('A17:E67').clearContent(); // A17:E67 –¥–ª—è —Ç–æ–ø-–ø–æ–∑–∏—Ü—ñ–π

  // –û—Ç—Ä–∏–º–∞—Ç–∏ –ª–∏—Å—Ç–∏ –º—ñ—Å—è—Ü—ñ–≤ —É –ø–µ—Ä—ñ–æ–¥—ñ
  var summariesSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('–ü—ñ–¥—Å—É–º–∫–∏_–º—ñ—Å—è—Ü—ñ–≤');
  if (!summariesSheet) {
    Logger.log('–õ–∏—Å—Ç "–ü—ñ–¥—Å—É–º–∫–∏_–º—ñ—Å—è—Ü—ñ–≤" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
    return;
  }
  var summariesData = summariesSheet.getDataRange().getValues();
  var monthSheets = [];
  for (var i = 1; i < summariesData.length; i++) {
    var monthStart = summariesData[i][0];
    var monthEnd = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0);
    if (monthStart <= endDate && monthEnd >= startDate) {
      monthSheets.push(summariesData[i][1]);
    }
  }

  // –û—Ç—Ä–∏–º–∞—Ç–∏ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—É (–∞—Ä—Ç–∏–∫—É–ª -> –∫–∞—Ç–µ–≥–æ—Ä—ñ—è)
  var nomSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞');
  if (!nomSheet) {
    Logger.log('–õ–∏—Å—Ç "–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
    return;
  }
  var nomData = nomSheet.getDataRange().getValues();
  var articToCat = {};
  for (var i = 1; i < nomData.length; i++) {
    var artic = nomData[i][0];
    var cat = nomData[i][3];
    if (artic && cat) {
      articToCat[artic] = cat;
    }
  }

  // –û—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ –∑ "–ê–Ω–∞–ª—ñ–∑ ABC-XYZ"
  var abcXyzSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('–ê–Ω–∞–ª—ñ–∑ ABC-XYZ');
  if (!abcXyzSheet) {
    Logger.log('–õ–∏—Å—Ç "–ê–Ω–∞–ª—ñ–∑ ABC-XYZ" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
    return;
  }
  var abcXyzData = abcXyzSheet.getDataRange().getValues();
  var catToAbcXyz = {};
  var months = [
    '–°—ñ—á–µ–Ω—å 2025', '–õ—é—Ç–∏–π 2025', '–ë–µ—Ä–µ–∑–µ–Ω—å 2025', '–ö–≤—ñ—Ç–µ–Ω—å 2025', '–¢—Ä–∞–≤–µ–Ω—å 2025',
    '–ß–µ—Ä–≤–µ–Ω—å 2025', '–õ–∏–ø–µ–Ω—å 2025', '–°–µ—Ä–ø–µ–Ω—å 2025', '–í–µ—Ä–µ—Å–µ–Ω—å 2025', '–ñ–æ–≤—Ç–µ–Ω—å 2025'
  ];
  var headers = abcXyzData[0];
  var turnoverCol = headers.indexOf('–û–±–æ—Ä–æ—Ç–Ω—ñ—Å—Ç—å (–∫–æ–µ—Ñ.)'); // P
  var gmroiCol = headers.indexOf('GMROI'); // Q
  var abcVCol = headers.indexOf('ABC (–≤)'); // J
  var xyzCol = headers.indexOf('XYZ'); // M
  var abcMXYZCol = headers.indexOf('ABC(–º)-XYZ'); // N
  var historicalCols = months.map(m => headers.indexOf('–í–∏—Ç–æ—Ä–≥ ' + m)); // –ö–æ–ª–æ–Ω–∫–∏ –¥–ª—è –≤–∏—Ç–æ—Ä–≥—É –∑–∞ –º—ñ—Å—è—Ü—ñ
  for (var i = 1; i < abcXyzData.length; i++) {
    var cat = abcXyzData[i][3]; // D - –ö–∞—Ç–µ–≥–æ—Ä—ñ—è (0-index 3)
    if (cat && categories.includes(cat)) {
      if (!catToAbcXyz[cat]) {
        catToAbcXyz[cat] = {
          turnover: [],
          gmroi: [],
          abc: [],
          xyz: [],
          abcXyz: [],
          historicalRevenue: Array(10).fill(0)
        };
      }
      catToAbcXyz[cat].turnover.push(abcXyzData[i][turnoverCol] || 0);
      catToAbcXyz[cat].gmroi.push(abcXyzData[i][gmroiCol] || 0);
      catToAbcXyz[cat].abc.push(abcXyzData[i][abcVCol] || 'C');
      catToAbcXyz[cat].xyz.push(abcXyzData[i][xyzCol] || 'Z');
      catToAbcXyz[cat].abcXyz.push(abcXyzData[i][abcMXYZCol] || 'CZ');
      for (var m = 0; m < 10; m++) {
        var col = historicalCols[m];
        if (col !== -1) {
          catToAbcXyz[cat].historicalRevenue[m] += abcXyzData[i][col] || 0;
        }
      }
    }
  }

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∞–≥—Ä–µ–≥–∞—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö —Ç–∞ —Ç–æ–ø-–ø–æ–∑–∏—Ü—ñ—è—Ö
  var stats = {};
  categories.forEach(function(cat) {
    stats[cat] = { qty: 0, revenue: 0, margin: 0, items: [] };
  });
  var items = {};

  // –û–±—Ä–æ–±–∏—Ç–∏ –∫–æ–∂–µ–Ω –º—ñ—Å—è—á–Ω–∏–π –∞—Ä–∫—É—à (—Å–ø—ñ–ª—å–Ω–∏–π —Ü–∏–∫–ª –¥–ª—è –æ–±–æ—Ö)
  monthSheets.forEach(function(sheetName) {
    var monthSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
    if (!monthSheet) {
      Logger.log('–õ–∏—Å—Ç ' + sheetName + ' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
      return;
    }
    var monthData = monthSheet.getDataRange().getValues();
    for (var r = 1; r < monthData.length; r++) {
      var date = monthData[r][5]; // F - –¥–∞—Ç–∞ (index 5)
      if (date >= startDate && date <= endDate) {
        var artic = monthData[r][4] || ''; // E - –∞—Ä—Ç–∏–∫—É–ª (index 4)
        var name = monthData[r][0] || ''; // A - –Ω–∞–∑–≤–∞ (index 0)

        // –î–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π (–∑–∞–≤–∂–¥–∏ –∑–∞–≥–∞–ª—å–Ω—ñ cols: qty=1, revenue=2, margin=3)
        var catQty = monthData[r][1] || 0;
        var catRevenue = monthData[r][2] || 0;
        var catMargin = monthData[r][3] || 0;
        var cat = articToCat[artic];
        if (cat && stats[cat] && catQty > 0) {
          stats[cat].qty += catQty;
          stats[cat].revenue += catRevenue;
          stats[cat].margin += catMargin;
          stats[cat].items.push({ qty: catQty, revenue: catRevenue });
        }

        // –î–ª—è —Ç–æ–ø-–ø–æ–∑–∏—Ü—ñ–π (cols –∑–∞ —Ç–æ—á–∫–æ—é)
        var topQty = monthData[r][cols.qty] || 0;
        var topRevenue = monthData[r][cols.revenue] || 0;
        var topMargin = monthData[r][cols.margin] || 0;
        if (topQty > 0) {
          if (!items[artic]) items[artic] = { qty: 0, revenue: 0, margin: 0, name: name };
          items[artic].qty += topQty;
          items[artic].revenue += topRevenue;
          items[artic].margin += topMargin;
          items[artic].name = name; // –û–Ω–æ–≤–ª—é—î–º–æ –Ω–∞–∑–≤—É, —è–∫—â–æ —î
        }
      }
    }
  });

  // –û–±—Ä–æ–±–∫–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
  // –û—Ç—Ä–∏–º–∞—Ç–∏ –∑–∞–≥–∞–ª—å–Ω–∏–π –≤–∏—Ç–æ—Ä–≥ –¥–ª—è –Ü–Ω–¥–µ–∫—Å—É –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—ñ
  var totalRevenue = categories.reduce(function(sum, cat) {
    return sum + (stats[cat].revenue || 0);
  }, 0);
  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è
  function mode(arr) {
    if (arr.length === 0) return 'C';
    var freq = {};
    arr.forEach(v => freq[v] = (freq[v] || 0) + 1);
    return Object.keys(freq).reduce((a, b) => freq[a] > freq[b] ? a : b);
  }
  // –ó–∞–ø–∏—Å–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
  var output = [];
  categories.forEach(function(cat, index) {
    var s = stats[cat] || { qty: 0, revenue: 0, margin: 0, items: [] };
    var gm = (s.revenue !== 0) ? s.margin / s.revenue : 0;
    // ABC, XYZ, ABC-XYZ –∑ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É (–∞–ª–µ –≤ –∫–æ–¥—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∑ –ª–∏—Å—Ç–∞)
    var totalRev = s.items.reduce((sum, item) => sum + item.revenue, 0);
    var abc = 'C';
    if (totalRev >= totalRevenue * 0.80) abc = 'A';
    else if (totalRev >= totalRevenue * 0.65) abc = 'B';
    var qtyVariations = s.items.map(item => item.qty);
    var avgQty = qtyVariations.reduce((a, b) => a + b, 0) / qtyVariations.length || 0;
    var stdDev = Math.sqrt(qtyVariations.reduce((a, b) => a + Math.pow(b - avgQty, 2), 0) / qtyVariations.length) || 0;
    var cv = avgQty > 0 ? stdDev / avgQty : 0;
    var xyz = 'Z';
    if (cv < 0.2) xyz = 'X';
    else if (cv < 0.5) xyz = 'Y';
    var abcXyz = abc + xyz;
    // –ó "–ê–Ω–∞–ª—ñ–∑ ABC-XYZ"
    var abcXyzStat = catToAbcXyz[cat] || { turnover: [], gmroi: [], abc: [], xyz: [], abcXyz: [], historicalRevenue: Array(10).fill(0) };
    var turnover = abcXyzStat.turnover.reduce((a, b) => a + b, 0) / abcXyzStat.turnover.length || 0;
    var gmroi = abcXyzStat.gmroi.reduce((a, b) => a + b, 0) / abcXyzStat.gmroi.length || 0;
    var abcFromSheet = mode(abcXyzStat.abc);
    var xyzFromSheet = mode(abcXyzStat.xyz);
    var abcXyzFromSheet = mode(abcXyzStat.abcXyz);
    // –î–∏–Ω–∞–º—ñ–∫–∞ - SPARKLINE –∑ –∞–≥—Ä–µ–≥–æ–≤–∞–Ω–∏—Ö –≤–∏—Ç–æ—Ä–≥—ñ–≤ –∑–∞ 10 –º—ñ—Å—è—Ü—ñ–≤
    var sparkData = abcXyzStat.historicalRevenue;
    var sparkFormula = sparkData.some(v => v > 0) ? '=SPARKLINE({' + sparkData.join(';') + '}; {"charttype"\\"line";"linewidth"\\2;"color"\\"#1ec732"})' : '';
    // –Ü–Ω–¥–µ–∫—Å –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—ñ
    var popularity = totalRevenue > 0 ? (s.revenue / totalRevenue) * 100 : 0;
    output.push([s.qty, s.revenue, s.margin, gm, abcFromSheet, xyzFromSheet, abcXyzFromSheet, turnover, sparkFormula, gmroi, popularity]);
  });
  sheet.getRange('K6:U73').setValues(output);
  sheet.getRange('N6:N73').setNumberFormat('0.00%'); // GM%
  sheet.getRange('R6:R73').setNumberFormat('0.00%'); // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å (%)
  sheet.getRange('T6:T73').setNumberFormat('0.00'); // GMROI
  sheet.getRange('U6:U73').setNumberFormat('0.00%'); // –Ü–Ω–¥–µ–∫—Å –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—ñ
  sheet.getRange('S6:S73').setFormulas(output.map(row => [row[8]])); // –î–∏–Ω–∞–º—ñ–∫–∞ —è–∫ —Ñ–æ—Ä–º—É–ª–∞

  // –û–±—Ä–æ–±–∫–∞ –¥–ª—è —Ç–æ–ø-–ø–æ–∑–∏—Ü—ñ–π
  // –ó–∞–≥–∞–ª—å–Ω—ñ —Å—É–º–∏ –≤ C17:E17
  var totalQty = 0, totalRevenue = 0, totalMargin = 0;
  for (var artic in items) {
    totalQty += items[artic].qty;
    totalRevenue += items[artic].revenue;
    totalMargin += items[artic].margin;
  }
  sheet.getRange('C17').setValue(totalQty);
  sheet.getRange('D17').setValue(totalRevenue);
  sheet.getRange('E17').setValue(totalMargin);
  // –¢–æ–ø-50 –∑–∞ –º–∞—Ä–∂–µ—é
  var sortedItems = Object.keys(items).map(artic => ({
    artic: artic,
    name: items[artic].name,
    qty: items[artic].qty,
    revenue: items[artic].revenue,
    margin: items[artic].margin
  })).sort((a, b) => b.margin - a.margin).slice(0, 50);
  var outputTop = sortedItems.map(item => [item.artic, item.name, item.qty, item.revenue, item.margin]);
  if (outputTop.length > 0) {
    sheet.getRange('A18:E' + (17 + outputTop.length)).setValues(outputTop);
  }
}

// –§—É–Ω–∫—Ü—ñ—è-—Ç—Ä–∏–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫—É –ø—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—ñ
function onEdit(e) {
  if (!e || !e.source) return;
  var sheet = e.source.getActiveSheet();
  if (sheet.getName() !== '–î–∞—à–±–æ—Ä–¥11') return;
  var editedRange = e.range;
  var editedRow = editedRange.getRow();
  var editedCol = editedRange.getColumn();
  if ((editedRow === 3 && (editedCol === 2 || editedCol === 4)) || (editedRow === 13 && editedCol === 2)) {
    autoUpdateCategoryStats();
  }
}
// –£–Ω—ñ–∫–∞–ª—å–Ω–∞ –Ω–∞–∑–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function autoUpdateCategoryStats() {
  var sheet = SpreadsheetApp.getActiveSheet();
  if (sheet.getName() !== '–î–∞—à–±–æ—Ä–¥11') {
    return; // –í–∏—Ö—ñ–¥, —è–∫—â–æ –Ω–µ "–î–∞—à–±–æ—Ä–¥11"
  }
  var startDate = sheet.getRange('B3').getValue();
  var endDate = sheet.getRange('D3').getValue();
  var point = sheet.getRange('B13').getValue(); // –¢–æ—á–∫–∞: –ó–∞–≥–∞–ª—å–Ω—ñ, –®–µ–≤—á–µ–Ω–∫–æ, –ê–ø–ø–æ–ª–æ, –ù–∞–≥–æ—Ä–∫–∞, –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç, –ì–æ—Ä–æ–¥–æ–∫
  var categories = sheet.getRange('J6:J73').getValues().flat().filter(String);

  // –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ–ª–æ–Ω–æ–∫ –∑–∞ —Ç–æ—á–∫–æ—é –¥–ª—è —Ç–æ–ø-–ø–æ–∑–∏—Ü—ñ–π
  var colMap = {
    '–ó–∞–≥–∞–ª—å–Ω—ñ': { qty: 1, revenue: 2, margin: 3 }, // B, C, D (—ñ–Ω–¥–µ–∫—Å–∏: 1,2,3)
    '–®–µ–≤—á–µ–Ω–∫–æ': { qty: 8, revenue: 9, margin: 10 }, // I, J, K
    '–ù–∞–≥–æ—Ä–∫–∞': { qty: 15, revenue: 16, margin: 17 }, // P, Q, R
    '–ê–ø–ø–æ–ª–æ': { qty: 22, revenue: 23, margin: 24 }, // W, X, Y
    '–ì–æ—Ä–æ–¥–æ–∫': { qty: 29, revenue: 30, margin: 31 }, // AD, AE, AF
    '–Ü–Ω—Ç–µ—Ä–Ω–µ—Ç': { qty: 36, revenue: 37, margin: 38 } // AK, AL, AM
  };
  var cols = colMap[point] || colMap['–ó–∞–≥–∞–ª—å–Ω—ñ'];

  // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
  sheet.getRange('K6:U73').clearContent(); // K-U –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
  sheet.getRange('V6:AB73').clearContent(); // V-AB –¥–ª—è –Ω–æ–≤–∏—Ö –º–µ—Ç—Ä–∏–∫
  sheet.getRange('A17:E67').clearContent(); // A17:E67 –¥–ª—è —Ç–æ–ø-–ø–æ–∑–∏—Ü—ñ–π

  // –û–¥–Ω–æ—Ä–∞–∑–æ–≤–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ –¥–ª—è –Ω–æ–≤–∏—Ö –º–µ—Ç—Ä–∏–∫ (V5:AB5)
  var newHeaders = [
    '–ß–∞—Å—Ç–∫–∞ –≤–∏—Ç–æ—Ä–≥—É, %',
    '–ß–∞—Å—Ç–∫–∞ –º–∞—Ä–∂—ñ, %',
    'ASP (—Å–µ—Ä–µ–¥–Ω—è —Ü—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É)',
    '–ú–∞—Ä–∂–∞/–æ–¥.',
    '–ó–∞–ø–∞—Å —É —Ç–∏–∂–Ω—è—Ö (–∑–≤–∞–∂–µ–Ω–∏–π)',
    '–†–∏–∑–∏–∫ –ø–µ—Ä–µ–∑–∞—Ç–∞—Ä–∫–∏, %',
    '–°–µ–∑–æ–Ω–Ω—ñ—Å—Ç—å (—ñ–Ω–¥–µ–∫—Å)'
  ];
  var headerRow = sheet.getRange('V5:AB5').getValues()[0];
  var allEmpty = headerRow.every(function (v) { return String(v).trim() === ''; });
  if (allEmpty) {
    sheet.getRange('V5:AB5').setValues([newHeaders]);
  }

  // –û—Ç—Ä–∏–º–∞—Ç–∏ –ª–∏—Å—Ç–∏ –º—ñ—Å—è—Ü—ñ–≤ —É –ø–µ—Ä—ñ–æ–¥—ñ
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var summariesSheet = ss.getSheetByName('–ü—ñ–¥—Å—É–º–∫–∏_–º—ñ—Å—è—Ü—ñ–≤');
  if (!summariesSheet) {
    Logger.log('–õ–∏—Å—Ç "–ü—ñ–¥—Å—É–º–∫–∏_–º—ñ—Å—è—Ü—ñ–≤" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
    return;
  }
  var summariesData = summariesSheet.getDataRange().getValues();
  var monthSheets = [];
  for (var i = 1; i < summariesData.length; i++) {
    var monthStart = summariesData[i][0];
    var monthEnd = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0);
    if (monthStart <= endDate && monthEnd >= startDate) {
      monthSheets.push(summariesData[i][1]);
    }
  }

  // –û—Ç—Ä–∏–º–∞—Ç–∏ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—É (–∞—Ä—Ç–∏–∫—É–ª -> –∫–∞—Ç–µ–≥–æ—Ä—ñ—è)
  var nomSheet = ss.getSheetByName('–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞');
  if (!nomSheet) {
    Logger.log('–õ–∏—Å—Ç "–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
    return;
  }
  var nomData = nomSheet.getDataRange().getValues();
  var articToCat = {};
  for (var j = 1; j < nomData.length; j++) {
    var artic = nomData[j][0];
    var cat = nomData[j][3];
    if (artic && cat) {
      articToCat[artic] = cat;
    }
  }

  // –î–æ–ø–æ–º—ñ–∂–Ω—ñ: –ø–æ—à—É–∫ —ñ–Ω–¥–µ–∫—Å—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø–æ –∫—ñ–ª—å–∫–æ–º –º–æ–∂–ª–∏–≤–∏–º –Ω–∞–∑–≤–∞–º
  function norm(s) {
    return String(s || '').toLowerCase().replace(/\s+/g, ' ').trim();
  }
  function getHeaderIndex(headers, candidates) {
    var map = {};
    for (var h = 0; h < headers.length; h++) map[norm(headers[h])] = h;
    for (var c = 0; c < candidates.length; c++) {
      var key = norm(candidates[c]);
      if (map.hasOwnProperty(key)) return map[key];
    }
    return -1;
  }

  // –û—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ –∑ "–ê–Ω–∞–ª—ñ–∑ ABC-XYZ"
  var abcXyzSheet = ss.getSheetByName('–ê–Ω–∞–ª—ñ–∑ ABC-XYZ');
  if (!abcXyzSheet) {
    Logger.log('–õ–∏—Å—Ç "–ê–Ω–∞–ª—ñ–∑ ABC-XYZ" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
    return;
  }
  var abcXyzData = abcXyzSheet.getDataRange().getValues();
  var headers = abcXyzData[0];

  // –ö–æ–ª–æ–Ω–∫–∏ (–≥–Ω—É—á–∫–∏–π –ø–æ—à—É–∫ –Ω–∞–∑–≤)
  var turnoverCol = getHeaderIndex(headers, ['–û–±–æ—Ä–æ—Ç–Ω—ñ—Å—Ç—å (–∫–æ–µ—Ñ.)']);
  var gmroiCol    = getHeaderIndex(headers, ['GMROI']);
  var abcVCol     = getHeaderIndex(headers, ['ABC (–≤)']);
  var xyzCol      = getHeaderIndex(headers, ['XYZ']);
  var abcMXYZCol  = getHeaderIndex(headers, ['ABC(–º)-XYZ']);

  var wosCol      = getHeaderIndex(headers, ['–ó–∞–ø–∞—Å —É —Ç–∏–∂–Ω—è—Ö –∑–∞ 12–º','–ó–∞–ø–∞—Å —É —Ç–∏–∂–Ω—è—Ö (12–º)','–ó–∞–ø–∞—Å —É —Ç–∏–∂–Ω—è—Ö']);
  var invCostCol  = getHeaderIndex(headers, ['–í–∞—Ä—Ç—ñ—Å—Ç—å –ó–∞–ø–∞—Å—É','–í–∞—Ä—Ç—ñ—Å—Ç—å –∑–∞–ø–∞—Å—É','–í–∞—Ä—Ç—ñ—Å—Ç—å —Å–∫–ª–∞–¥—É','–í–∞—Ä—Ç—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä–Ω–æ–≥–æ –∑–∞–ø–∞—Å—É']);
  var seasonCol   = getHeaderIndex(headers, ['–ö–æ–µ—Ñ. —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—ñ','–ö–æ—ç—Ñ. —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏','–°–µ–∑–æ–Ω–Ω—ñ—Å—Ç—å (—ñ–Ω–¥–µ–∫—Å)','–Ü–Ω–¥–µ–∫—Å —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—ñ']);

  var months = [
    '–°—ñ—á–µ–Ω—å 2025', '–õ—é—Ç–∏–π 2025', '–ë–µ—Ä–µ–∑–µ–Ω—å 2025', '–ö–≤—ñ—Ç–µ–Ω—å 2025', '–¢—Ä–∞–≤–µ–Ω—å 2025',
    '–ß–µ—Ä–≤–µ–Ω—å 2025', '–õ–∏–ø–µ–Ω—å 2025', '–°–µ—Ä–ø–µ–Ω—å 2025', '–í–µ—Ä–µ—Å–µ–Ω—å 2025', '–ñ–æ–≤—Ç–µ–Ω—å 2025'
  ];
  var historicalCols = months.map(function(m){ return headers.indexOf('–í–∏—Ç–æ—Ä–≥ ' + m); });

  var catToAbcXyz = {};
  for (var r = 1; r < abcXyzData.length; r++) {
    var catRow = abcXyzData[r][3]; // D - –ö–∞—Ç–µ–≥–æ—Ä—ñ—è
    if (catRow && categories.includes(catRow)) {
      if (!catToAbcXyz[catRow]) {
        catToAbcXyz[catRow] = {
          turnover: [],
          gmroi: [],
          abc: [],
          xyz: [],
          abcXyz: [],
          historicalRevenue: Array(10).fill(0),
          invWeeks: [],
          invCost: [],
          seasonality: []
        };
      }
      if (turnoverCol !== -1) catToAbcXyz[catRow].turnover.push(abcXyzData[r][turnoverCol] || 0);
      if (gmroiCol    !== -1) catToAbcXyz[catRow].gmroi.push(abcXyzData[r][gmroiCol] || 0);
      if (abcVCol     !== -1) catToAbcXyz[catRow].abc.push(abcXyzData[r][abcVCol] || 'C');
      if (xyzCol      !== -1) catToAbcXyz[catRow].xyz.push(abcXyzData[r][xyzCol] || 'Z');
      if (abcMXYZCol  !== -1) catToAbcXyz[catRow].abcXyz.push(abcXyzData[r][abcMXYZCol] || 'CZ');

      for (var m = 0; m < 10; m++) {
        var col = historicalCols[m];
        if (col !== -1) {
          catToAbcXyz[catRow].historicalRevenue[m] += abcXyzData[r][col] || 0;
        }
      }
      if (wosCol     !== -1) catToAbcXyz[catRow].invWeeks.push(abcXyzData[r][wosCol] || 0);
      if (invCostCol !== -1) catToAbcXyz[catRow].invCost.push(abcXyzData[r][invCostCol] || 0);
      if (seasonCol  !== -1) catToAbcXyz[catRow].seasonality.push(abcXyzData[r][seasonCol] || 0);
    }
  }

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∞–≥—Ä–µ–≥–∞—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö —Ç–∞ —Ç–æ–ø-–ø–æ–∑–∏—Ü—ñ—è—Ö
  var stats = {};
  categories.forEach(function(cat) {
    stats[cat] = { qty: 0, revenue: 0, margin: 0, items: [] };
  });
  var items = {};

  // –û–±—Ä–æ–±–∏—Ç–∏ –∫–æ–∂–µ–Ω –º—ñ—Å—è—á–Ω–∏–π –∞—Ä–∫—É—à (—Å–ø—ñ–ª—å–Ω–∏–π —Ü–∏–∫–ª –¥–ª—è –æ–±–æ—Ö)
  monthSheets.forEach(function(sheetName) {
    var monthSheet = ss.getSheetByName(sheetName);
    if (!monthSheet) {
      Logger.log('–õ–∏—Å—Ç ' + sheetName + ' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
      return;
    }
    var monthData = monthSheet.getDataRange().getValues();
    for (var r2 = 1; r2 < monthData.length; r2++) {
      var date = monthData[r2][5]; // F - –¥–∞—Ç–∞ (index 5)
      if (date >= startDate && date <= endDate) {
        var artic = monthData[r2][4] || ''; // E - –∞—Ä—Ç–∏–∫—É–ª (index 4)
        var name = monthData[r2][0] || ''; // A - –Ω–∞–∑–≤–∞ (index 0)

        // –î–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π (–∑–∞–≤–∂–¥–∏ –∑–∞–≥–∞–ª—å–Ω—ñ cols: qty=1, revenue=2, margin=3)
        var catQty = monthData[r2][1] || 0;
        var catRevenue = monthData[r2][2] || 0;
        var catMargin = monthData[r2][3] || 0;
        var cat = articToCat[artic];
        if (cat && stats[cat] && catQty > 0) {
          stats[cat].qty += catQty;
          stats[cat].revenue += catRevenue;
          stats[cat].margin += catMargin;
          stats[cat].items.push({ qty: catQty, revenue: catRevenue });
        }

        // –î–ª—è —Ç–æ–ø-–ø–æ–∑–∏—Ü—ñ–π (cols –∑–∞ —Ç–æ—á–∫–æ—é)
        var topQty = monthData[r2][cols.qty] || 0;
        var topRevenue = monthData[r2][cols.revenue] || 0;
        var topMargin = monthData[r2][cols.margin] || 0;
        if (topQty > 0) {
          if (!items[artic]) items[artic] = { qty: 0, revenue: 0, margin: 0, name: name };
          items[artic].qty += topQty;
          items[artic].revenue += topRevenue;
          items[artic].margin += topMargin;
          items[artic].name = name; // –û–Ω–æ–≤–ª—é—î–º–æ –Ω–∞–∑–≤—É, —è–∫—â–æ —î
        }
      }
    }
  });

  // --- –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞–≥—Ä–µ–≥–∞—Ç—ñ–≤ –¥–ª—è —á–∞—Å—Ç–æ–∫ ---
  var totalRevenue = categories.reduce(function(sum, cat) {
    return sum + (stats[cat].revenue || 0);
  }, 0);
  var totalMarginAll = categories.reduce(function(sum, cat) {
    return sum + (stats[cat].margin || 0);
  }, 0);

  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è
  function mode(arr) {
    if (!arr || arr.length === 0) return 'C';
    var freq = {};
    arr.forEach(function(v){ freq[v] = (freq[v] || 0) + 1; });
    var best = null, bestCnt = -1;
    Object.keys(freq).forEach(function(k){
      if (freq[k] > bestCnt) { best = k; bestCnt = freq[k]; }
    });
    return best || 'C';
  }

  // –ó–∞–ø–∏—Å–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π (K:U —è–∫ –±—É–ª–æ)
  var output = [];
  // –î–æ–¥–∞—Ç–∫–æ–≤—ñ 7 –∫–æ–ª–æ–Ω–æ–∫ (V:AB)
  var outputExt = [];

  categories.forEach(function(cat) {
    var s = stats[cat] || { qty: 0, revenue: 0, margin: 0, items: [] };
    var gm = (s.revenue !== 0) ? s.margin / s.revenue : 0;

    // ABC/XYZ —Å–∞–º–æ–ø–∏—Å–Ω—ñ (–∑–∞–ª–∏—à–∞—î–º–æ —è–∫ —î –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ—ó –ª–æ–≥—ñ–∫–∏)
    var totalRevByItems = s.items.reduce(function(sum, item){ return sum + item.revenue; }, 0);
    var abc = 'C';
    if (totalRevByItems >= totalRevenue * 0.80) abc = 'A';
    else if (totalRevByItems >= totalRevenue * 0.65) abc = 'B';
    var qtyVariations = s.items.map(function(item){ return item.qty; });
    var avgQty = qtyVariations.length ? (qtyVariations.reduce(function(a,b){return a+b;},0) / qtyVariations.length) : 0;
    var stdDev = qtyVariations.length ? Math.sqrt(qtyVariations.reduce(function(a,b){ return a + Math.pow(b - avgQty, 2); }, 0) / qtyVariations.length) : 0;
    var cv = avgQty > 0 ? stdDev / avgQty : 0;
    var xyz = 'Z';
    if (cv < 0.2) xyz = 'X';
    else if (cv < 0.5) xyz = 'Y';
    var abcXyz = abc + xyz;

    // –ó "–ê–Ω–∞–ª—ñ–∑ ABC-XYZ"
    var abcXyzStat = catToAbcXyz[cat] || {
      turnover: [], gmroi: [], abc: [], xyz: [], abcXyz: [],
      historicalRevenue: Array(10).fill(0),
      invWeeks: [], invCost: [], seasonality: []
    };
    var turnover = abcXyzStat.turnover.length ? (abcXyzStat.turnover.reduce(function(a,b){return a+b;},0) / abcXyzStat.turnover.length) : 0;
    var gmroi = abcXyzStat.gmroi.length ? (abcXyzStat.gmroi.reduce(function(a,b){return a+b;},0) / abcXyzStat.gmroi.length) : 0;
    var abcFromSheet = mode(abcXyzStat.abc);
    var xyzFromSheet = mode(abcXyzStat.xyz);
    var abcXyzFromSheet = mode(abcXyzStat.abcXyz);

    // –î–∏–Ω–∞–º—ñ–∫–∞ - SPARKLINE –∑ –∞–≥—Ä–µ–≥–æ–≤–∞–Ω–∏—Ö –≤–∏—Ç–æ—Ä–≥—ñ–≤ –∑–∞ 10 –º—ñ—Å—è—Ü—ñ–≤
    var sparkData = abcXyzStat.historicalRevenue;
    var sparkFormula = sparkData.some(function(v){ return v > 0; })
      ? '=SPARKLINE({' + sparkData.join(';') + '}; {"charttype"\\\"line";"linewidth"\\2;"color"\\\"#1ec732"})'
      : '';

    // –Ü–Ω–¥–µ–∫—Å –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—ñ (—á–∞—Å—Ç–∫–∞ –≤–∏—Ç–æ—Ä–≥—É –≤ %, –∞–ª–µ –æ–∫—Ä–µ–º–æ –≤ U ‚Äî —è–∫ —É —Ç–µ–±–µ)
    var popularity = totalRevenue > 0 ? (s.revenue / totalRevenue) * 100 : 0;

    // --- –ù–æ–≤—ñ 7 –º–µ—Ç—Ä–∏–∫ ---
    var revenueSharePct = totalRevenue > 0 ? (s.revenue / totalRevenue) : 0; // –¥–æ–ª—è (0..1)
    var marginSharePct  = totalMarginAll > 0 ? (s.margin / totalMarginAll)   : 0; // –¥–æ–ª—è (0..1)
    var asp             = s.qty > 0 ? (s.revenue / s.qty) : 0;
    var marginPerUnit   = s.qty > 0 ? (s.margin  / s.qty) : 0;

    var invWeeksArr = abcXyzStat.invWeeks || [];
    var invCostArr  = abcXyzStat.invCost  || [];
    var wCostSum = 0, wWeeksSum = 0, wOverstockCost = 0;
    for (var ii = 0; ii < invWeeksArr.length; ii++) {
      var wks = Number(invWeeksArr[ii]) || 0;
      var cst = Number(invCostArr[ii])  || 0;
      if (cst > 0) {
        wCostSum += cst;
        wWeeksSum += wks * cst;
        if (wks > 12) wOverstockCost += cst;
      }
    }
    var weightedWeeks = wCostSum > 0 ? (wWeeksSum / wCostSum) : 0;
    var overstockRiskPct = wCostSum > 0 ? (wOverstockCost / wCostSum) : 0; // –¥–æ–ª—è (0..1)

    var seasonArr = abcXyzStat.seasonality || [];
    var wSeasonSum = 0, wSeasonWeight = 0;
    for (var si = 0; si < seasonArr.length; si++) {
      var sIdx = Number(seasonArr[si]) || 0;
      var w    = Number(invCostArr[si]) || 0; // –≤–∞–≥–∞ ‚Äî –≤–∞—Ä—Ç—ñ—Å—Ç—å –∑–∞–ø–∞—Å—É
      if (w > 0) { wSeasonSum += sIdx * w; wSeasonWeight += w; }
    }
    var seasonIndex = wSeasonWeight > 0 ? (wSeasonSum / wSeasonWeight) : 0;

    // –û—Å–Ω–æ–≤–Ω–∏–π –±–ª–æ–∫ K:U (—è–∫ –±—É–ª–æ)
    output.push([
      s.qty,                 // K
      s.revenue,             // L
      s.margin,              // M
      gm,                    // N (GM%)
      abcFromSheet,          // O
      xyzFromSheet,          // P
      abcXyzFromSheet,       // Q
      turnover,              // R
      sparkFormula,          // S (—Ñ–æ—Ä–º—É–ª–∞)
      gmroi,                 // T
      popularity             // U (%)
    ]);

    // –î–æ–¥–∞—Ç–∫–æ–≤–∏–π –±–ª–æ–∫ V:AB
    outputExt.push([
      revenueSharePct,  // V (—á–∞—Å—Ç–∫–∞ –≤–∏—Ç–æ—Ä–≥—É, % —Ñ–æ—Ä–º–∞—Ç—É—î–º–æ)
      marginSharePct,   // W (—á–∞—Å—Ç–∫–∞ –º–∞—Ä–∂—ñ, % —Ñ–æ—Ä–º–∞—Ç—É—î–º–æ)
      asp,              // X
      marginPerUnit,    // Y
      weightedWeeks,    // Z
      overstockRiskPct, // AA (—Ñ–æ—Ä–º–∞—Ç—É—î–º–æ %)
      seasonIndex       // AB
    ]);
  });

  // –ó–∞–ø–∏—Å –æ—Å–Ω–æ–≤–Ω–∏—Ö –º–µ—Ç—Ä–∏–∫
  sheet.getRange('K6:U73').setValues(output);
  sheet.getRange('N6:N73').setNumberFormat('0.00%'); // GM%
  sheet.getRange('R6:R73').setNumberFormat('0.00%'); // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å (%) ‚Äî –∑–∞–ª–∏—à–∞—é —è–∫ –±—É–ª–æ —É —Ç–µ–±–µ
  sheet.getRange('T6:T73').setNumberFormat('0.00');  // GMROI
  sheet.getRange('U6:U73').setNumberFormat('0.00%'); // –Ü–Ω–¥–µ–∫—Å –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—ñ
  sheet.getRange('S6:S73').setFormulas(output.map(function(row){ return [row[8]]; })); // –î–∏–Ω–∞–º—ñ–∫–∞ —è–∫ —Ñ–æ—Ä–º—É–ª–∞

  // –ó–∞–ø–∏—Å –Ω–æ–≤–∏—Ö 7 –º–µ—Ç—Ä–∏–∫
  sheet.getRange('V6:AB73').setValues(outputExt);
  sheet.getRange('V6:W73').setNumberFormat('0.00%'); // –ß–∞—Å—Ç–∫–∏
  sheet.getRange('X6:Y73').setNumberFormat('0.00');  // ASP, –ú–∞—Ä–∂–∞/–æ–¥.
  sheet.getRange('Z6:Z73').setNumberFormat('0.00');  // –ó–∞–ø–∞—Å —É —Ç–∏–∂–Ω—è—Ö (–∑–≤–∞–∂.)
  sheet.getRange('AA6:AA73').setNumberFormat('0.00%'); // –†–∏–∑–∏–∫ –ø–µ—Ä–µ–∑–∞—Ç–∞—Ä–∫–∏
  sheet.getRange('AB6:AB73').setNumberFormat('0.00'); // –°–µ–∑–æ–Ω–Ω—ñ—Å—Ç—å (—ñ–Ω–¥–µ–∫—Å)

  // –û–±—Ä–æ–±–∫–∞ –¥–ª—è —Ç–æ–ø-–ø–æ–∑–∏—Ü—ñ–π (–±–µ–∑ –∑–º—ñ–Ω –ª–æ–≥—ñ–∫–∏)
  var totalQty = 0, totalRevenueTop = 0, totalMargin = 0;
  for (var artic in items) {
    totalQty += items[artic].qty;
    totalRevenueTop += items[artic].revenue;
    totalMargin += items[artic].margin;
  }
  sheet.getRange('C17').setValue(totalQty);
  sheet.getRange('D17').setValue(totalRevenueTop);
  sheet.getRange('E17').setValue(totalMargin);

  // –¢–æ–ø-50 –∑–∞ –º–∞—Ä–∂–µ—é
  var sortedItems = Object.keys(items).map(function(artic){
    return {
      artic: artic,
      name: items[artic].name,
      qty: items[artic].qty,
      revenue: items[artic].revenue,
      margin: items[artic].margin
    };
  }).sort(function(a,b){ return b.margin - a.margin; }).slice(0, 50);

  var outputTop = sortedItems.map(function(item){
    return [item.artic, item.name, item.qty, item.revenue, item.margin];
  });
  if (outputTop.length > 0) {
    sheet.getRange('A18:E' + (17 + outputTop.length)).setValues(outputTop);
  }
}

// –§—É–Ω–∫—Ü—ñ—è-—Ç—Ä–∏–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫—É –ø—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—ñ
function onEdit(e) {
  if (!e || !e.source) return;
  var sheet = e.source.getActiveSheet();
  if (sheet.getName() !== '–î–∞—à–±–æ—Ä–¥11') return;
  var editedRange = e.range;
  var editedRow = editedRange.getRow();
  var editedCol = editedRange.getColumn();
  if ((editedRow === 3 && (editedCol === 2 || editedCol === 4)) || (editedRow === 13 && editedCol === 2)) {
    autoUpdateCategoryStats();
  }
}

proove sales - —Å–∫—Ä–∏–ø—Ç –ø–æ–º–æ–≥–∞—é—â–∏–π —Å–æ—Å—Ç–∞–≤–∏—Ç—å –≤ –Ω—É–∂–Ω–æ–º –≤–∏–¥–µ –∏ —Ñ–æ—Ä–º–∞—Ç–µ –æ—Ç—á–µ—Ç –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ Proove –ø–æ –ø—Ä–æ–¥–∞–∂–µ –∏—Ö –ø—Ä–æ–¥—É–∫—Ü–∏–∏ 
/*************************************************
 * Proove Reports ‚Äî Last 3 & Last 6 (exclude current month) v4.1
 * FIX: no huge clearContent (no lastColumn); safe clear + continue on timeout.
 *************************************************/

const PROOVE_BRAND = 'proove';

// –ü–∏—à–µ–º –º–µ–Ω—å—à–∏–º–∏ —á–∞–Ω–∫–∞–º–∏ (–±–µ—Ä–µ–∂–Ω–µ–µ –∫ —Ç—è–∂—ë–ª–æ–º—É —Ñ–∞–π–ª—É)
const PROOVE_WRITE_CHUNK_ROWS = 200;

// –£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –Ω–∞–∑–≤–∏ –º—ñ—Å—è—Ü—ñ–≤ (—è–∫ —É –≤–∫–ª–∞–¥–∫–∞—Ö)
const UA_MONTHS = [
  '–°—ñ—á–µ–Ω—å', '–õ—é—Ç–∏–π', '–ë–µ—Ä–µ–∑–µ–Ω—å', '–ö–≤—ñ—Ç–µ–Ω—å', '–¢—Ä–∞–≤–µ–Ω—å', '–ß–µ—Ä–≤–µ–Ω—å',
  '–õ–∏–ø–µ–Ω—å', '–°–µ—Ä–ø–µ–Ω—å', '–í–µ—Ä–µ—Å–µ–Ω—å', '–ñ–æ–≤—Ç–µ–Ω—å', '–õ–∏—Å—Ç–æ–ø–∞–¥', '–ì—Ä—É–¥–µ–Ω—å'
];

// –°–∫–∞–Ω –∫–æ–ª–æ–Ω–∫–∏ A –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–Ω—Ü–∞ –±–ª–æ–∫–∞ A:C
const PROOVE_MAX_SCAN_ROWS_A = 30000;
const PROOVE_SCAN_CHUNK = 1000;
const PROOVE_EMPTY_STOP = 50;

// –û—á–∏—Å—Ç–∫–∞ –æ—Ç—á—ë—Ç–Ω—ã—Ö –ª–∏—Å—Ç–æ–≤: —á–∏—Å—Ç–∏–º —Ç–æ–ª—å–∫–æ A:–¢ (20 –∫–æ–ª–æ–Ω–æ–∫) –∏ —Ç–æ–ª—å–∫–æ ‚Äú—Ä–∞–∑—É–º–Ω—ã–µ‚Äù —Å—Ç—Ä–æ–∫–∏
const PROOVE_CLEAR_COLS = 20;       // A..T
const PROOVE_CLEAR_ROW_BUFFER = 3000; // –¥–æ–±–∏—Ç—å —Ö–≤–æ—Å—Ç –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Ä—è–¥–æ–º —Å –¥–∞–Ω–Ω—ã–º–∏

// ====== –ú–ï–ù–Æ ======
function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('Proove')
    .addItem('–û–Ω–æ–≤–∏—Ç–∏ ‚Äî –æ—Å—Ç–∞–Ω–Ω—ñ 3 –º—ñ—Å (–±–µ–∑ –ø–æ—Ç–æ—á–Ω–æ–≥–æ)', 'Proove_Update_Last3')
    .addItem('–û–Ω–æ–≤–∏—Ç–∏ ‚Äî –æ—Å—Ç–∞–Ω–Ω—ñ 6 –º—ñ—Å (–±–µ–∑ –ø–æ—Ç–æ—á–Ω–æ–≥–æ)', 'Proove_Update_Last6')
    .addSeparator()
    .addItem('–û–Ω–æ–≤–∏—Ç–∏ ‚Äî 3 –º—ñ—Å + 6 –º—ñ—Å', 'Proove_Update_Last3_And_Last6')
    .addToUi();
}

// ====== –ü–£–ë–õ–Ü–ß–ù–Ü –ó–ê–ü–£–°–ö–ò ======
function Proove_Update_Last3() { Proove_Update_LastN_(3); }
function Proove_Update_Last6() { Proove_Update_LastN_(6); }
function Proove_Update_Last3_And_Last6() {
  Proove_Update_LastN_(3);
  Proove_Update_LastN_(6);
}

// ====== –û–°–ù–û–í–ù–ê –õ–û–ì–Ü–ö–ê ======
function Proove_Update_LastN_(n) {
  const ss = SpreadsheetApp.getActive();

  const available = Proove_getAvailableMonthKeys_(ss);
  const endKey = Proove_getLastClosedMonthKey_(available);
  if (endKey === null) {
    throw new Error('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∂–æ–¥–Ω–æ–≥–æ –º—ñ—Å—è—á–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ –Ω–∏–∂—á–µ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –º—ñ—Å—è—Ü—è.');
  }

  const monthsAsc = Proove_makeMonthsAscByKey_(endKey, n);
  const label = Proove_labelFromMonthsAsc_(monthsAsc);

  const data = Proove_collectData_(ss, monthsAsc);

  Proove_buildMonthlyDetailSheet_(ss, data, label, n);
  Proove_buildSkuPivotSheet_(ss, data, label, n);
}

// –°–æ–±–∏—Ä–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Å—è—Ü—ã –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏–π –≤–∫–ª–∞–¥–æ–∫
function Proove_getAvailableMonthKeys_(ss) {
  const map = {}; // key -> sheetName
  ss.getSheets().forEach(sh => {
    const name = sh.getName();
    const key = Proove_parseMonthSheetNameToKey_(name);
    if (key !== null) map[key] = name;
  });
  return map;
}

// –ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫—Ä—ã—Ç—ã–π –º–µ—Å—è—Ü: max key < —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞
function Proove_getLastClosedMonthKey_(availableMap) {
  const now = new Date();
  const curKey = now.getFullYear() * 12 + now.getMonth(); // month: 0..11
  const keys = Object.keys(availableMap).map(Number).filter(k => k < curKey);
  if (!keys.length) return null;
  keys.sort((a, b) => b - a);
  return keys[0];
}

// –°–ø–∏—Å–æ–∫ –º–µ—Å—è—Ü–µ–≤ (–≤–∫–ª–∞–¥–æ–∫) –ø–æ –∫–æ–Ω–µ—á–Ω–æ–º—É –∫–ª—é—á—É –∏ –¥–ª–∏–Ω–µ n
function Proove_makeMonthsAscByKey_(endKey, n) {
  const out = [];
  const startKey = endKey - (n - 1);
  for (let k = startKey; k <= endKey; k++) out.push(Proove_keyToMonthSheetName_(k));
  return out;
}

function Proove_labelFromMonthsAsc_(monthsAsc) {
  const s = Proove_parseMonthSheetName_(monthsAsc[0]);
  const e = Proove_parseMonthSheetName_(monthsAsc[monthsAsc.length - 1]);
  return `${String(s.m).padStart(2, '0')}‚Äì${String(e.m).padStart(2, '0')}.${e.y}`;
}

// ====== –ó–ë–Ü–† –î–ê–ù–ò–• ======
function Proove_collectData_(ss, monthsAsc) {
  const monthTotals = {};
  const monthProducts = {};
  const skuMonths = {};
  const brandLower = PROOVE_BRAND.toLowerCase();

  monthsAsc.forEach(monthName => {
    const sheet = ss.getSheetByName(monthName);

    if (!sheet) {
      monthTotals[monthName] = { qty: 0, sum: 0 };
      monthProducts[monthName] = {};
      return;
    }

    const lastRowA = Proove_findLastRowInColumnA_(sheet);
    if (lastRowA < 3) {
      monthTotals[monthName] = { qty: 0, sum: 0 };
      monthProducts[monthName] = {};
      return;
    }

    const values = Proove_withRetries_(() => sheet.getRange(1, 1, lastRowA, 3).getValues());

    let totalQty = 0;
    let totalSum = 0;
    const prodMap = {};

    for (let r = 2; r < values.length; r++) {
      const [nameVal, qtyVal, sumVal] = values[r];

      if (typeof nameVal !== 'string') continue;
      const name = nameVal.trim();
      if (!name) continue;

      const lower = name.toLowerCase();
      if (lower === '–≤—Å—å–æ–≥–æ' || lower === '–≤—Å–µ–≥–æ') continue;
      if (lower.indexOf(brandLower) === -1) continue;

      const qty = normalizeNumber_(qtyVal);
      const sum = normalizeNumber_(sumVal);
      if (!qty || isNaN(qty)) continue;

      totalQty += qty;
      totalSum += (sum || 0);

      if (!prodMap[name]) prodMap[name] = { qty: 0, sum: 0 };
      prodMap[name].qty += qty;
      prodMap[name].sum += (sum || 0);

      if (!skuMonths[name]) skuMonths[name] = {};
      skuMonths[name][monthName] = (skuMonths[name][monthName] || 0) + qty;
    }

    monthTotals[monthName] = { qty: totalQty, sum: totalSum };
    monthProducts[monthName] = prodMap;
  });

  return { monthsAsc: monthsAsc.slice(), monthTotals, monthProducts, skuMonths };
}

// –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä—è–¥ —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ –∫–æ–ª–æ–Ω–∫–µ A
function Proove_findLastRowInColumnA_(sheet) {
  const maxRows = Math.min(sheet.getMaxRows(), PROOVE_MAX_SCAN_ROWS_A);
  let lastNonEmpty = 0;
  let emptyStreak = 0;

  for (let start = 1; start <= maxRows; start += PROOVE_SCAN_CHUNK) {
    const rows = Math.min(PROOVE_SCAN_CHUNK, maxRows - start + 1);
    const colA = Proove_withRetries_(() => sheet.getRange(start, 1, rows, 1).getValues());

    for (let i = 0; i < colA.length; i++) {
      const v = colA[i][0];
      const rowNum = start + i;
      const isEmpty = (v === null || v === '' || typeof v === 'undefined');

      if (!isEmpty) {
        lastNonEmpty = rowNum;
        emptyStreak = 0;
      } else if (lastNonEmpty > 0) {
        emptyStreak++;
        if (emptyStreak >= PROOVE_EMPTY_STOP) return lastNonEmpty;
      }
    }
  }
  return lastNonEmpty;
}

// ====== –ü–û–ë–£–î–û–í–ê –õ–ò–°–¢–Ü–í ======
function Proove_buildMonthlyDetailSheet_(ss, data, label, n) {
  const sheetName = `Proove ${n} –º—ñ—Å (${label})`;
  const sh = Proove_getOrCreateSheet_(ss, sheetName);

  const out = [];
  const monthsDesc = data.monthsAsc.slice().reverse();

  monthsDesc.forEach(monthName => {
    const totals = data.monthTotals[monthName];
    const prodMap = data.monthProducts[monthName] || {};
    if (!totals || totals.qty === 0) return;

    out.push([monthName, totals.qty || 0, totals.sum || 0]);

    const rows = Object.keys(prodMap).map(name => {
      const p = prodMap[name];
      return [name, p.qty || 0, p.sum || 0];
    });

    rows.sort((a, b) => (b[1] || 0) - (a[1] || 0));
    rows.forEach(r => out.push(r));
    out.push(['', '', '']);
  });

  if (out.length && out[out.length - 1].every(v => v === '')) out.pop();
  Proove_writeGrid_(sh, out);
}

function Proove_buildSkuPivotSheet_(ss, data, label, n) {
  const sheetName = `–ó–≤—ñ—Ç Proove ${n} –º—ñ—Å (${label})`;
  const sh = Proove_getOrCreateSheet_(ss, sheetName);

  const header = ['SKU'].concat(data.monthsAsc);
  const rows = [];

  const names = Object.keys(data.skuMonths || {});
  names.sort((a, b) => a.localeCompare(b));

  names.forEach(name => {
    const monthMap = data.skuMonths[name] || {};
    const row = [name];
    data.monthsAsc.forEach(monthName => row.push(monthMap[monthName] || 0));
    rows.push(row);
  });

  Proove_writeGrid_(sh, [header].concat(rows));
}

// ====== SHEET HELPERS ======
function Proove_getOrCreateSheet_(ss, name) {
  return Proove_withRetries_(() => {
    let sh = ss.getSheetByName(name);
    if (!sh) sh = ss.insertSheet(name);
    return sh; // —á–∏—Å—Ç–∏–º –≤–Ω—É—Ç—Ä–∏ writeGrid_ (—Ç–∞–º —É–∂–µ –µ—Å—Ç—å —Ä–∞–∑–º–µ—Ä—ã)
  });
}

/**
 * –ö–ª—é—á–µ–≤–æ–π —Ñ–∏–∫—Å: —á–∏—Å—Ç–∏–º —Ç–æ–ª—å–∫–æ –Ω–µ–±–æ–ª—å—à–æ–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ (A..T) –∏ —Ç–æ–ª—å–∫–æ ‚Äú—Ä–∞–∑—É–º–Ω—ã–µ‚Äù —Å—Ç—Ä–æ–∫–∏,
 * –±–µ–∑ lastColumn (–æ–Ω —É —Ç–µ–±—è –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–æ–º–Ω—ã–º).
 * –ï—Å–ª–∏ —á–∏—Å—Ç–∫–∞ –Ω–µ —É—Å–ø–µ–ª–∞ ‚Äî –ù–ï –≤–∞–ª–∏–º –æ—Ç—á—ë—Ç, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–≤–µ—Ä—Ö—É.
 */
function Proove_writeGrid_(sheet, grid) {
  if (!grid || !grid.length || !grid[0].length) return;

  const numRows = grid.length;
  const numCols = grid[0].length;

  // 1) –õ—ë–≥–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
  Proove_softClear_(sheet, numRows, Math.max(numCols, 10));

  // 2) –ó–∞–ø–∏—Å—å —á–∞–Ω–∫–∞–º–∏
  const chunk = PROOVE_WRITE_CHUNK_ROWS;

  for (let start = 0; start < numRows; start += chunk) {
    const rowsThis = Math.min(chunk, numRows - start);
    const slice = grid.slice(start, start + rowsThis);
    Proove_withRetries_(() => sheet.getRange(1 + start, 1, rowsThis, numCols).setValues(slice));

    // —á—É—Ç—å —Ä–∞–∑–≥—Ä—É–∂–∞–µ–º
    SpreadsheetApp.flush();
    Utilities.sleep(30);
  }
}

// ‚Äú–º—è–≥–∫–∞—è‚Äù –æ—á–∏—Å—Ç–∫–∞: A..T –∏ —Ç–æ–ª—å–∫–æ –¥–æ max(–Ω—É–∂–Ω–æ, —Å—Ç–∞—Ä–æ–µ —Ä—è–¥–æ–º) –Ω–æ —Å –±—É—Ñ–µ—Ä–æ–º
function Proove_softClear_(sheet, needRows, needCols) {
  const maxCols = Math.min(sheet.getMaxColumns(), Math.max(needCols, PROOVE_CLEAR_COLS));

  let lastRow = 0;
  try {
    lastRow = Proove_withRetries_(() => sheet.getLastRow());
  } catch (e) {
    lastRow = 0;
  }

  const rowsToClear = Math.max(needRows, Math.min(lastRow, needRows + PROOVE_CLEAR_ROW_BUFFER));
  if (rowsToClear <= 0 || maxCols <= 0) return;

  try {
    Proove_withRetries_(() => sheet.getRange(1, 1, rowsToClear, maxCols).clearContent(), 4);
  } catch (e) {
    // –µ—Å–ª–∏ —Å–Ω–æ–≤–∞ timeout ‚Äî –ù–ï —Ä–æ–Ω—è–µ–º –æ—Ç—á—ë—Ç
  }
}

// ====== –£–¢–ò–õ–Ü–¢–ò ======
function normalizeNumber_(val) {
  if (typeof val === 'number') return val;
  if (val === null || val === '' || typeof val === 'undefined') return 0;
  const n = Number(String(val).replace(',', '.'));
  return isNaN(n) ? 0 : n;
}

// –†–µ—Ç—Ä–∞–π –¥–ª—è "Service Spreadsheets timed out..."
function Proove_withRetries_(fn, attempts) {
  const max = attempts || 5;
  let lastErr = null;

  for (let i = 0; i < max; i++) {
    try {
      return fn();
    } catch (e) {
      lastErr = e;
      const msg = String(e && e.message ? e.message : e);

      const isTimeout =
        msg.indexOf('Service Spreadsheets timed out') !== -1 ||
        msg.indexOf('Spreadsheets timed out') !== -1 ||
        msg.indexOf('Exception: Service Spreadsheets') !== -1;

      if (!isTimeout || i === max - 1) throw e;

      const sleepMs = (800 * Math.pow(2, i)) + Math.floor(Math.random() * 250);
      Utilities.sleep(sleepMs);
    }
  }
  throw lastErr || new Error('Unknown error');
}

// –ü–∞—Ä—Å/–≥–µ–Ω–µ—Ä–∞—Ü–∏—è "–ì—Ä—É–¥–µ–Ω—å 2025" <-> –∫–ª—é—á
function Proove_parseMonthSheetNameToKey_(sheetName) {
  const p = Proove_parseMonthSheetName_(sheetName);
  if (!p) return null;
  return p.y * 12 + (p.m - 1);
}

function Proove_parseMonthSheetName_(sheetName) {
  const s = String(sheetName || '').trim();
  const m = s.match(/^(.+?)\s+(\d{4})$/);
  if (!m) return null;

  const monthName = m[1].trim();
  const year = Number(m[2]);
  const monthIndex = UA_MONTHS.indexOf(monthName);
  if (monthIndex === -1) return null;

  return { y: year, m: monthIndex + 1 };
}

function Proove_keyToMonthSheetName_(key) {
  const y = Math.floor(key / 12);
  const m0 = key % 12; // 0..11
  return `${UA_MONTHS[m0]} ${y}`;
}

–ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã, –º—ã—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏, –Ω–µ –¥–æ–¥—É–º—ã–≤–∞–π - —Å–ø—Ä–∞—à–∏–≤–∞–π, –µ—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ –∑–Ω–∞–µ—à—å